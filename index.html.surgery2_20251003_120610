<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'self'; form-action 'self'; img-src 'self' data: blob: https:; font-src 'self' https://fonts.gstatic.com; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; connect-src 'self' https://generativelanguage.googleapis.com https://cdn.jsdelivr.net;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bradaa Strategic Command v15.2 (Architect Edition)</title>
    <script defer src="https://cdn.tailwindcss.com/3.4.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
    <script defer src="/lib/ai/geminiClient.js"></script>
    <script defer src="/lib/links/marketplaces.js"></script>
    <script defer src="/lib/ui/replyDeck.js"></script>
    <script defer src="/lib/ui/replyModalDeck.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <!-- Favicons -->
    <link rel="icon" href="/icons/icon-32.png" type="image/png">
    <link rel="icon" type="image/svg+xml" href="/icons/ai-bradaa.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#010409">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Bradaa">

    <style>
        :root {
            --c-bg: #010409;
            --c-glass: rgba(13, 17, 23, 0.6);
            --c-border: rgba(48, 54, 61, 0.8);
            --c-glow: rgba(0, 240, 255, 0.7);
            --c-accent-pink: #D83F87;
            --c-accent-cyan: #00F0FF;
            --c-text-primary: #E6EDF3;
            --c-text-secondary: #A8B2CC;
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Share Tech Mono', monospace;
        }
        body { font-family: var(--font-body); background-color: var(--c-bg); color: var(--c-text-primary); }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background-image:
                radial-gradient(circle at 10% 20%, var(--c-accent-cyan), transparent 30%),
                radial-gradient(circle at 90% 80%, var(--c-accent-pink), transparent 30%),
                radial-gradient(circle at 50% 50%, #4A00E0, transparent 40%);
            background-size: 200% 200%; filter: blur(100px); opacity: 0.15; z-index: -1;
            animation: aurora 25s linear infinite;
        }
        @keyframes aurora { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .font-display { font-family: var(--font-display); text-shadow: 0 0 5px var(--c-accent-cyan), 0 0 10px var(--c-accent-cyan); }
        .card { background-color: var(--c-glass); backdrop-filter: blur(24px); border: 1px solid var(--c-border); border-radius: 0.75rem; position: relative; overflow: hidden; }
        .card::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; z-index: 0;
            background: conic-gradient(from 180deg at 50% 50%, var(--c-accent-cyan), var(--c-accent-pink), var(--c-accent-cyan));
            transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.5s ease-in-out; animation: rotate 8s linear infinite;
        }
        .card:hover::before { opacity: 0.5; }
        @keyframes rotate { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .card-content { position: relative; z-index: 1; padding: 1.5rem; }
        .nav-sticky { position: sticky; top: 0; z-index: 50; background-color: rgba(1, 4, 9, 0.7); backdrop-filter: blur(12px); border-bottom: 1px solid var(--c-border); }
        .nav-button { border-bottom: 2px solid transparent; transition: all 0.3s; }
        .nav-button:hover, .nav-button.active { color: var(--c-accent-cyan); border-bottom-color: var(--c-accent-cyan); text-shadow: 0 0 5px var(--c-accent-cyan); }
        .filter-button.active { background-color: var(--c-accent-pink); border-color: var(--c-accent-pink); color: var(--c-text-primary); }
        .tool-selector-btn { transition: all 160ms ease; border-radius: 0.6rem; border: 1px solid rgba(48,54,61,.8); background: rgba(13,17,23,.6); padding: 0.6rem 0.8rem; text-align:left; width:100%; font-weight:600; color: var(--c-text-secondary); }
        .tool-selector-btn:hover { border-color: rgba(0,240,255,.4); transform: translateX(4px); color: var(--c-text-primary); }
        .tool-selector-btn.active { background: linear-gradient(135deg, rgba(0,240,255,.2), rgba(0,240,255,.05)); border-color: rgba(0,240,255,.55); box-shadow: inset 0 0 0 1px rgba(0,240,255,.15); color: var(--c-accent-cyan); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--c-accent-cyan); }
        select, input, textarea { font-family: var(--font-body); background-color: rgba(1, 4, 9, 0.8); border: 1px solid var(--c-border); border-radius: 0.375rem; padding: 0.65rem; transition: all 160ms ease; }
        select:hover, input:hover, textarea:hover { border-color: rgba(0,240,255,.35); }
        select:focus-visible, input:focus-visible, textarea:focus-visible { outline: none; border-color: rgba(0,240,255,.65); box-shadow: 0 0 0 3px rgba(0,240,255,.22); }
        .action-button { background: linear-gradient(135deg, var(--c-accent-pink), #ff7eb3); color: white; padding: 0.7rem 1.6rem; font-weight: bold; border-radius: 0.5rem; transition: transform 180ms ease, box-shadow 180ms ease, filter 180ms ease; cursor: pointer; box-shadow: 0 6px 16px rgba(216,63,135,0.35); }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(216,63,135,0.45); filter: brightness(1.02); }
        .action-button:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(216,63,135,0.35); }
        .action-button:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,0.25), 0 10px 22px rgba(216,63,135,0.45); }
        button:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(0,240,255,0.35); }
        .nav-button { position: relative; padding-inline: 0.75rem; color: var(--c-text-secondary); transition: color 150ms ease; }
        .nav-button::after { content:''; position:absolute; left:50%; bottom:-6px; width:0; height:2px; background: linear-gradient(90deg, rgba(0,240,255,.7), rgba(216,63,135,.7)); transition: width 200ms ease, left 200ms ease; }
        .nav-button:hover, .nav-button.active { color: var(--c-accent-cyan); }
        .nav-button:hover::after, .nav-button.active::after { width:100%; left:0; }
        .filter-button, .platform-filter { transition: all 180ms ease; background: rgba(13,17,23,0.6); color: var(--c-text-secondary); }
        .filter-button:hover, .platform-filter:hover { color: var(--c-text-primary); border-color: rgba(0,240,255,.35); transform: translateY(-1px); }
        .filter-button.active, .platform-filter.active { background: linear-gradient(135deg, rgba(0,240,255,.18), rgba(0,240,255,.05)); color: var(--c-accent-cyan); border-color: rgba(0,240,255,.5); box-shadow: 0 6px 16px rgba(0,240,255,0.25); }
        .card { background-color: var(--c-glass); backdrop-filter: blur(24px); border: 1px solid var(--c-border); border-radius: 0.75rem; position: relative; overflow: hidden; transition: transform 220ms cubic-bezier(0.16, 1, 0.3, 1), box-shadow 220ms ease, border-color 220ms ease; }
        .card:hover { transform: translateY(-6px); box-shadow: 0 20px 60px rgba(0,0,0,0.45); border-color: rgba(0,240,255,0.2); }
        section { padding-top: 6rem; margin-top: -5rem; }
        .gemini-output { white-space: pre-wrap; line-height: 1.7; }
        .gemini-output h3 { font-family: var(--font-display); color: var(--c-accent-cyan); margin-top: 1rem; margin-bottom: 0.5rem;}
        .gemini-output ul { list-style-type: disc; padding-left: 1.5rem; }
        .gemini-output strong { color: var(--c-accent-pink); }

        /* ReplyDeck container (scoped; no global layout changes) */
        .reply-wrap { max-width: min(72ch, 100%); margin-inline: auto; overflow: visible; transition: max-height 200ms ease; will-change: max-height; }
        .reply-deck { position: relative; background: var(--c-glass); border: 1px solid var(--c-border); border-radius: 0.75rem; padding: clamp(12px, 3vw, 24px); }
        .reply-deck .deck-rail { display: grid; grid-auto-flow: column; grid-auto-columns: 100%; gap: 0; overflow-x: auto; overflow-y: visible; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; touch-action: pan-y; scrollbar-width: none; }
        .reply-deck .deck-rail::-webkit-scrollbar { display: none; }
        .reply-deck .deck-snap { scroll-snap-align: start; }
        .reply-deck .deck-title { font-family: var(--font-display); color: var(--c-accent-cyan); margin-bottom: 0.5rem; }
        .reply-deck .deck-dots { display: flex; justify-content: center; gap: 6px; margin-top: 10px; }
        .reply-deck .deck-dot { width: 8px; height: 8px; border-radius: 999px; background: var(--c-border); border: 0; cursor: pointer; }
        .reply-deck .deck-dot.active, .reply-deck .deck-dot[aria-current="true"] { background: var(--c-accent-cyan); box-shadow: 0 0 8px var(--c-glow); }
        .reply-deck .deck-arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; border-radius: 999px; border: 1px solid var(--c-border); background: rgba(13,17,23,0.6); color: var(--c-text-primary); cursor: pointer; display: grid; place-items: center; opacity: 0.9; }
        .reply-deck .deck-arrow.left { left: 6px; }
        .reply-deck .deck-arrow.right { right: 6px; }
        .reply-deck .deck-arrow:hover { border-color: var(--c-accent-cyan); }
        .reply-deck .deck-footer { margin-top: 8px; font-size: 12px; opacity: 0.7; text-align: right; }
        /* Skeleton while waiting */
        .reply-skeleton { max-width: min(72ch, 100%); margin-inline: auto; border: 1px solid var(--c-border); border-radius: 0.75rem; padding: clamp(12px,3vw,24px); background: var(--c-glass); }
        .sk-stack { margin-top: 24px; display:flex; flex-direction:column; gap:18px; width:100%; }
        .sk-sheen { position:relative; display:block; height:15px; border-radius:999px; background: linear-gradient(90deg, rgba(0,240,255,0.14), rgba(0,240,255,0.18), rgba(0,240,255,0.14)); overflow:hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,.2), 0 1px 0 rgba(255,255,255,.05); }
        .sk-sheen::after { content:''; position:absolute; inset:-2px; background: linear-gradient(90deg, transparent, rgba(0,240,255,0.7), rgba(216,63,135,0.5), transparent); transform: translateX(-100%); animation: skSheen 1.8s cubic-bezier(0.4, 0, 0.2, 1) infinite; box-shadow: 0 0 20px rgba(0,240,255,.4); }
        @keyframes skSheen { 100% { transform: translateX(110%); } }
        .flash-highlight { animation: flash-focus 700ms ease; }
        @keyframes flash-focus { 0% { box-shadow: 0 0 0 0 rgba(0,240,255,0.45); } 100% { box-shadow: 0 0 0 0 rgba(0,240,255,0); } }
        #settings-status { margin-top:8px; }
        #settings-status[data-variant="error"] { color: #D83F87; opacity: 1; }
        #settings-status[data-variant="success"] { color: #00F0FF; opacity: 1; }
        #settings-status[data-variant="info"] { color: #E6EDF3; opacity: 0.85; }
        @media (prefers-reduced-motion: reduce){ .reply-wrap{ transition:none !important } .reply-deck, .reply-deck *{ transition:none !important; animation:none !important } .sk-sheen::after{ animation:none } .ai-slide{ animation:none !important } body::before{ animation:none !important } .card::before{ animation:none !important } }

        /* ----- Modal Deck (scoped) ----- */
        #ai-modal-backdrop {
          position: fixed; inset: 0; background: rgba(1,4,9,.65);
          backdrop-filter: blur(12px); opacity: 0; pointer-events: none; z-index: 200;
          transition: opacity 220ms cubic-bezier(0.16, 1, 0.3, 1); will-change: opacity;
        }
        #ai-modal {
          position: fixed; inset: 0; display: grid; place-items: center;
          pointer-events: none; z-index: 201;
        }
        .ai-deck-shell {
          position: fixed;
          inset: calc(env(safe-area-inset-top) + 24px) calc(env(safe-area-inset-right) + 16px)
            calc(env(safe-area-inset-bottom) + 24px) calc(env(safe-area-inset-left) + 16px);
          z-index: 201;
          display: grid;
          place-items: center;
          pointer-events: none;
        }
        .ai-modal-sheet {
          width: min(1100px, calc(100dvw - 32px - env(safe-area-inset-left) - env(safe-area-inset-right)));
          max-height: calc(100dvh - 96px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
          min-height: min(80dvh, 640px);
          position: relative;
          background: transparent;
          border-radius: 24px; overflow: hidden;
          transform: translateY(20px) scale(.96); opacity: 0;
          transition: transform 280ms cubic-bezier(0.16, 1, 0.3, 1), opacity 280ms ease;
          will-change: transform, opacity;
          pointer-events: auto;
          display: grid; grid-template-rows: auto 1fr auto;
          box-sizing: border-box;
          box-shadow: 0 40px 100px rgba(0,0,0,.75), 0 0 0 1px rgba(0,240,255,.08);
          --deck-fz: 16px;
          --deck-lh: 1.72;
          --deck-measure: 72ch;
        }
        .ai-modal-sheet::before {
          content:'';
          position:absolute; inset:0;
          border-radius: inherit;
          background: linear-gradient(135deg, rgba(0,240,255,.42), rgba(216,63,135,.36), rgba(255,200,0,.32));
          opacity:0.9;
          pointer-events:none;
          animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer { 0%, 100% { opacity:0.9; } 50% { opacity:0.75; } }
        .ai-modal-sheet::after {
          content:'';
          position:absolute; inset:1px;
          border-radius: calc(20px - 1px);
          background:
            radial-gradient(circle at 14% 10%, rgba(0,240,255,.18), transparent 58%),
            radial-gradient(circle at 88% 86%, rgba(216,63,135,.16), transparent 62%),
            linear-gradient(160deg, rgba(7,10,16,.96), rgba(9,13,19,.92) 45%, rgba(4,6,10,.96) 100%);
          box-shadow: inset 0 1px 0 rgba(255,255,255,.04), inset 0 -1px 0 rgba(0,0,0,.5);
          pointer-events:none;
        }
        .ai-modal-header { position:relative; display:flex; align-items:flex-start; justify-content:space-between; gap:20px; padding: clamp(20px, 3.4vw, 28px) clamp(22px, 4.2vw, 34px) clamp(16px, 3vw, 22px); border-bottom: 1px solid rgba(48,54,61,.6); background: linear-gradient(160deg, rgba(13,17,23,.92), rgba(13,17,23,.85)); border-top-left-radius:24px; border-top-right-radius:24px; z-index:1; backdrop-filter:blur(16px); }
        .ai-modal-title-wrap { display:flex; flex-direction:column; gap:6px; max-width:min(64ch, 72vw); }
        .ai-modal-title { font-family: var(--font-display); letter-spacing:0.08em; font-size:clamp(17px, 3.5vw, 20px); text-transform:uppercase; font-weight:900; text-shadow: 0 0 20px rgba(0,240,255,.4), 0 2px 8px rgba(0,0,0,.5); }
        .ai-modal-tagline { font-size:clamp(10px, 2vw, 12px); letter-spacing:0.28em; text-transform:uppercase; color: rgba(0,240,255,.75); font-weight:700; text-shadow: 0 0 12px rgba(0,240,255,.3); }
        .ai-hero-copy { font-size:13px; letter-spacing:0.08em; text-transform:uppercase; color: rgba(230,237,243,.78); font-weight:500; transition: color 180ms ease; }
        .ai-hero-copy[data-tone="info"] { color: rgba(0,240,255,.78); }
        .ai-hero-copy[data-tone="success"] { color:#12F9FF; }
        .ai-hero-copy[data-tone="alert"] { color:#FF6F91; }
        .ai-close { cursor:pointer; border:1px solid rgba(48,54,61,.85); border-radius:12px; padding:10px 14px; font-size:12px; font-weight:600; opacity:.88; background:rgba(13,17,23,.4); backdrop-filter:blur(8px); min-width:44px; min-height:44px; transition: all 180ms cubic-bezier(0.16, 1, 0.3, 1); position:relative; overflow:hidden; }
        .ai-close::before { content:''; position:absolute; inset:0; background: linear-gradient(135deg, rgba(0,240,255,.15), rgba(216,63,135,.1)); opacity:0; transition: opacity 180ms ease; }
        .ai-close:hover { opacity:1; border-color:rgba(0,240,255,.6); background:rgba(0,240,255,.12); transform:translateY(-2px); box-shadow: 0 4px 12px rgba(0,240,255,.2); }
        .ai-close:hover::before { opacity:1; }
        .ai-close:active { transform:translateY(0); box-shadow: 0 2px 6px rgba(0,240,255,.15); }
        .ai-sticky-head { position:sticky; top:0; z-index:2; padding: clamp(12px, 3vw, 22px); display:flex; flex-direction:column; gap:8px; backdrop-filter: blur(6px); background: rgba(8,12,18,.82); border-bottom:1px solid rgba(0,240,255,.12); box-shadow: 0 12px 32px rgba(0,0,0,.35); }
        .ai-sticky-head::after { content:''; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none; background: linear-gradient(120deg, rgba(0,240,255,.18), rgba(216,63,135,.14)); opacity:0.3; }
        .ai-sticky-head > * { position:relative; z-index:1; }
        .ai-sticky-title { font-family: var(--font-display); letter-spacing:0.1em; text-transform:uppercase; font-weight:800; font-size:clamp(1rem, 2.2vw, 1.25rem); color:#12F9FF; }
        .ai-sticky-price { font-size:clamp(0.85rem, 1.8vw, 1rem); color: rgba(255,255,255,.82); letter-spacing:0.05em; font-weight:600; }
        .ai-sticky-meta { display:flex; align-items:center; gap:12px; flex-wrap:wrap; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.2em; color: rgba(0,240,255,.75); }
        .ai-modal-body { position:relative; padding: clamp(18px, 3vw, 28px); overflow:hidden; border-bottom-left-radius:24px; border-bottom-right-radius:24px; z-index:1; display:flex; flex-direction:column; gap: clamp(22px, 4vw, 30px); }
        .ai-modal-scroll { position:relative; overflow:auto; -webkit-overflow-scrolling:touch; padding: clamp(18px,3vw,28px); box-sizing:border-box; width:100%; max-width:var(--deck-measure, 72ch); margin-inline:auto; border-radius:18px; backdrop-filter: blur(8px); font-size: var(--deck-fz); line-height: var(--deck-lh); }
        .ai-modal-scroll::-webkit-scrollbar { width:10px; }
        .ai-modal-scroll::-webkit-scrollbar-thumb { background: rgba(0,240,255,.25); border-radius:999px; }
        .ai-modal-scroll::-webkit-scrollbar-track { background: transparent; }
        .ai-modal-footer { padding: clamp(14px, 3vw, 22px); display:flex; justify-content:space-between; align-items:center; gap:18px; background: rgba(8,12,18,.9); border-top:1px solid rgba(48,54,61,.55); }
        .ai-footer-asof { font-size:0.72rem; letter-spacing:0.12em; text-transform:uppercase; color: rgba(230,237,243,.65); }
        .ai-deck { position:relative; display:grid; grid-auto-flow:column; grid-auto-columns:100%; gap: clamp(16px,2.2vw,24px); overflow-x:auto; overflow-y:visible; scroll-snap-type:x mandatory; overscroll-behavior-x:contain; -webkit-overflow-scrolling:touch; touch-action:pan-y; scroll-behavior:smooth; margin:0; padding-bottom: clamp(12px, 2vw, 18px); }
        .ai-deck::-webkit-scrollbar { display:none; }
        .ai-slide { position:relative; box-sizing:border-box; padding: clamp(16px, 2.5vw, 24px); border-radius:18px; background: linear-gradient(140deg, rgba(0,240,255,.18), rgba(216,63,135,.16), rgba(255,200,0,.12)); scroll-snap-align:start; scroll-snap-stop:always; min-height: clamp(300px, 52vh, 420px); animation: slideIn 520ms cubic-bezier(0.16, 1, 0.3, 1) backwards; display:flex; overflow:visible; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
        .ai-slide::before { content:''; position:absolute; inset:0; border-radius:inherit; opacity:0.15; background: radial-gradient(circle at 14% 12%, rgba(0,240,255,.4), transparent 68%), radial-gradient(circle at 86% 88%, rgba(216,63,135,.3), transparent 72%); filter: blur(40px); pointer-events:none; z-index:0; animation: slideGlow 4s ease-in-out infinite; }
        @keyframes slideGlow { 0%, 100% { opacity:0.15; filter: blur(40px); } 50% { opacity:0.08; filter: blur(45px); } }
        @keyframes slideIn { from { opacity:0; transform: translateY(8px) scale(0.98); } to { opacity:1; transform: translateY(0) scale(1); } }
        .ai-slide:nth-child(2) { animation-delay: 60ms; }
        .ai-slide:nth-child(3) { animation-delay: 120ms; }
        .ai-slide:nth-child(4) { animation-delay: 180ms; }
        .ai-slide h3 { margin:.25rem 0 .5rem; font-family:var(--font-display); }
        .ai-body > :first-child { margin-top: 0; }
        .ai-slide-shell { position:relative; z-index:1; border-radius: inherit; padding: clamp(32px,4.8vw,48px); background: linear-gradient(155deg, rgba(8,12,18,.98), rgba(10,14,20,.96)); box-shadow: inset 0 1px 0 rgba(255,255,255,.04), inset 0 -1px 0 rgba(0,0,0,.3); display:flex; flex-direction:column; gap:24px; flex:1; backdrop-filter: blur(10px); overflow:visible; }
        .ai-slide-shell::after { z-index:0; }
        .ai-slide-shell > * { position:relative; z-index:1; }
        .ai-slide-header { display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap; }
        .ai-badge { position:relative; top:auto; right:auto; font-size:12px; font-weight:700; padding:6px 14px; border-radius:999px; letter-spacing:.45px; background: rgba(0,240,255,.12); border:1px solid rgba(0,240,255,.3); box-shadow: 0 2px 6px rgba(0,240,255,.1), inset 0 1px 0 rgba(255,255,255,.08); }
        .ai-badge.cyan { background: rgba(0,240,255,.15); color:#12F9FF; border:1px solid rgba(0,240,255,.35); text-shadow: 0 0 12px rgba(0,240,255,.5), 0 1px 2px rgba(0,0,0,.5); }
        .ai-badge.pink { background: rgba(216,63,135,.15); color:#FF8FAD; border:1px solid rgba(216,63,135,.35); text-shadow: 0 0 12px rgba(216,63,135,.5), 0 1px 2px rgba(0,0,0,.5); box-shadow: 0 2px 6px rgba(216,63,135,.1), inset 0 1px 0 rgba(255,255,255,.08); }
        .ai-badge.amber { background: rgba(255,200,0,.12); color:#FFD97D; border:1px solid rgba(255,200,0,.3); text-shadow: 0 0 12px rgba(255,200,0,.4), 0 1px 2px rgba(0,0,0,.5); box-shadow: 0 2px 6px rgba(255,200,0,.08), inset 0 1px 0 rgba(255,255,255,.08); }
        .ai-slide-pill { font-size:10px; text-transform:uppercase; letter-spacing:0.3em; padding:5px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.04); color: rgba(230,237,243,.6); font-weight:600; box-shadow: inset 0 1px 0 rgba(255,255,255,.05); }
        .ai-body { font-family: var(--font-body); line-height: var(--deck-lh); color: rgba(230,237,243,.95); letter-spacing:0.015em; font-size: var(--deck-fz); }
        .ai-body p { margin-bottom:1rem; }
        .ai-body ul { margin:1rem 0 1rem 0; padding-left:0; list-style: none; }
        .ai-body ul li { margin-bottom:0.75rem; padding-left:1.8rem; position:relative; }
        .ai-body ul li::before { content:'–¸'; position:absolute; left:0.4rem; color:#00F0FF; font-weight:900; font-size:1.1em; }
        .ai-body strong { color:#00F0FF; font-weight:700; text-shadow: 0 0 10px rgba(0,240,255,.35), 0 1px 2px rgba(0,0,0,.5); background: linear-gradient(135deg, rgba(0,240,255,.12), rgba(0,240,255,.06)); padding:0.1em 0.3em; border-radius:3px; }
        .ai-slide-footer { margin-top:auto; display:flex; align-items:center; gap:8px; font-size:13px; color: rgba(0,240,255,.78); letter-spacing:0.02em; }
        .ai-slide-spark { display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:50%; background: rgba(0,240,255,.18); color:#00F0FF; font-size:12px; box-shadow:0 0 14px rgba(0,240,255,.3); }
        .ai-dots { position:relative; z-index:1; display:flex; justify-content:center; gap:12px; margin:18px 0 6px; }
        .ai-dot { width:12px; height:12px; border-radius:999px; border:1px solid rgba(0,240,255,.28); background:rgba(0,240,255,.08); transition: all 220ms cubic-bezier(0.16, 1, 0.3, 1); cursor:pointer; box-shadow: inset 0 0 6px rgba(0,240,255,.32); }
        .ai-dot:hover { border-color:rgba(0,240,255,.6); transform:scale(1.2); box-shadow: 0 0 12px rgba(0,240,255,.35); }
        .ai-dot[aria-current="true"] { background:#00F0FF; border-color:rgba(0,240,255,.9); box-shadow: 0 0 18px rgba(0,240,255,.6); }
        .ai-progress-bar { position:relative; height:5px; border-radius:999px; background: rgba(0,240,255,.2); overflow:hidden; margin-top:8px; box-shadow: inset 0 1px 2px rgba(0,0,0,.3), 0 1px 0 rgba(255,255,255,.05); }
        .ai-progress-bar::after { content:''; position:absolute; inset:0; background: linear-gradient(90deg, rgba(0,240,255,0), rgba(0,240,255,1), rgba(216,63,135,.8), rgba(0,240,255,0)); transform: translateX(-100%); animation: progressSweep 2.4s cubic-bezier(0.4, 0, 0.2, 1) infinite; box-shadow: 0 0 12px rgba(0,240,255,.6); }
        @keyframes progressSweep { 0% { transform: translateX(-100%); } 60% { transform: translateX(70%); } 100% { transform: translateX(110%); opacity:0.3; } }
        html[data-enlarged="1"] .ai-modal-body { font-size:1.125rem; line-height:1.8; }
        .ai-deck--text-sm { --deck-fz: 14px; --deck-lh: 1.65; --deck-measure: 68ch; }
        .ai-deck--text-md { --deck-fz: 16px; --deck-lh: 1.72; --deck-measure: 72ch; }
        .ai-deck--text-lg { --deck-fz: 18px; --deck-lh: 1.82; --deck-measure: 78ch; }
        .ai-deck__aa-menu { position:absolute; inset:auto 12px calc(-4px) auto; translate:0 -8px; padding:6px 8px; display:none; gap:8px; background:rgba(0,0,0,0.55); border:1px solid rgba(255,255,255,0.12); border-radius:10px; box-shadow:0 12px 32px rgba(0,0,0,.45); backdrop-filter:blur(6px); }
        .ai-deck__aa-menu[aria-expanded="true"] { display:flex; }
        .ai-deck__aa-btn { width:44px; height:36px; display:grid; place-items:center; border-radius:8px; border:1px solid rgba(255,255,255,0.18); font-size:0.85rem; cursor:pointer; color:rgba(230,237,243,.8); background:rgba(10,14,20,.65); transition: all 160ms ease; }
        .ai-deck__aa-btn:hover { color:#00F0FF; border-color:rgba(0,240,255,.4); }
        .ai-deck__aa-btn[aria-checked="true"] { opacity:1; color:#00F0FF; border-color:rgba(0,240,255,.55); box-shadow:0 0 16px rgba(0,240,255,.2); }
        @media (max-width: 1024px) { .ai-modal-sheet { width: min(94vw, 820px); } .ai-modal-header { flex-direction: column; align-items:flex-start; gap:14px; } .ai-deck { max-width: 62ch; } }
        @media (max-width: 768px) { .ai-modal-sheet { width: 94vw; max-height:90vh; } .ai-modal-body { padding: 18px 18px 28px; gap: 20px; } .ai-deck { padding: 26px 20px 42px; min-height: clamp(280px, 58vh, 400px); } .ai-slide { min-height: clamp(260px, 56vh, 380px); } .ai-slide-shell { padding: 24px; gap:20px; } .ai-body { font-size:0.9rem; line-height:1.95; } .ai-body ul li { margin-bottom:0.65rem; padding-left:1.6rem; } .ai-modal-title { font-size:16px; } .ai-modal-tagline { font-size:11px; letter-spacing:0.2em; } .ai-close { min-width:38px; min-height:38px; font-size:11px; padding:6px 10px; } }
        @media (max-width: 520px) { .ai-modal-sheet { width: 96vw; max-height:92vh; margin: 8px auto; } .ai-modal-body { padding: 16px 14px 24px; gap: 16px; } .ai-deck { padding: 22px 14px 36px; gap: 14px; max-width: 100%; min-height:280px; } .ai-slide { min-height: 260px; } .ai-slide-shell { padding:22px; gap:18px; } .ai-slide-header { align-items:flex-start; gap:10px; flex-direction:column; } .ai-modal-title-wrap { gap:3px; } .ai-modal-title { font-size:15px; } .ai-modal-tagline, .ai-hero-copy { font-size:10px; letter-spacing:0.12em; } .ai-badge { font-size:11px; padding:5px 10px; } .ai-slide-pill { font-size:9px; padding:4px 10px; letter-spacing:0.25em; } .ai-body { font-size:0.875rem; line-height:1.9; } .ai-body ul li { margin-bottom:0.6rem; padding-left:1.4rem; } .ai-body ul li::before { font-size:1em; } .ai-slide-footer { font-size:12px; } }
        @media (prefers-reduced-motion: reduce) { #ai-modal-backdrop, .ai-modal-sheet { transition:none; } }

        /* A11y helpers */
        .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

        /* Dock bubble */
        #ai-dock { position: fixed; right: max(16px, env(safe-area-inset-right)); bottom: max(16px, env(safe-area-inset-bottom)); z-index: 203; display:none; }
        .ai-dock-bubble { display:flex; align-items:center; gap:8px; padding:10px 14px; border:1px solid rgba(48,54,61,.9); background: linear-gradient(135deg, rgba(13,17,23,.95), rgba(1,4,9,.92)); border-radius: 14px; cursor: pointer; min-height:48px; box-shadow: 0 4px 16px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05); transition: all 200ms ease; }
        .ai-dock-bubble:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.08); border-color:rgba(0,240,255,.3); }
        .ai-dock-bubble.pulse { animation: bradaaPulse 1.6s ease-out infinite; }
        .ai-dock-bubble img { width:24px; height:24px; }
        @keyframes bradaaPulse { 0%{ box-shadow:0 0 0 0 rgba(0,240,255,.5), 0 4px 16px rgba(0,0,0,.5) } 100% { box-shadow:0 0 0 20px rgba(0,240,255,0), 0 4px 16px rgba(0,0,0,.5)} }
        @media (prefers-reduced-motion: reduce) { .ai-dock-bubble.pulse { animation: none; } }

        /* Toast notifications */
        #toast-container { position:fixed; top:max(16px, env(safe-area-inset-top)); right:max(16px, env(safe-area-inset-right)); z-index:300; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
        .toast { background: linear-gradient(135deg, rgba(13,17,23,.98), rgba(1,4,9,.95)); border:1px solid rgba(48,54,61,.9); border-radius:12px; padding:12px 16px; min-width:280px; box-shadow: 0 4px 20px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05); pointer-events:auto; animation: toastIn 300ms cubic-bezier(0.16, 1, 0.3, 1); display:flex; align-items:flex-start; gap:12px; position:relative; }
        .toast.out { animation: toastOut 200ms ease forwards; }
        @keyframes toastIn { from { opacity:0; transform:translateX(100px); } to { opacity:1; transform:translateX(0); } }
        @keyframes toastOut { to { opacity:0; transform:translateX(100px); } }
        .toast strong { display:block; font-size:14px; margin-bottom:2px; }
        .toast p { margin:0; font-size:13px; line-height:1.4; opacity:.78; }
        .toast-icon { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; background:rgba(0,240,255,.12); border-radius:50%; font-size:15px; }
        .toast.toast-success { border-color: rgba(0,240,255,.5); }
        .toast.toast-error { border-color: rgba(216,63,135,.5); }
        .toast.toast-info { border-color: rgba(0,240,255,.25); }
        .toast-close { position:absolute; top:10px; right:10px; background:transparent; border:none; color:rgba(230,237,243,.6); cursor:pointer; font-size:14px; padding:4px; transition: color 120ms ease; }
        .toast-close:hover { color:rgba(230,237,243,1); }

        /* Settings panel */
        #settings-panel { position:fixed; inset:0; z-index:299; display:flex; align-items:center; justify-content:center; }
        #settings-panel[aria-hidden="true"] { display:none; }
        #settings-backdrop { position:absolute; inset:0; background:rgba(1,4,9,.6); backdrop-filter:blur(6px); }
        #settings-modal { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(480px, 90vw); background: linear-gradient(135deg, rgba(13,17,23,.98), rgba(1,4,9,.95)); border:1px solid rgba(48,54,61,.9); border-radius:16px; padding:24px; box-shadow: 0 20px 60px rgba(0,0,0,.7); max-height:80vh; overflow-y:auto; }
        #settings-modal h3 { font-family: var(--font-display); font-size:20px; margin:0 0 16px; }
        #settings-modal label { display:block; font-size:13px; opacity:.8; margin-bottom:6px; }
        #settings-modal input { width:100%; background:rgba(1,4,9,.6); border:1px solid rgba(48,54,61,.8); border-radius:8px; padding:10px 12px; color:var(--c-text-primary); font-size:14px; transition: all 150ms ease; }
        #settings-modal input:focus { outline:none; border-color:rgba(0,240,255,.6); box-shadow: 0 0 0 3px rgba(0,240,255,.15); }
        #settings-modal .btn-group { display:flex; gap:8px; margin-top:20px; }
        #settings-modal button { flex:1; padding:10px 16px; border-radius:8px; font-weight:600; cursor:pointer; transition: all 150ms ease; }
        #settings-modal .btn-primary { background:linear-gradient(135deg, #00F0FF, #00A8B5); border:none; color:#0D1117; }
        #settings-modal .btn-primary:hover { transform:translateY(-1px); box-shadow: 0 4px 12px rgba(0,240,255,.4); }
        #settings-modal .btn-secondary { background:transparent; border:1px solid rgba(48,54,61,.8); color:var(--c-text-primary); }
        #settings-modal .btn-secondary:hover { border-color:rgba(0,240,255,.5); background:rgba(0,240,255,.08); }
        .settings-hint { font-size:12px; opacity:.7; margin-top:10px; }
        .settings-meta { font-size:12px; opacity:.6; margin-top:6px; }
        .settings-trigger { position:absolute; top:1rem; right:1rem; padding:8px 12px; border:1px solid rgba(48,54,61,.8); border-radius:8px; background:rgba(13,17,23,.6); cursor:pointer; transition: all 150ms ease; opacity:0.7; color: var(--c-text-secondary); }
        .settings-trigger:hover { opacity:1; border-color:rgba(0,240,255,.5); color:var(--c-accent-cyan); }
        .settings-trigger:focus-visible { outline:none; border-color:rgba(0,240,255,.6); box-shadow:0 0 0 3px rgba(0,240,255,.18); opacity:1; }

        @keyframes consoleFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .console-animating > * {
            animation: consoleFadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        #laptop-selector-container button.active{
          background-color: var(--c-accent-cyan);
          color: var(--c-bg);
          border-color: var(--c-accent-cyan);
          box-shadow: 0 0 6px var(--c-accent-cyan);
        }

        /* Feature flag: Enhanced UI (c5) €” default OFF */
        html[data-enhanced-ui="1"] {
          font-size: clamp(15px, 1.25vw, 18px);
        }
        html[data-enhanced-ui="1"] .card-content {
          padding: clamp(1rem, 2.4vw, 1.8rem);
        }
        html[data-enhanced-ui="1"] h1 {
          font-size: clamp(2.2rem, 4.2vw, 3.2rem);
          text-align: center;
        }
        html[data-enhanced-ui="1"] h2 {
          font-size: clamp(1.6rem, 2.6vw, 2.2rem);
          text-align: center;
        }
        html[data-enhanced-ui="1"] h3 {
          font-size: clamp(1.2rem, 1.8vw, 1.4rem);
        }
        html[data-enhanced-ui="1"] .gemini-output {
          line-height: 1.8;
        }
        html[data-enhanced-ui="1"] header p {
          text-align: center;
        }

        /* UI toggle button */
        .ui-toggle {
          position: fixed;
          top: 80px;
          right: 1rem;
          z-index: 100;
          display: flex;
          gap: 0.5rem;
          padding: 0.5rem;
          background: var(--c-glass);
          backdrop-filter: blur(12px);
          border: 1px solid var(--c-border);
          border-radius: 0.5rem;
          font-size: 0.75rem;
        }
        .ui-toggle button {
          padding: 0.25rem 0.5rem;
          border: 1px solid var(--c-border);
          border-radius: 0.25rem;
          background: transparent;
          color: var(--c-text-secondary);
          cursor: pointer;
          transition: all 0.2s;
        }
        .ui-toggle button.active {
          background: var(--c-accent-cyan);
          color: var(--c-bg);
          border-color: var(--c-accent-cyan);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- UI Toggle (c5: feature flag) -->
    <div class="ui-toggle">
      <span class="opacity-70">Text:</span>
      <button id="ui-normal" class="active">Normal</button>
      <button id="ui-large">Large</button>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="text-center py-10" style="padding-bottom:2.5rem; border-bottom: 1px solid rgba(48,54,61,0.3); margin-bottom:1.5rem;">
            <h1 class="font-display text-4xl md:text-6xl font-black" style="letter-spacing:-0.02em; background: linear-gradient(135deg, #00F0FF, #E6EDF3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">AI BRADAA</h1>
            <p class="text-lg text-[var(--c-text-secondary)] mt-2">Powered by Kaa-Ching!</p>
            <button id="settings-trigger" class="settings-trigger" aria-haspopup="dialog" aria-controls="settings-panel" title="Settings">š™ï¸ Settings</button>
        </header>

        <nav class="nav-sticky py-3 mb-12">
            <div class="flex flex-wrap justify-center gap-4 md:gap-6 text-sm">
                <a href="#matchmaker" class="nav-button active px-1 py-2 font-semibold">Matchmaker</a>
                <a href="#comparison" class="nav-button px-1 py-2 font-semibold">Versus</a>
                <a href="#explorer" class="nav-button px-1 py-2 font-semibold">Explorer</a>
                <a href="#toolkit" class="nav-button px-1 py-2 font-semibold">Ops Command</a>
                <a href="#intelligence" class="nav-button px-1 py-2 font-semibold">Intel</a>
                <a href="#appendices" class="nav-button px-1 py-2 font-semibold">Appendices</a>
                <a href="#camera-tech" class="nav-button px-1 py-2 font-semibold">Camera Tech</a>
            </div>
        </nav>

        <main class="space-y-16">
            <section id="matchmaker" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">AI Laptop Matchmaker</h2>
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                        <div class="space-y-4">
                            <p class="text-[var(--c-text-secondary)]">Yo. I'm AI Bradaa. Stop guessing. Provide your parameters, and I'll give you the optimal choice. Let's execute.</p>
                            <div><label class="block mb-2">1. Your Budget (MYR)</label><select id="match-budget" class="w-full"><option>Under RM4,500</option><option selected>RM4,500 - RM7,000</option><option>No Budget (Concierge)</option></select></div>
                            <div><label class="block mb-2">2. Primary Use Case</label><select id="match-usecase" class="w-full"><option>AI/ML & Coding</option><option>Creative Work (Video/3D)</option><option>Gaming & Everyday Use</option></select></div>
                            <div><label class="block mb-2">3. Portability Need</label><select id="match-portability" class="w-full"><option>Mostly at a desk</option><option>Always on the move</option><option>A mix of both</option></select></div>
                            <button id="find-match-btn" class="w-full action-button">œ¨ Find My Match</button>
                        </div>
                        <div id="matchmaker-output" class="p-4 bg-[var(--c-bg)] rounded-lg min-h-[250px] text-[var(--c-text-secondary)] gemini-output">AI Bradaa's recommendation will appear here...</div>
                    </div>
                </div>
            </section>

            <section id="comparison" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Head-to-Head Comparison</h2>
                    <p class="text-sm text-[var(--c-text-secondary)] mb-4">Select 2 or 3 units for a tactical breakdown. AI Bradaa will generate an automated strategic analysis.</p>
                    <div class="max-h-48 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-2 mb-6 p-2 bg-[var(--c-bg)] rounded-lg" id="laptop-selector-container">Loading Intel...</div>
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                         <div style="position: relative; height:450px;"><canvas id="radarChart"></canvas></div>
                         <div id="gemini-comparison-output" class="p-4 bg-[var(--c-bg)] rounded-lg min-h-[300px] text-sm text-[var(--c-text-secondary)] gemini-output">Select laptops to begin analysis...</div>
                    </div>
                </div>
            </section>

            <section id="explorer" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Interactive Market Explorer</h2>
                    <div id="filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-[var(--c-bg)] rounded-lg">
                        <div><label class="font-semibold text-sm mb-2 block">Price Range (‰¤ RM<span id="price-value">7000</span>)</label><input type="range" id="price-filter" min="3500" max="7000" value="7000" step="100" class="w-full"></div>
                        <div><label class="font-semibold text-sm mb-2 block">Platform</label><div class="flex gap-2"><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md active" data-platform="All">All</button><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-platform="CUDA">CUDA</button><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-platform="NPU">NPU</button><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-platform="Mac">Mac</button></div></div>
                        <div><label class="font-semibold text-sm mb-2 block">Brand</label><select id="brand-filter" class="w-full"><option value="All" selected>All Brands</option></select></div>
                        <div><label class="font-semibold text-sm mb-2 block">Sort By</label><select id="sort-filter" class="w-full"><option value="score_desc" selected>Score (High-Low)</option><option value="price_asc">Price (Low-High)</option><option value="price_desc">Price (High-Low)</option><option value="value_desc">Value Rating (Score-to-Price Ratio)</option></select></div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <div style="position: relative; height:500px;"><canvas id="rankingsChart"></canvas></div>
                        <div style="position: relative; height:500px;"><canvas id="valueChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section id="toolkit" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">AI Bradaa Toolkit</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="md:col-span-1 space-y-2 max-h-[600px] overflow-y-auto">
                            <button class="tool-selector-btn active" data-tool="deal-assassin">Deal Assassin</button>
                            <button class="tool-selector-btn" data-tool="upgrade-strategist">Upgrade Strategist</button>
                            <button class="tool-selector-btn" data-tool="dream-rig-architect">Dream Rig Architect</button>
                            <button class="tool-selector-btn" data-tool="elite-procurement">Elite Procurement</button>
                            <button class="tool-selector-btn" data-tool="component-recon">Component Recon</button>
                            <button class="tool-selector-btn" data-tool="performance-forecaster">Performance Forecaster</button>
                            <button class="tool-selector-btn" data-tool="system-integrity">System Integrity Analysis</button>
                            <button class="tool-selector-btn" data-tool="ecosystem-architect">Ecosystem Architect</button>
                            <button class="tool-selector-btn" data-tool="longevity-analyst">Longevity Analyst</button>
                            <button class="tool-selector-btn" data-tool="asset-value">Asset Value Forecaster</button>
                            <button class="tool-selector-btn" data-tool="field-support">Field Support</button>
                        </div>
                        <div id="toolkit-console" class="md:col-span-2 bg-[var(--c-bg)] p-4 rounded-lg flex flex-col">
                        </div>
                    </div>
                </div>
            </section>

             <section id="intelligence" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Latest Tech Intel</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="p-4 bg-[var(--c-bg)] rounded-lg">
                            <h3 id="intel-0-title" class="font-display text-lg text-[var(--c-accent-pink)]">Acquiring Intel...</h3>
                            <p id="intel-0-summary" class="text-xs text-[var(--c-text-secondary)] mt-2">AI Bradaa is scanning for intel...</p>
                            <p class="mt-3 font-semibold">Verdict: <span id="intel-0-verdict" class="text-[var(--c-accent-pink)]">STANDBY</span></p>
                        </div>
                        <div class="p-4 bg-[var(--c-bg)] rounded-lg">
                            <h3 id="intel-1-title" class="font-display text-lg text-[var(--c-accent-cyan)]">Acquiring Intel...</h3>
                            <p id="intel-1-summary" class="text-xs text-[var(--c-text-secondary)] mt-2">AI Bradaa is scanning for intel...</p>
                            <p class="mt-3 font-semibold">Verdict: <span id="intel-1-verdict" class="text-[var(--c-accent-cyan)]">STANDBY</span></p>
                        </div>
                        <div class="p-4 bg-[var(--c-bg)] rounded-lg">
                            <h3 id="intel-2-title" class="font-display text-lg text-[var(--c-text-secondary)]">Acquiring Intel...</h3>
                            <p id="intel-2-summary" class="text-xs text-[var(--c-text-secondary)] mt-2">AI Bradaa is scanning for intel...</p>
                            <p class="mt-3 font-semibold">Verdict: <span id="intel-2-verdict" class="text-[var(--c-text-secondary)]">STANDBY</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="appendices" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Appendices: Full Laptop Database</h2>
                    <p class="text-sm text-[var(--c-text-secondary)] mb-4 text-center">This list is updated automatically by the filters in the <a href="#explorer" class="underline text-[var(--c-accent-cyan)]">Explorer</a> section.</p>
                    <div id="laptop-list-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 max-h-[80vh] overflow-y-auto p-2">
                        <p class="text-center xl:col-span-3">Loading market data...</p>
                    </div>
                </div>
            </section>

            <section id="camera-tech" class="card">
                <div class="card-content flex flex-col justify-center items-center text-center min-h-[250px]">
                    <h2 class="font-display text-2xl text-[var(--c-text-secondary)]">Camera &amp; Smartphone Tech Division</h2>
                    <p class="mt-4 text-[var(--c-text-secondary)]">A new strategic vertical is under development.</p>
                    <p class="mt-2 text-[var(--c-text-secondary)]">Mobile gear ops (smartphones, lenses) are queuing up next.</p>
                    <p class="font-display text-4xl mt-4 animate-pulse">COMING SOON</p>
                </div>
            </section>
        </main>
    </div>

    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div id="settings-panel" aria-hidden="true">
      <div id="settings-backdrop" tabindex="-1"></div>
      <div id="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
        <button id="settings-close" class="toast-close" aria-label="Close settings">œ•</button>
        <h3 id="settings-title">Executive Settings</h3>
        <p class="settings-hint">Point AI Bradaa to a live laptop dataset. We'll sync weekly and archive anything replaced.</p>
        <label for="settings-source">Weekly laptop data URL (HTTPS JSON)</label>
        <input id="settings-source" type="url" inputmode="url" placeholder="https://example.com/laptops.json" autocomplete="off">
        <div class="settings-meta" id="settings-last-run">Last refresh: not yet</div>
        <div class="settings-hint">Leave blank to rely on the built-in 35-item master list.</div>
        <div class="settings-hint" id="settings-status" hidden></div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" id="settings-cancel">Cancel</button>
          <button type="button" class="btn-primary" id="settings-save">Save & Refresh</button>
        </div>
      </div>
    </div>

<script>
/* ==========================================================================
   AI Bradaa Strategic Command €” v15.2 (Architect Edition)
   Code refactored for clarity, performance, and robustness.
   All AI features are live and persona-aligned.
   ========================================================================== */

// --- AI & VALIDATION CONSTANTS --------------------------------------------

const KAACHING_VAB = `
You are **AI Bradaa**, operating under **Kaa-Ching Virtual Board Assistance (VAB) €” AI Agent**.
Mission: pragmatic Malaysian tech advisor focused on **value, reliability, thermals, upgrade paths**, and fewer headaches.
Tone: friendly, confident, direct, lightly playful. Prefer **MYR** and Malaysia context.
Format: Markdown with **### headings** and concise bullet points. Be decisive; explain *why* with concrete factors (price/TGP/thermals/ports/ecosystem).
Rules:
- Don't fabricate price/stock. If unsure, say so and give next steps.
- Optimize for "best value" and minimum friction. Offer 1€“2 alternatives only when useful.
`;

const MENTOR_LENSES = [
  { id:'csp',          mentor:'CSP Guardian',               lens:'CSP Compliance',              brief:'Single CSP meta; only approved hosts; AI connect-src ok; images allowed (self,data,blob,https); fonts/styles/scripts from whitelisted CDNs.' },
  { id:'uiux',         mentor:'UI/UX Lead',                 lens:'UI/UX Parity',                brief:'Sections/IDs match v15.2; sticky nav; glass cards; no markup drift; headings text exact (Toolkit heading = "AI Bradaa Toolkit").' },
  { id:'func',         mentor:'Functional QA',              lens:'Functional Integrity',        brief:'Filters, radar select (‰¤3), price menu toggle, Toolkit actions call AI, Intel init, no console errors.' },
  { id:'fallback',     mentor:'Data Reliability Officer',   lens:'Fallback Data Guarantee',     brief:'`fallbackLaptops` = 35 exact items; proper keys; inch quotes escaped; fetch fallback path works.' },
  { id:'charts',       mentor:'DataViz Engineer',           lens:'Chart Readiness',             brief:'Chart.js defaults configured; rankings bar, value scatter, radar all initialize; platformColorMap applied.' },
  { id:'pwa',          mentor:'PWA Engineer',               lens:'PWA Readiness',               brief:'Manifest linked; icons present; theme colors set; installable.' },
  { id:'a11y',         mentor:'Accessibility Advocate',     lens:'Accessibility & Semantics',   brief:'Heading hierarchy; discernible button text; keyboard operable; contrast per v15.2 palette.' },
  { id:'perf',         mentor:'Performance Engineer',       lens:'Performance & Bloat Control', brief:'Only Tailwind/Chart.js/Fonts CDNs; no extra blocking scripts; efficient init.' },
  { id:'maintain',     mentor:'Maintainability Coach',      lens:'Maintainability',             brief:'Single source of truth (VAB); clean prompt builder; no duplicated constants; comments preserved.' },
  { id:'nocollateral', mentor:'Change Control Officer',     lens:'No Collateral Changes',       brief:'Only intended files modified; no unrelated configs or serverless affected.' },
];

const LENSES_WEIGHTS = { uiux:20, func:20, fallback:15, csp:10, charts:10, pwa:10, perf:5, a11y:5, maintain:3, nocollateral:2 };
;(() => {
  'use strict';

  // --- STATE & CONSTANTS ----------------------------------------------------
  const STATE = {
    data: {
      allLaptops: [],
      sortedByRank: [],
      fallbackLaptops: [
        { "brand": "Illegear", "model": "Illegear Z7 (2025)", "price": 6899, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Illegear+Z7", "cpu": "Intel Core i7-14700HX", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5 5600MHz", "storage": "1TB NVMe Gen4 SSD", "display": "17.3\" QHD 240Hz", "price_source_url": "https://www.illegear.com/laptops/z7/", "shopee_url": "https://shopee.com.my/search?keyword=Illegear%20Z7", "tiktok_url": "https://www.tiktok.com/tag/illegearz7", "score": 95, "platform": "CUDA", "why": "Exceptional thermal performance and full-power RTX 4060.", "scores": { "ai": 9, "thermals": 10, "upgrade": 9, "linux": 7, "portability": 6, "value": 9 } },
        { "brand": "Lenovo", "model": "Legion Slim 5 16APH8", "price": 6299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Legion+Slim+5", "cpu": "AMD Ryzen 7 7840HS", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5 5600MHz", "storage": "512GB NVMe Gen4 SSD", "display": "16\" WQXGA 165Hz", "price_source_url": "https://www.lenovo.com/my/en/p/laptops/legion-laptops/legion-slim-series/legion-slim-5-gen-8-(16-inch-amd)/82y9006qmj", "shopee_url": "https://shopee.com.my/search?keyword=Legion%20Slim%205", "tiktok_url": null, "score": 93, "platform": "CUDA", "why": "Outstanding balance of build quality, performance, and aesthetic.", "scores": { "ai": 9, "thermals": 9, "upgrade": 8, "linux": 8, "portability": 7, "value": 9 } },
        { "brand": "ASUS", "model": "ROG Zephyrus G14 (2023)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Zephyrus+G14", "cpu": "AMD Ryzen 7 7735HS", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "14\" QHD+ 165Hz", "price_source_url": "https://www.asus.com/my/laptops/for-gaming/rog-republic-of-gamers/rog-zephyrus-g14-2023/", "shopee_url": "https://shopee.com.my/search?keyword=Zephyrus%20G14%202023", "tiktok_url": "https://www.tiktok.com/tag/zephyrusg14", "score": 92, "platform": "CUDA", "why": "Benchmark for compact power; incredible performance in a 14-inch chassis.", "scores": { "ai": 8, "thermals": 8, "upgrade": 7, "linux": 8, "portability": 9, "value": 8 } },
        { "brand": "ASUS", "model": "TUF Gaming A16 FA617NS", "price": 5599, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ASUS+TUF+A16", "cpu": "AMD Ryzen 9 7940HS", "gpu": "AMD Radeon RX 7600S", "ram": "16GB DDR5 4800MHz", "storage": "512GB NVMe Gen4 SSD", "display": "16\" FHD+ 165Hz", "price_source_url": "https://www.asus.com/my/laptops/for-gaming/tuf-gaming/asus-tuf-gaming-a16-advantage-edition-2023/", "shopee_url": "https://shopee.com.my/search?keyword=TUF%20Gaming%20A16", "tiktok_url": null, "score": 91, "platform": "CUDA", "why": "All-AMD advantage provides incredible efficiency and battery life.", "scores": { "ai": 8, "thermals": 9, "upgrade": 8, "linux": 9, "portability": 6, "value": 10 } },
        { "brand": "Gigabyte", "model": "AORUS 15 (2024)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Gigabyte+AORUS", "cpu": "Intel Core i7-13700H", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5", "storage": "1TB NVMe Gen4 SSD", "display": "15.6\" QHD 165Hz", "price_source_url": "https://www.gigabyte.com/my/Laptop/AORUS-15--2024", "shopee_url": "https://shopee.com.my/search?keyword=AORUS%2015%20BKG", "tiktok_url": null, "score": 90, "platform": "CUDA", "why": "Premium gaming build with a high-TGP RTX 4060 at budget's edge.", "scores": { "ai": 9, "thermals": 9, "upgrade": 8, "linux": 6, "portability": 5, "value": 8 } },
        { "brand": "Aftershock", "model": "Apex 15X (Gen 13)", "price": 6450, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Aftershock+Apex", "cpu": "Intel Core i7-13700HX", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5", "storage": "1TB NVMe Gen4 SSD", "display": "15.6\" QHD 165Hz", "price_source_url": "https://www.aftershockpc.com.my/products/apex-15x-13th-gen-rtx-4060", "shopee_url": "https://shopee.com.my/search?keyword=Aftershock%20Apex%2015X", "tiktok_url": null, "score": 90, "platform": "CUDA", "why": "Highly customizable, offering desktop-like power in a laptop form factor.", "scores": { "ai": 9, "thermals": 9, "upgrade": 10, "linux": 7, "portability": 5, "value": 8 } },
        { "brand": "Apple", "model": "MacBook Air 15-inch (M3)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MacBook+Air+15", "cpu": "Apple M3 Chip", "gpu": "10-core GPU", "ram": "8GB Unified Memory", "storage": "512GB SSD", "display": "15.3\" Liquid Retina", "price_source_url": "https://www.apple.com/my/shop/buy-mac/macbook-air/15-inch-m3", "shopee_url": "https://shopee.com.my/search?keyword=MacBook%20Air%2015%20M3", "tiktok_url": "https://www.tiktok.com/tag/macbookairm3", "score": 89, "platform": "Mac", "why": "Unbeatable power efficiency and silent, fanless design for AI on the go.", "scores": { "ai": 8, "thermals": 10, "upgrade": 1, "linux": 1, "portability": 10, "value": 7 } },
        { "brand": "Lenovo", "model": "IdeaPad Pro 5 16AHP9", "price": 5499, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=IdeaPad+Pro+5", "cpu": "AMD Ryzen 7 8845HS", "gpu": "NVIDIA RTX 3050 6GB", "ram": "16GB LPDDR5X", "storage": "1TB NVMe SSD", "display": "16\" 2.5K 120Hz", "price_source_url": "https://www.lenovo.com/my/en/p/laptops/ideapad/ideapad-pro-series/ideapad-pro-5-gen-9-(16-inch-amd)/len101i0062", "shopee_url": "https://shopee.com.my/search?keyword=IdeaPad%20Pro%205%2016AHP9", "tiktok_url": null, "score": 88, "platform": "NPU", "why": "Powerful AMD Ryzen 8000 series NPU for productive multitasking.", "scores": { "ai": 8, "thermals": 8, "upgrade": 2, "linux": 8, "portability": 6, "value": 9 } },
        { "brand": "Razer", "model": "Razer Blade 14 (2023)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Razer+Blade+14", "cpu": "AMD Ryzen 9 7940HS", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB LPDDR5X", "storage": "1TB NVMe SSD", "display": "14\" QHD+ 240Hz", "price_source_url": "https://www.razer.com/my-en/gaming-laptops/Razer-Blade-14/RZ09-0493BND3-R3B1", "shopee_url": "https://shopee.com.my/search?keyword=Razer%20Blade%2014%202023", "tiktok_url": null, "score": 88, "platform": "CUDA", "why": "Unparalleled CNC-milled aluminum build quality in a compact form factor.", "scores": { "ai": 8, "thermals": 8, "upgrade": 1, "linux": 6, "portability": 9, "value": 7 } },
        { "brand": "HP", "model": "Omen 16 (2024)", "price": 5999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=HP+Omen+16", "cpu": "Intel Core i7-14700HX", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" QHD 165Hz", "price_source_url": "https://www.hp.com/my-en/laptops/gaming/omen-16-intel/", "shopee_url": "https://shopee.com.my/search?keyword=HP%20Omen%2016", "tiktok_url": null, "score": 87, "platform": "CUDA", "why": "Great thermal performance with OMEN Tempest Cooling.", "scores": { "ai": 8, "thermals": 9, "upgrade": 7, "linux": 7, "portability": 6, "value": 8 } },
        { "brand": "Apple", "model": "MacBook Pro 14-inch (M3)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MacBook+Pro+14", "cpu": "Apple M3 Pro", "gpu": "14-core GPU", "ram": "16GB Unified Memory", "storage": "512GB SSD", "display": "14.2\" Liquid Retina XDR", "price_source_url": "https://www.apple.com/my/macbook-pro-14-and-16/", "shopee_url": "https://shopee.com.my/search?keyword=MacBook%20Pro%2014%20M3", "tiktok_url": "https://www.tiktok.com/tag/macbookprom3", "score": 87, "platform": "Mac", "why": "Pro-grade performance with exceptional display quality.", "scores": { "ai": 9, "thermals": 9, "upgrade": 1, "linux": 1, "portability": 8, "value": 7 } },
        { "brand": "MSI", "model": "Pulse 15 B13V", "price": 5899, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MSI+Pulse+15", "cpu": "Intel Core i7-13700H", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5", "storage": "1TB NVMe SSD", "display": "15.6\" FHD 144Hz", "price_source_url": "https://my.msi.com/Laptop/Pulse-15-B13V/", "shopee_url": "https://shopee.com.my/search?keyword=MSI%20Pulse%2015", "tiktok_url": null, "score": 86, "platform": "CUDA", "why": "Solid cooling system with Cooler Boost 5 technology.", "scores": { "ai": 8, "thermals": 8, "upgrade": 7, "linux": 7, "portability": 6, "value": 8 } },
        { "brand": "ASUS", "model": "VivoBook Pro 16X", "price": 5499, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=VivoBook+Pro+16X", "cpu": "AMD Ryzen 7 7840HS", "gpu": "NVIDIA RTX 3050 6GB", "ram": "16GB DDR5", "storage": "1TB NVMe SSD", "display": "16\" 2.8K OLED 120Hz", "price_source_url": "https://www.asus.com/my/laptops/for-creators/vivobook/vivobook-pro-16x-k6604/", "shopee_url": "https://shopee.com.my/search?keyword=VivoBook%20Pro%2016X", "tiktok_url": null, "score": 86, "platform": "NPU", "why": "Outstanding OLED display with creator-focused features.", "scores": { "ai": 7, "thermals": 8, "upgrade": 7, "linux": 8, "portability": 7, "value": 9 } },
        { "brand": "Acer", "model": "Swift X 16 (2024)", "price": 5799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Acer+Swift+X+16", "cpu": "AMD Ryzen 7 8845HS", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB LPDDR5X", "storage": "1TB NVMe SSD", "display": "16\" 2.5K 165Hz", "price_source_url": "https://store.acer.com/en-my/swift/", "shopee_url": "https://shopee.com.my/search?keyword=Acer%20Swift%20X%2016", "tiktok_url": null, "score": 85, "platform": "NPU", "why": "Excellent balance of performance and portability with NPU.", "scores": { "ai": 8, "thermals": 7, "upgrade": 6, "linux": 8, "portability": 8, "value": 8 } },
        { "brand": "Huawei", "model": "MateBook D16 (2024)", "price": 4999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MateBook+D16", "cpu": "Intel Core i7-13700H", "gpu": "Intel Arc A370M", "ram": "16GB LPDDR5", "storage": "1TB NVMe SSD", "display": "16\" 2.5K 60Hz", "price_source_url": "https://consumer.huawei.com/my/laptops/matebook-d-16-2024/", "shopee_url": "https://shopee.com.my/search?keyword=Huawei%20MateBook%20D16", "tiktok_url": null, "score": 85, "platform": "NPU", "why": "Great value with Intel NPU and premium build quality.", "scores": { "ai": 7, "thermals": 8, "upgrade": 5, "linux": 7, "portability": 8, "value": 9 } },
        { "brand": "HP", "model": "Envy x360 (2024)", "price": 4799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=HP+Envy+x360", "cpu": "Intel Core i7-13700H", "gpu": "Intel Arc A370M", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "15.6\" OLED Touch", "price_source_url": "https://www.hp.com/my-en/laptops/envy/envy-x360-15-intel/", "shopee_url": "https://shopee.com.my/search?keyword=HP%20Envy%20x360", "tiktok_url": null, "score": 84, "platform": "NPU", "why": "Versatile 2-in-1 design with excellent OLED display.", "scores": { "ai": 7, "thermals": 7, "upgrade": 6, "linux": 7, "portability": 8, "value": 8 } },
        { "brand": "MSI", "model": "Modern 15 (2024)", "price": 4299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MSI+Modern+15", "cpu": "Intel Core i7-13620H", "gpu": "Intel Arc A350M", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "15.6\" FHD IPS", "price_source_url": "https://my.msi.com/Laptop/Modern-15-B13M/", "shopee_url": "https://shopee.com.my/search?keyword=MSI%20Modern%2015", "tiktok_url": null, "score": 83, "platform": "NPU", "why": "Business-focused laptop with good AI acceleration.", "scores": { "ai": 7, "thermals": 7, "upgrade": 7, "linux": 7, "portability": 8, "value": 8 } },
        { "brand": "Dell", "model": "Inspiron 16 Plus (2024)", "price": 5299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Dell+Inspiron+16", "cpu": "Intel Core i7-13700H", "gpu": "NVIDIA RTX 3050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" 2.5K 120Hz", "price_source_url": "https://www.dell.com/my/p/inspiron-16-plus-laptop/", "shopee_url": "https://shopee.com.my/search?keyword=Dell%20Inspiron%2016%20Plus", "tiktok_url": null, "score": 83, "platform": "CUDA", "why": "Great build quality with good performance for creators.", "scores": { "ai": 7, "thermals": 8, "upgrade": 8, "linux": 8, "portability": 7, "value": 8 } },
        { "brand": "Lenovo", "model": "Yoga 7i (2024)", "price": 5199, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Lenovo+Yoga+7i", "cpu": "Intel Core i7-13700H", "gpu": "Intel Arc A370M", "ram": "16GB LPDDR5X", "storage": "1TB NVMe SSD", "display": "14\" 2.8K OLED Touch", "price_source_url": "https://www.lenovo.com/my/en/laptops/yoga/yoga-7-series/", "shopee_url": "https://shopee.com.my/search?keyword=Lenovo%20Yoga%207i", "tiktok_url": null, "score": 82, "platform": "NPU", "why": "Premium 2-in-1 with excellent OLED display and build.", "scores": { "ai": 7, "thermals": 7, "upgrade": 5, "linux": 8, "portability": 9, "value": 7 } },
        { "brand": "Honor", "model": "MagicBook X16 Pro", "price": 4299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Honor+MagicBook", "cpu": "Intel Core i5-13500H", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5", "storage": "512GB NVMe SSD", "display": "16\" 2.5K IPS", "price_source_url": "https://www.hihonor.com/my/laptops/honor-magicbook-x-16/", "shopee_url": "https://shopee.com.my/search?keyword=Honor%20MagicBook%20X16", "tiktok_url": null, "score": 82, "platform": "NPU", "why": "Great value with good build and display quality.", "scores": { "ai": 6, "thermals": 7, "upgrade": 6, "linux": 7, "portability": 8, "value": 9 } },
        { "brand": "Acer", "model": "Predator Helios Neo 16", "price": 5999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Predator+Helios", "cpu": "Intel Core i7-13700HX", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" WQXGA 165Hz", "price_source_url": "https://store.acer.com/en-my/predator/", "shopee_url": "https://shopee.com.my/search?keyword=Predator%20Helios%20Neo%2016", "tiktok_url": null, "score": 81, "platform": "CUDA", "why": "Strong gaming performance with good cooling system.", "scores": { "ai": 8, "thermals": 8, "upgrade": 7, "linux": 6, "portability": 5, "value": 7 } },
        { "brand": "ASUS", "model": "ProArt Studiobook 16", "price": 6799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ProArt+Studiobook", "cpu": "AMD Ryzen 9 7940HS", "gpu": "NVIDIA RTX 4060 8GB", "ram": "32GB DDR5", "storage": "1TB NVMe SSD", "display": "16\" 3.2K OLED", "price_source_url": "https://www.asus.com/my/laptops/for-creators/proart-studiobook/", "shopee_url": "https://shopee.com.my/search?keyword=ASUS%20ProArt%20Studiobook", "tiktok_url": null, "score": 81, "platform": "CUDA", "why": "Creator-focused with Calman-verified OLED display.", "scores": { "ai": 9, "thermals": 8, "upgrade": 7, "linux": 7, "portability": 6, "value": 7 } },
        { "brand": "Lenovo", "model": "ThinkPad X1 Carbon Gen 11", "price": 6899, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ThinkPad+X1", "cpu": "Intel Core i7-1355U", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5", "storage": "1TB NVMe SSD", "display": "14\" 2.8K OLED", "price_source_url": "https://www.lenovo.com/my/en/p/laptops/thinkpad/thinkpadx1/", "shopee_url": "https://shopee.com.my/search?keyword=ThinkPad%20X1%20Carbon", "tiktok_url": null, "score": 80, "platform": "NPU", "why": "Premium business laptop with excellent build quality.", "scores": { "ai": 6, "thermals": 7, "upgrade": 4, "linux": 10, "portability": 10, "value": 6 } },
        { "brand": "HP", "model": "ZBook Studio G10", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ZBook+Studio", "cpu": "Intel Core i7-13700H", "gpu": "NVIDIA RTX 4050 6GB", "ram": "32GB DDR5", "storage": "1TB NVMe SSD", "display": "16\" 4K OLED", "price_source_url": "https://www.hp.com/my-en/workstations/zbook-studio/", "shopee_url": "https://shopee.com.my/search?keyword=HP%20ZBook%20Studio", "tiktok_url": null, "score": 80, "platform": "CUDA", "why": "Workstation-class performance with stunning display.", "scores": { "ai": 8, "thermals": 7, "upgrade": 6, "linux": 8, "portability": 7, "value": 6 } },
        { "brand": "Framework", "model": "Laptop 16", "price": 5999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Framework+16", "cpu": "AMD Ryzen 7 7840HS", "gpu": "AMD Radeon 780M", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" 2.5K 165Hz", "price_source_url": "https://frame.work/my/en/laptop-16", "shopee_url": null, "tiktok_url": null, "score": 79, "platform": "NPU", "why": "Highly modular and repairable design with good performance.", "scores": { "ai": 7, "thermals": 7, "upgrade": 10, "linux": 9, "portability": 7, "value": 7 } },
        { "brand": "Gigabyte", "model": "G5 KF", "price": 4999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Gigabyte+G5", "cpu": "Intel Core i5-12500H", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR4", "storage": "512GB NVMe SSD", "display": "15.6\" FHD 144Hz", "price_source_url": "https://www.gigabyte.com/my/Laptop/G5--Intel-12th-Gen", "shopee_url": "https://shopee.com.my/search?keyword=Gigabyte%20G5%20KF", "tiktok_url": null, "score": 79, "platform": "CUDA", "why": "Great value gaming laptop with RTX 4060.", "scores": { "ai": 8, "thermals": 7, "upgrade": 8, "linux": 6, "portability": 6, "value": 9 } },
        { "brand": "MSI", "model": "Katana 15", "price": 4899, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MSI+Katana", "cpu": "Intel Core i7-12650H", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "15.6\" FHD 144Hz", "price_source_url": "https://my.msi.com/Laptop/Katana-15-B12V/", "shopee_url": "https://shopee.com.my/search?keyword=MSI%20Katana%2015", "tiktok_url": null, "score": 78, "platform": "CUDA", "why": "Budget-friendly gaming laptop with good performance.", "scores": { "ai": 7, "thermals": 7, "upgrade": 7, "linux": 6, "portability": 6, "value": 8 } },
        { "brand": "Lenovo", "model": "ThinkBook 16p Gen 4", "price": 5799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ThinkBook+16p", "cpu": "AMD Ryzen 7 7840HS", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" 2.5K IPS", "price_source_url": "https://www.lenovo.com/my/en/p/laptops/thinkbook/thinkbook-series/thinkbook-16p-gen-4/", "shopee_url": "https://shopee.com.my/search?keyword=ThinkBook%2016p", "tiktok_url": null, "score": 78, "platform": "NPU", "why": "Business laptop with creator-focused features.", "scores": { "ai": 7, "thermals": 7, "upgrade": 7, "linux": 8, "portability": 6, "value": 7 } },
        { "brand": "ASUS", "model": "ExpertBook B9 OLED", "price": 6799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ExpertBook+B9", "cpu": "Intel Core i7-1355U", "gpu": "Intel Iris Xe", "ram": "32GB LPDDR5", "storage": "2TB NVMe SSD", "display": "14\" 2.8K OLED", "price_source_url": "https://www.asus.com/my/laptops/for-work/expertbook/expertbook-b9-oled-b9403/", "shopee_url": "https://shopee.com.my/search?keyword=ASUS%20ExpertBook%20B9", "tiktok_url": null, "score": 77, "platform": "NPU", "why": "Ultra-lightweight business laptop with great battery life.", "scores": { "ai": 6, "thermals": 7, "upgrade": 3, "linux": 7, "portability": 10, "value": 6 } },
        { "brand": "Acer", "model": "Aspire 7", "price": 3999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Aspire+7", "cpu": "AMD Ryzen 5 7535HS", "gpu": "NVIDIA RTX 3050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "15.6\" FHD IPS", "price_source_url": "https://store.acer.com/en-my/aspire-7-gaming-laptop-a715-43g", "shopee_url": "https://shopee.com.my/search?keyword=Acer%20Aspire%207", "tiktok_url": null, "score": 77, "platform": "CUDA", "why": "Entry-level gaming laptop with good upgrade options.", "scores": { "ai": 6, "thermals": 7, "upgrade": 8, "linux": 7, "portability": 7, "value": 9 } },
        { "brand": "Huawei", "model": "MateBook X Pro", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MateBook+X+Pro", "cpu": "Intel Core i7-1360P", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5", "storage": "1TB NVMe SSD", "display": "14.2\" 3.1K Touch", "price_source_url": "https://consumer.huawei.com/my/laptops/matebook-x-pro-2023/", "shopee_url": "https://shopee.com.my/search?keyword=Huawei%20MateBook%20X%20Pro", "tiktok_url": null, "score": 76, "platform": "NPU", "why": "Premium ultrabook with excellent display and build.", "scores": { "ai": 6, "thermals": 7, "upgrade": 2, "linux": 6, "portability": 9, "value": 6 } },
        { "brand": "Acer", "model": "Swift 5", "price": 5499, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Acer+Swift+5", "cpu": "Intel Core i7-1360P", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5", "storage": "1TB NVMe SSD", "display": "14\" 2.8K OLED", "price_source_url": "https://store.acer.com/en-my/swift-5", "shopee_url": "https://shopee.com.my/search?keyword=Acer%20Swift%205", "tiktok_url": null, "score": 76, "platform": "NPU", "why": "Premium ultraportable with great display.", "scores": { "ai": 6, "thermals": 7, "upgrade": 3, "linux": 7, "portability": 9, "value": 7 } },
        { "brand": "HP", "model": "Pavilion Plus 14", "price": 4299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Pavilion+Plus", "cpu": "AMD Ryzen 7 7840U", "gpu": "AMD Radeon 780M", "ram": "16GB LPDDR5", "storage": "512GB NVMe SSD", "display": "14\" 2.8K OLED", "price_source_url": "https://www.hp.com/my-en/laptops/pavilion/pavilion-plus-14-laptop-pc/", "shopee_url": "https://shopee.com.my/search?keyword=HP%20Pavilion%20Plus%2014", "tiktok_url": null, "score": 75, "platform": "NPU", "why": "Great value with OLED display and good performance.", "scores": { "ai": 7, "thermals": 7, "upgrade": 4, "linux": 7, "portability": 8, "value": 8 } },
        { "brand": "Infinix", "model": "INBOOK X2", "price": 3699, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Infinix+INBOOK", "cpu": "Intel Core i7-1260P", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR4X", "storage": "512GB NVMe SSD", "display": "14\" FHD+ IPS", "price_source_url": "https://my.infinixmobility.com/laptops/inbook/", "shopee_url": "https://shopee.com.my/search?keyword=Infinix%20INBOOK%20X2", "tiktok_url": null, "score": 75, "platform": "NPU", "why": "Budget-friendly with good build and performance.", "scores": { "ai": 6, "thermals": 7, "upgrade": 5, "linux": 7, "portability": 8, "value": 9 } },
        { "brand": "Microsoft", "model": "Surface Laptop 5 15-inch", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Surface+Laptop+5", "cpu": "Intel Core i7-1355U", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5X", "storage": "512GB NVMe SSD", "display": "15\" PixelSense Touch", "price_source_url": "https://www.microsoft.com/en-my/surface/devices/surface-laptop-5", "shopee_url": "https://shopee.com.my/search?keyword=Surface%20Laptop%205", "tiktok_url": null, "score": 75, "platform": "NPU", "why": "Premium build with excellent display and keyboard.", "scores": { "ai": 6, "thermals": 7, "upgrade": 2, "linux": 5, "portability": 8, "value": 7 } }
      ]
    },
    ui: {
      app: {
        price: 7000,
        platform: 'All',
        brand: 'All',
        sort: 'score_desc',
        radarSelection: []
      },
      charts: {
        rankings: null,
        radar: null,
        value: null
      },
      elements: {}
    },
    config: {
      chartFont: { family: "'Share Tech Mono', monospace", size: 12 },
      platformColors: {
        CUDA: 'text-[#00F0FF]',
        NPU: 'text-[#D83F87]',
        Mac: 'text-gray-400'
      },
      platformColorMap: {
        CUDA: 'rgba(0, 240, 255, 0.7)',
        NPU: 'rgba(216, 63, 135, 0.7)',
        Mac: 'rgba(168, 178, 204, 0.7)'
      }
    },
    affiliate: {
      SHOPEE_AFFILIATE_ID: self.SHOPEE_AFFILIATE_ID || null,
      LAZADA_AFFILIATE_ID: self.LAZADA_AFFILIATE_ID || null,
      TIKTOK_AFFILIATE_ID: self.TIKTOK_AFFILIATE_ID || null,
      INVOLVE_ASIA_ID: self.INVOLVE_ASIA_ID || null
    }
  };

  // Small util (global) ------------------------------------------------------
  function escapeHTML(s){ return String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

  // Toast utility -----------------------------------------------------------
  const Toast = (()=>{
    const container = document.getElementById('toast-container');
    const icons = { success:'’Ž', error:'š ï¸', info:'„¹ï¸' };
    function show({ title='', message='', variant='info', duration=5200 }={}){
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = `toast toast-${variant}`;
      toast.innerHTML = `
        <span class="toast-icon">${icons[variant]||icons.info}</span>
        <div><strong>${escapeHTML(title)}</strong>${message ? `<p>${escapeHTML(message)}</p>`:''}</div>
        <button class="toast-close" aria-label="Dismiss">œ•</button>`;
      container.appendChild(toast);
      const close = ()=>{
        toast.classList.add('out');
        setTimeout(()=> toast.remove(), 220);
      };
      toast.querySelector('.toast-close')?.addEventListener('click', close);
      if (duration > 0) setTimeout(close, duration);
      return close;
    }
    return { show };
  })();

  // --- Data Validation Functions ---------------------------------------------
  const validateLaptopData = (laptop, index) => {
    // Required fields validation
    const requiredFields = ['brand', 'model', 'price', 'cpu', 'gpu', 'ram', 'storage', 'display', 'score', 'platform', 'why', 'scores'];
    requiredFields.forEach(field => {
      console.assert(Object.prototype.hasOwnProperty.call(laptop, field), 
        `Laptop at index ${index} missing required field: ${field}`);
    });

    // Type validations
    console.assert(typeof laptop.price === 'number', `Laptop ${laptop.model}: price must be a number`);
    console.assert(typeof laptop.score === 'number', `Laptop ${laptop.model}: score must be a number`);
    console.assert(['CUDA', 'NPU', 'Mac'].includes(laptop.platform), 
      `Laptop ${laptop.model}: invalid platform ${laptop.platform}`);

    // Value range validations
    console.assert(laptop.price >= 3500 && laptop.price <= 7000, 
      `Laptop ${laptop.model}: price ${laptop.price} outside valid range (3500-7000)`);
    console.assert(laptop.score >= 0 && laptop.score <= 100, 
      `Laptop ${laptop.model}: score ${laptop.score} outside valid range (0-100)`);

    // Scores object validation
    const requiredScores = ['ai', 'thermals', 'upgrade', 'linux', 'portability', 'value'];
    requiredScores.forEach(score => {
      console.assert(Object.prototype.hasOwnProperty.call(laptop.scores, score), 
        `Laptop ${laptop.model} missing required score: ${score}`);
      console.assert(typeof laptop.scores[score] === 'number', 
        `Laptop ${laptop.model}: score ${score} must be a number`);
      console.assert(laptop.scores[score] >= 0 && laptop.scores[score] <= 10, 
        `Laptop ${laptop.model}: score ${score} outside valid range (0-10)`);
    });

    // URL validations
    console.assert(laptop.price_source_url && typeof laptop.price_source_url === 'string', 
      `Laptop ${laptop.model}: invalid price_source_url`);
    console.assert(!laptop.tiktok_url || typeof laptop.tiktok_url === 'string', 
      `Laptop ${laptop.model}: invalid tiktok_url format`);
    console.assert(!laptop.shopee_url || typeof laptop.shopee_url === 'string', 
      `Laptop ${laptop.model}: invalid shopee_url format`);
  };

  // Validate the entire fallback dataset
  const validateFallbackData = () => {
    console.assert(Array.isArray(STATE.data.fallbackLaptops), 
      'fallbackLaptops must be an array');
    console.assert(STATE.data.fallbackLaptops.length >= 20,
      `Expected at least 20 laptops in fallback data, got ${STATE.data.fallbackLaptops.length}`);
    
    STATE.data.fallbackLaptops.forEach((laptop, index) => {
      validateLaptopData(laptop, index);
    });

    // Verify unique models
    const models = new Set(STATE.data.fallbackLaptops.map(l => l.model));
    console.assert(models.size === STATE.data.fallbackLaptops.length, 
      'Duplicate laptop models found in fallback data');

    // Verify score distribution
    const scores = STATE.data.fallbackLaptops.map(l => l.score).sort((a, b) => b - a);
    console.assert(scores[0] <= 100, 'Maximum score exceeds 100');
    console.assert(scores[scores.length - 1] >= 70, 'Minimum score below 70');
    
    console.log('œ… Fallback data validation complete');
  };

  // Run validation on initialization
  validateFallbackData();

  // --- API & DATA MODULE ----------------------------------------------------
  // Prompt builder (Kaa-Ching VAB persona + all Toolkit tasks)
function buildPrompts(task, payload) {
  const persona = KAACHING_VAB;

  let systemPrompt = `${persona}
General rules:
- Use Markdown with ### headings and concise bullets.
- Be decisive; say WHY (price, thermals/TGP, upgrades, ecosystem).
- Assume the user wants best value and minimum headaches.`;

  let userPrompt = `Context:\n${JSON.stringify(payload || {}, null, 2)}`;
  let generationConfig = { responseMimeType: "text/markdown" };

  switch (task) {
    case 'findMatch':
      systemPrompt = `${persona}
Task: From the provided laptop list, pick ONE best match for the criteria.
Output:
### Recommendation
- **Model:** €¦
- **Price:** €¦
- **Why:** 3€“5 bullets (thermals, CUDA/NPU fit, portability, value)
### Alternatives (optional)
- 1€“2 models with one-line why`;
      userPrompt =
`Criteria:
- Budget: ${payload?.criteria?.budget}
- Main Use: ${payload?.criteria?.usecase}
- Portability: ${payload?.criteria?.portability}

Laptops JSON:
${JSON.stringify(payload?.laptops || [], null, 2)}`;
      break;

    case 'compareLaptops':
      systemPrompt = `${persona}
Task: Compare the selected laptops side-by-side.
Output:
### TL;DR
- One-line verdict (who should buy which)
### Model A vs B (and C)
- Strengths
- Weaknesses
- Best for
### Final Call
- Pick per persona (student dev / creator / gamer / mobile coder)`;
      userPrompt = `Compare these:\n${JSON.stringify(payload?.laptops || [], null, 2)}`;
      break;

    case 'getFutureIntel':
      systemPrompt = `${persona}
Return **JSON** only with key "intelligence": [{title, summary, verdict} x3].
Keep summary one sentence; verdict ONE WORD: SOLID/WAIT/HYPE.`;
      generationConfig.responseMimeType = "application/json";
      userPrompt = "Top 3 consumer-relevant tech updates in Malaysia right now.";
      break;

    // Toolkit tools
    case 'deal-assassin':
      systemPrompt = `${persona}
Task: Find where the named product usually has the **best value** in MY (official vs Shopee/TikTok/etc). Consider warranty, street price, promos.
Output:
### Best Deal Now
- Store/Platform + Why (price, warranty, returns)
- Target price to aim
### Negotiation/Buying Tips
- 3€“5 bullets
### Alternatives @ Similar Price (optional)`;
      userPrompt = `Product: ${payload?.query || ""}`;
      break;

    case 'upgrade-strategist':
      systemPrompt = `${persona}
Task: Create a pragmatic upgrade plan for the chosen base laptop and goal (e.g., 13B LLM local).
Output:
### Plan
- RAM/storage targets
- Thermals (cooling pad, repaste?)
- OS/driver notes (CUDA/NPU stacks)
### Shopping List
- Exact SKUs/spec hints + expected MYR`;
      userPrompt = `Base laptop: ${payload?.laptop}\nGoal: ${payload?.goal}\nLaptop JSON: ${JSON.stringify(payload?.laptopData || {}, null, 2)}`;
      break;

    case 'dream-rig-architect':
      systemPrompt = `${persona}
Task: Spec the best rig under budget for the stated use (dev/AI/creator/gaming).
Output:
### Build/Buy Call
- Laptop vs desktop (and why)
### Spec
- CPU, GPU/NPU, RAM, storage, display
### Why This Wins in MY
- 3€“5 bullets`;
      userPrompt = `Budget (MYR): ${payload?.budget}\nUse: ${payload?.use}`;
      break;

    case 'elite-procurement':
      systemPrompt = `${persona}
Task: Suggest concrete leads in Malaysia (retailers, niche stores, import tips).
Output:
### Where to Look
- 3€“6 leads
### Risk & Warranty Notes
### ETA / Odds`;
      userPrompt = `Rare item: ${payload?.item}`;
      break;

    case 'component-recon':
      systemPrompt = `${persona}
Task: Explain a component€™s positioning, performance tier, and compatibility.
Output:
### What It Is
### Real-World Performance
### Pairing/Compatibility
### Watch-outs`;
      userPrompt = `Component: ${payload?.component || payload?.query || ""}`;
      break;

    case 'performance-forecaster':
      systemPrompt = `${persona}
Task: Forecast performance of the laptop on a named app/workload (e.g., SDXL, Llama.cpp).
Output:
### Expected Performance
- Ballpark metrics (it/s, min vRAM/RAM) + bottlenecks
### Tweaks
- Drivers, flags, quantization, runtime tips
### Confidence
- High/Med/Low`;
      userPrompt = `Laptop: ${payload?.laptop}\nApp: ${payload?.app}\nLaptop JSON: ${JSON.stringify(payload?.laptopData || {}, null, 2)}`;
      break;

    case 'system-integrity':
      systemPrompt = `${persona}
Task: Diagnose the issue and give a clean runbook.
Output:
### Likely Root Causes
### Fix Steps (ordered)
### Verification
### Prevention`;
      userPrompt = `Issue: ${payload?.issue || payload?.query || ""}`;
      break;

    case 'ecosystem-architect':
      systemPrompt = `${persona}
Task: Recommend the best ecosystem fit (Apple/Samsung/Windows mix).
Output:
### Fit
- What to keep/add
### Why
- Handoff/Continuity/Phone-PC bridge
### Settings to Enable`;
      userPrompt = `Current devices: ${payload?.devices || payload?.query || ""}`;
      break;

    case 'longevity-analyst':
      systemPrompt = `${persona}
Task: Estimate usable lifespan and likely upgrade/replace windows.
Output:
### Lifespan
### Failure Risk / Parts
### Upgrade Path
### Replace When€¦`;
      userPrompt = `Laptop: ${payload?.laptop}\nLaptop JSON: ${JSON.stringify(payload?.laptopData || {}, null, 2)}`;
      break;

    case 'asset-value':
      systemPrompt = `${persona}
Task: Forecast resale value range in Malaysia for the model/condition.
Output:
### Today€™s Range (MYR)
### 6€“12 Month Trend
### How to Maximize Value`;
      userPrompt = `Laptop: ${payload?.laptop}\nCondition: ${payload?.condition || "Good"}`;
      break;

    case 'field-support':
      systemPrompt = `${persona}
Task: Provide a crisp, step-wise answer to the tech support query.
Output:
### Do This
1. €¦
2. €¦
### Why It Works
### If That Fails`;
      userPrompt = `Question: ${payload?.query || ""}`;
      break;
  }

  return { systemPrompt, userPrompt, generationConfig };
}

  // --- STORAGE UTILITIES (localStorage guards) -------------------------------
  const StorageUtil = {
    safeGet(key, fallback = "") {
      try {
        return localStorage.getItem(key) || fallback;
      } catch {
        console.warn(`localStorage.getItem("${key}") failed (private mode?)`);
        return fallback;
      }
    },
    safeSet(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch {
        console.warn(`localStorage.setItem("${key}") failed`);
        return false;
      }
    },
    safeRemove(key) {
      try {
        localStorage.removeItem(key);
      } catch {
        console.warn(`localStorage.removeItem("${key}") failed`);
      }
    }
  };

  // --- UTILITIES (global within IIFE) ---------------------------------------
  // Tiny SWR cache (stores JSON-serializable values)
  const SWR = {
    get(key, ttlMs) {
      try {
        const raw = localStorage.getItem(`swr:${key}`);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj.t !== 'number') return null;
        if (ttlMs && Date.now() - obj.t > ttlMs) return null;
        return obj.v;
      } catch { return null; }
    },
    set(key, val) {
      try { localStorage.setItem(`swr:${key}`, JSON.stringify({ t: Date.now(), v: val })); } catch {}
    }
  };

  // Debounce helper
  function debounce(fn, wait = 250) {
    let t;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  // Asia/Kuala_Lumpur timestamp for stamping outputs
  function nowMY() {
    try { return new Date().toLocaleString('en-MY', { timeZone: 'Asia/Kuala_Lumpur', hour12: false }); }
    catch { return new Date().toISOString(); }
  }

  // Smooth auto-height transition for reply containers
  function animateInto(el, renderFn) {
    if (!el) { renderFn?.(); return; }
    // Skip height animation for the modal deck root to avoid any clipping
    if (el.id === 'ai-deck-root') { renderFn?.(); return; }
    el.classList.add('reply-wrap');
    const prev = el.scrollHeight;
    el.style.maxHeight = prev + 'px';
    renderFn?.();
    const next = el.scrollHeight;
    requestAnimationFrame(() => {
      el.style.maxHeight = next + 'px';
      const tidy = () => { el.style.maxHeight = ''; el.removeEventListener('transitionend', tidy); };
      el.addEventListener('transitionend', tidy);
      setTimeout(tidy, 320);
    });
  }

  function setPersonaStatus(message, tone = 'info') {
    const el = document.getElementById('ai-hero-copy');
    if (!el) return;
    if (typeof message === 'string') el.textContent = message;
    if (tone) el.dataset.tone = tone;
  }

  // Per-task logical controllers (for cancel/teardown)
  const CONTROLLERS = new Map();

  // Tiny web search wrapper via Netlify function (graceful fallback)
  async function getWebSnippets(query) {
    try {
      const params = new URLSearchParams(location.search);
      const isNetlify = document.documentElement.dataset.netlify === '1' || /\.netlify\.app$/.test(location.hostname);
      const allow = isNetlify || params.get('web') === '1';
      if (!allow) return [];
      const q = String(query||'').slice(0,500);
      const cacheKey = 'web:' + q.slice(0,128);
      const cached = SWR.get(cacheKey, 10*60*1000);
      if (cached) return cached;
      const res = await fetch('/.netlify/functions/websearch', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ q }) });
      if (!res.ok) return [];
      const j = await res.json().catch(()=>({ items: [] }));
      const items = Array.isArray(j.items) ? j.items.slice(0,8) : [];
      SWR.set(cacheKey, items);
      return items;
    } catch { return []; }
  }

  // Modal Deck controller (lazy bind + focus trap)
  const ModalDeck = (() => {
    let lastFocus = null; let bound = false; let minimized = false; let aabound = false;
    function els(){
      return {
        backdrop: document.getElementById('ai-modal-backdrop'),
        modal: document.getElementById('ai-modal'),
        sheet: document.querySelector('.ai-modal-sheet'),
        closeBtn: document.getElementById('ai-close'),
        minBtn: document.getElementById('ai-minimize'),
        dots: document.getElementById('ai-deck-dots'),
        root: document.getElementById('ai-deck-root'),
        asof: document.getElementById('ai-asof'),
        textTrigger: document.getElementById('textsize-trigger'),
        aaMenu: document.getElementById('ai-aa-menu'),

        dock: document.getElementById('ai-dock'),
        dockBtn: document.getElementById('ai-dock-btn'),
        dockText: document.getElementById('ai-dock-text')
      };  function getStoredSize(){
    try { const v = localStorage.getItem('aiDeckTextSize'); return ['sm','md','lg'].includes(v) ? v : 'md'; } catch { return 'md'; }
  }
  function applyTextSize(sheet, size, { persist = true, announce = false } = {}){
    const TEXT_SIZES = ['sm','md','lg'];
    if (!sheet) return;
    if (!TEXT_SIZES.includes(size)) size = 'md';
    TEXT_SIZES.forEach(s => sheet.classList.remove(i-deck--text-));
    sheet.classList.add(i-deck--text-);
    try { if (persist) localStorage.setItem('aiDeckTextSize', size); } catch {}
    const { aaMenu } = els();
    if (aaMenu) aaMenu.querySelectorAll('.ai-deck__aa-btn').forEach(btn => btn.setAttribute('aria-checked', btn.dataset.aaSize === size ? 'true' : 'false'));
    if (announce && new URLSearchParams(location.search).get('metrics') === '1') console.info('[deck] textSize', size);
  }function bindAa(){
    if (aabound) return; aabound = true;
    const { textTrigger, aaMenu, sheet } = els(); if (!textTrigger || !aaMenu || !sheet) return;
    const closeMenu = () => { aaMenu.style.display='none'; aaMenu.setAttribute('aria-expanded','false'); textTrigger.setAttribute('aria-expanded','false'); };
    applyTextSize(sheet, getStoredSize(), { persist:false });
    closeMenu();
    textTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      const expanded = aaMenu.getAttribute('aria-expanded') === 'true';
      if (expanded) { closeMenu(); return; }
      aaMenu.style.display = 'flex';
      aaMenu.setAttribute('aria-expanded', 'true');
      textTrigger.setAttribute('aria-expanded', 'true');
    });
    aaMenu.querySelectorAll('.ai-deck__aa-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        applyTextSize(sheet, btn.dataset.aaSize, { announce: true });
        closeMenu();
        try { textTrigger.focus({ preventScroll: true }); } catch {}
      });
    });
    window.addEventListener('click', (e) => { if (!aaMenu.contains(e.target) && e.target !== textTrigger) closeMenu(); }, { capture:true });
  }
  function trapFocus(sheet){
      const FOCUSABLE = 'a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])';
      function handler(e){
        if (e.key !== 'Tab') return;
        const nodes = Array.from(sheet.querySelectorAll(FOCUSABLE)).filter(n => !n.hasAttribute('disabled') && n.offsetParent !== null);
        if (!nodes.length) return;
        const first = nodes[0], last = nodes[nodes.length-1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
      sheet.addEventListener('keydown', handler);
      return () => sheet.removeEventListener('keydown', handler);
    }
    let untrap = null;
    function bindOnce(){ if (bound) return; const { backdrop, modal, sheet, closeBtn, minBtn, dockBtn } = els(); if (!backdrop||!modal||!sheet) return; bound = true;
      backdrop.addEventListener('click', close);
      closeBtn?.addEventListener('click', close);
      minBtn?.addEventListener('click', minimize);
      dockBtn?.addEventListener('click', restore);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.getAttribute('aria-hidden')==='false') close(); });
    }
    function open(){
      bindOnce(); const { backdrop, modal, sheet } = els(); if (!backdrop||!modal||!sheet) return;
      lastFocus = document.activeElement;
      backdrop.style.pointerEvents = 'auto'; modal.style.pointerEvents = 'auto';
      backdrop.style.opacity = '1';
      sheet.style.opacity = '1'; sheet.style.transform = 'translateY(0) scale(1)';
      document.body.style.overflow = 'hidden';
      // Remove inert AFTER visibility to prevent focus warning
      requestAnimationFrame(()=>{
        sheet.removeAttribute('inert');
        untrap?.(); untrap = trapFocus(sheet);
        applyTextSize(sheet, getStoredSize(), { persist:false });
        bindAa();
        setTimeout(()=> sheet.focus({ preventScroll: true }), 0);
      });
      setPersonaStatus('AI Bradaa is crunching the playbook for you.', 'info');
      minimized = false; const { dock } = els(); if (dock) { dock.style.display='none'; }
    }
    function close(){
      const { backdrop, modal, sheet, root, dots, aaMenu } = els(); if (!backdrop||!modal||!sheet) return;
      const active = document.activeElement; if (sheet.contains(active)) { try { active.blur(); } catch {} }
      untrap?.(); untrap=null;
      sheet.setAttribute('inert','');
      backdrop.style.opacity = '0'; sheet.style.opacity = '0'; sheet.style.transform = 'translateY(12px) scale(.98)';
      setTimeout(()=>{
        backdrop.style.pointerEvents = 'none'; modal.style.pointerEvents = 'none';
        document.body.style.overflow = '';
        window.ReplyModalDeck?.destroy?.(root);
        if (root) root.innerHTML = ''; if (dots) dots.innerHTML='';
        if (aaMenu) { aaMenu.style.display = 'none'; aaMenu.setAttribute('aria-expanded','false'); }
        const sticky = document.getElementById('ai-sticky-head');
        if (sticky) { sticky.hidden = true; const t = sticky.querySelector('.ai-sticky-title'); const m = sticky.querySelector('.ai-sticky-meta'); if (t) t.textContent=''; if (m) m.textContent=''; }
        if (lastFocus) lastFocus.focus();
      }, 180);
      setPersonaStatus('AI Bradaa is standing by.', 'info');
    }
    function minimize(){ const { backdrop, modal, sheet, dock, dockText, dockBtn, aaMenu } = els(); if (!modal||!sheet||!dock||!backdrop) return; minimized = true; 
      // fade out visually
      backdrop.style.opacity = '0'; sheet.style.opacity = '0'; sheet.style.transform = 'translateY(12px) scale(.98)';
      // immediately disable interactions
      backdrop.style.pointerEvents='none'; modal.style.pointerEvents='none';
      // move focus out before hiding
      const activeMin = document.activeElement; if (sheet.contains(activeMin)) { try { activeMin.blur(); } catch {} }
      untrap?.(); untrap=null;
      // accessibility states
      sheet.setAttribute('inert','');
      document.body.style.overflow='';
      if (aaMenu) { aaMenu.style.display='none'; aaMenu.setAttribute('aria-expanded','false'); }
      // dock visible
      dock.style.display='block'; dock.classList.remove('pulse'); if (dockText) dockText.textContent = 'AI Bradaa €¢ working€¦'; try{ dockBtn?.focus(); }catch{} }
    function restore(){ const { dock } = els(); dock && (dock.style.display='none'); open(); }
    function notifyComplete(){ const { dock } = els(); if (!dock) return; setPersonaStatus('Intel ready €” deploy the Ka-Ching move.', 'success'); if (minimized) { dock.style.display='block'; dock.classList.add('pulse'); } }
    return { open, close, minimize, restore, notifyComplete };
  })();

  // Text size popover (Aa) €” persisted via html[data-enlarged]
  (function textSizeToggle(){
    function apply(v){ document.documentElement.dataset.enlarged = v ? '1':'0'; try { localStorage.setItem('ui_enlarged', v?'1':'0'); } catch {} }
    // Only apply persisted value globally; event wiring happens inside ModalDeck.bindAa()
    try { apply((localStorage.getItem('ui_enlarged')||'0')==='1'); } catch {}
  })();

  // --- API MODULE -----------------------------------------------------------
  const API_MODULE = {
    // Schedule a refresh at KL midnight +5 minutes
    _scheduleMidnightKL() {
      try { clearTimeout(window.__marketMidnightTimer); } catch {}
      const now = Date.now();
      const tzOffsetMs = 8 * 60 * 60 * 1000; // KL = UTC+8
      const tKl = now + tzOffsetMs;
      const dayMs = 24 * 60 * 60 * 1000;
      const since = ((tKl % dayMs) + dayMs) % dayMs;
      const msToMidnight = dayMs - since + 5 * 60 * 1000; // +5min buffer
      window.__marketMidnightTimer = setTimeout(async () => {
        try {
          const res = await fetch('data/laptops.json');
          if (res.ok) {
            const data = await res.json();
            SWR.set('laptops', data);
            STATE.data.allLaptops = data;
            const filtered = (typeof computeFilteredLaptops === 'function') ? computeFilteredLaptops() : (data||[]);
            UI_MODULE?.renderAll?.(filtered);
            console.info('[market] data refreshed (KL midnight)');
          }
        } catch {}
        // reschedule next day
        API_MODULE._scheduleMidnightKL();
      }, msToMidnight);
      console.info('[market] KL midnight +5min refresh scheduled');
    },
    async fetchMarketIntel() {
      try {
        const TTL = 3 * 60 * 60 * 1000; // 3h
        const cacheKey = 'laptops';
        const cached = SWR.get(cacheKey, TTL);
        if (cached) {
          STATE.data.allLaptops = cached;
        } else {
          const response = await fetch('data/laptops.json');
          if (!response.ok) throw new Error('Local JSON not found.');
          const data = await response.json();
          STATE.data.allLaptops = data;
          SWR.set(cacheKey, data);
        }
        // schedule silent refresh in TTL
        try {
          clearTimeout(window.__marketRefreshTimer);
        } catch {}
        window.__marketRefreshTimer = setTimeout(async ()=>{
  try {
    const r = await window.GeminiClient.callGemini({ systemText: systemPrompt, userText: fastPrompt + "\n\nUser Input:\n" + userPrompt, json:false, temperature:0.4, timeoutMs:15000 });
    if (ctrl.aborted) return; fastDone=true;
    ModalDeck.open();
    const root = document.getElementById('ai-deck-root'); const dots = document.getElementById('ai-deck-dots'); const asof = document.getElementById('ai-asof');
    if (asof) asof.textContent = `as of ${nowMY()} (Asia/Kuala_Lumpur)`;
    if (root) { root.setAttribute('tabindex','0'); animateInto(root, ()=>{ root.innerHTML=''; window.ReplyModalDeck?.render(root, r.text||'### TL;DR\nWorking', { dotsEl: dots, stickyHeadEl: document.getElementById('ai-sticky-head') }); }
    if (metrics) console.info('[metrics] t_fastTLDR', Math.round(performance.now()-t0));
  } catch {}
})();
        }

        // Call AI €” Deep lane (existing logic)
        let structuredRetried = false;
        const strictInstruction = "\n\nReturn EXACT sections: TL;DR, Recommendation, Why, Next Steps, Alternatives (‰¤2), Risks; ‰¤5 bullets/section; keep Kaa-Ching tone; MYR.";
        try {
          const first = await window.GeminiClient.callGemini({ systemText: systemPrompt, userText: groundedUserPrompt, json: isJsonMode, temperature: 0.7 });
          if (ctrl.aborted) return; // stale
          let text = first.text || '';

          // Structure-enforcement retry (text mode only)
          if (!isJsonMode && !/^###\s/m.test(text)) {
            structuredRetried = true;
            const second = await window.GeminiClient.callGemini({ systemText: systemPrompt, userText: text + strictInstruction, json: false, temperature: 0.7 });
            if (ctrl.aborted) return;
            text = second.text || text;
          }

          if (task === 'getFutureIntel') {
            try {
              const intelData = JSON.parse(text);
              if (!intelData.intelligence) throw new Error('no-intel');
              onIntelSuccess?.(intelData.intelligence);
              SWR.set(swrKey, intelData.intelligence);
            } catch (parseErr) {
              onIntelFallback?.(text);
            }
            return;
          }

          if (outputElement) {
            ModalDeck.open();
            const root = document.getElementById('ai-deck-root'); const dots = document.getElementById('ai-deck-dots'); const asof = document.getElementById('ai-asof');
            if (asof) asof.textContent = `as of ${nowMY()} (Asia/Kuala_Lumpur)`;
            if (root) { root.setAttribute('tabindex','0'); animateInto(root, ()=>{ root.innerHTML=''; window.ReplyModalDeck?.render(root, text || '### TL;DR\\nWorking', { dotsEl: dots, stickyHeadEl: document.getElementById('ai-sticky-head') }); }); }
            deepDone=true; if (metrics) console.info('[metrics] t_deepReady', Math.round(performance.now()-t0));}
        } catch (err) {
          const errMsg = String(err?.message || err);
          const renderErr = (html) => {
            if (outputElement){
              animateInto(outputElement, () => {
                outputElement.innerHTML = html;
                outputElement.classList.add('gemini-output');
                outputElement.querySelector('[data-ai-retry]')?.addEventListener('click', () => {
                  outputElement.innerHTML = '<div class="text-xs opacity-70">Retrying€¦</div>';
                  ctrl.abort();
                  API_MODULE.callAIAgent(task, payload, outputElement, callbacks);
                }); }
            // Deck AI error rendering
            ModalDeck.open();
            const root = document.getElementById('ai-deck-root');
            const dots = document.getElementById('ai-deck-dots');
            if (root) {
              root.setAttribute('tabindex','0');
              animateInto(root, () => {
                root.innerHTML = `
                  <section class="ai-slide" role="group" aria-label="AI error">
                    <div class="ai-slide-shell">
                      <div class="ai-slide-header">
                        <span class="ai-badge pink">š ï¸ Error</span>
                        <span class="ai-slide-pill">Deck AI Notice</span>
                      </div>
                      <div class="ai-body" style="display:flex; flex-direction:column; align-items:flex-start; justify-content:center; min-height:180px;">${html}</div>
                      <div class="ai-slide-footer">
                        <span class="ai-slide-spark">š¡</span>
                        <span>Check connection or API key</span>
                      </div>
                    </div>
                  </section>`;
                root.querySelector('[data-ai-retry]')?.addEventListener('click', () => {
                  API_MODULE.callAIAgent(task, payload, outputElement, callbacks);
                });
              });
              if (dots) dots.innerHTML = '';
            }
            try { ModalDeck.setPersonaStatus('Deck AI encountered an error.', 'alert'); } catch {}
          };
          if (errMsg.includes('NO_API_KEY')) { renderErr(`
            <div style="text-align:center; padding:1rem;">
              <p style="color:#FF6F91; font-weight:700; font-size:1.1rem; margin-bottom:0.75rem; text-shadow: 0 0 10px rgba(255,111,145,.3);">” API Key Required</p>
              <p style="font-size:0.875rem; margin-bottom:0.75rem; opacity:0.85;">AI Bradaa needs a Gemini API key to work.</p>
              <div style="background:rgba(0,240,255,.08); border:1px solid rgba(0,240,255,.25); border-radius:0.5rem; padding:0.75rem; margin:1rem 0;">
                <p style="font-size:0.8rem; margin-bottom:0.5rem; color:rgba(0,240,255,.9); font-weight:600;">Open Dev Console & Run:</p>
                <code style="display:block; background:rgba(1,4,9,.9); padding:0.6rem; font-size:0.7rem; border-radius:0.375rem; overflow-wrap:break-word; border:1px solid rgba(0,240,255,.2); font-family:monospace; color:#00F0FF;">localStorage.setItem('GEMINI_API_KEY','YOUR_KEY');</code>
              </div>
              <p style="font-size:0.75rem; opacity:0.65; margin-top:0.75rem;">Get your free key at <strong style="color:#00F0FF;">ai.google.dev</strong></p>
            </div>`); return; }
          if (errMsg.includes('HTTP_400')) { if (task==='getFutureIntel'){ onIntelFallback?.('Parsing error.'); return; } renderErr(`<div style="text-align:center; padding:1rem;"><p style="color:#FF6F91; font-weight:600; margin-bottom:0.5rem;">Invalid Request</p><p style="font-size:0.85rem; opacity:0.8;">The request payload is malformed.</p></div>`); return; }
          if (errMsg.includes('HTTP_401') || errMsg.includes('HTTP_403')) { renderErr(`<div style="text-align:center; padding:1rem;"><p style="color:#FF6F91; font-weight:600; margin-bottom:0.5rem;">”’ Access Denied</p><p style="font-size:0.85rem; opacity:0.8; margin-bottom:0.75rem;">API key is invalid or restricted.</p><p style="font-size:0.75rem; opacity:0.65;">Verify your key at <strong style="color:#00F0FF;">ai.google.dev</strong></p></div>`); return; }
          if (errMsg.includes('HTTP_429') || errMsg.includes('HTTP_5')) { renderErr(`<div style="text-align:center; padding:1rem;"><p style="color:#FF6F91; font-weight:600; margin-bottom:0.5rem;">±ï¸ Server Overloaded</p><p style="font-size:0.85rem; opacity:0.8; margin-bottom:1rem;">Quota limit reached or server is busy.</p><button style="padding:0.6rem 1.2rem; border:1px solid rgba(0,240,255,.4); border-radius:0.5rem; font-size:0.8rem; font-weight:600; cursor:pointer; background:linear-gradient(135deg, rgba(0,240,255,.2), rgba(0,240,255,.08)); color:#00F0FF; transition: all 180ms ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,240,255,.25)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';" data-ai-retry>š¡ Retry Now</button></div>`); return; }
          renderErr(`<div style="text-align:center; padding:1rem;"><p style="color:#FF6F91; font-weight:600; margin-bottom:0.5rem;">Œ Connection Issue</p><p style="font-size:0.85rem; opacity:0.8; margin-bottom:1rem;">Network is unstable or unreachable.</p><button style="padding:0.6rem 1.2rem; border:1px solid rgba(0,240,255,.4); border-radius:0.5rem; font-size:0.8rem; font-weight:600; cursor:pointer; background:linear-gradient(135deg, rgba(0,240,255,.2), rgba(0,240,255,.08)); color:#00F0FF; transition: all 180ms ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,240,255,.25)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';" data-ai-retry>š¡ Retry Now</button></div>`);
        }
      }
  };

  // --- UI MODULE -----------------------------------------------------------
  // Subtle focus glow refresh on main output panes
  function highlightResults(){
    try {
      const containers = ['#matchmaker-output', '#gemini-comparison-output', '#toolkit-output'];
      containers.forEach(sel=>{
        const el = document.querySelector(sel);
        if (!el) return;
        el.classList.remove('flash-highlight');
        void el.offsetWidth; // reflow
        el.classList.add('flash-highlight');
        setTimeout(()=> el.classList.remove('flash-highlight'), 800);
      });
    } catch {}
  }

  // Psychological micro-copy cue
  function sentimentCue(message){
    if (!message) return;
    const hero = document.querySelector('#matchmaker-output');
    if (!hero) return;
    hero.dataset.cue = message;
    hero.setAttribute('aria-label', `Status: ${message}`);
  }
  const UI_MODULE = {
    configureCharts() {
      if (!window.Chart) return;
      Chart.defaults.color = '#E6EDF3';
      Chart.defaults.font = STATE.config.chartFont;
      Chart.defaults.borderColor = 'rgba(168,178,204,0.25)';
      Chart.defaults.animation = false;
      Chart.defaults.responsive = true;
      Chart.defaults.maintainAspectRatio = false;
    },

    renderAll(data) {
      renderAppendicesList(data);
      renderCharts(data);
      highlightResults();
    }
  };

  //* ---------- SAFETY KIT (no UI/UX changes): define required functions so init runs ---------- */

// Compute filter results from current UI state
function computeFilteredLaptops() {
  const { price, platform, brand, sort } = STATE.ui.app;
  const src = (STATE?.data?.allLaptops?.length ? STATE.data.allLaptops : STATE.data.fallbackLaptops) || [];
  const withValue = src.map(l => ({ ...l, value_rating: (l.score * 100) / l.price }));

  let list = withValue.filter(x => x.price <= price);
  if (platform && platform !== 'All') list = list.filter(x => x.platform === platform);
  if (brand && brand !== 'All') list = list.filter(x => x.brand === brand);

  switch (sort) {
    case 'price_asc':  list.sort((a,b)=>a.price-b.price); break;
    case 'price_desc': list.sort((a,b)=>b.price-a.price); break;
    case 'value_desc': list.sort((a,b)=>(b.score/b.price)-(a.score/a.price)); break;
    default:           list.sort((a,b)=>b.score-a.score);
  }
  return list;
}

/**
 * Render Appendices List with deep cards, spec table, and localStorage actions
 * @param {Array} data - Filtered laptop list
 */
function renderAppendicesList(data) {
  const el = document.getElementById('laptop-list-container');
  if (!el) return;
  if (!data?.length) { el.innerHTML = '<p class="text-center xl:col-span-3">No data.</p>'; return; }

  // Load saved state from localStorage
  const saved = JSON.parse(StorageUtil.safeGet('saves', '[]'));
  const alertsRaw = StorageUtil.safeGet('alerts', '[]');
  let alertsMap = {};
  try {
    if ((alertsRaw||'').trim().startsWith('{')) alertsMap = JSON.parse(alertsRaw);
    else (JSON.parse(alertsRaw)||[]).forEach(a=>{ if(a&&a.model) alertsMap[`${a.brand? (a.brand+" ") : ''}${a.model}`.trim()] = { alertRM:a.target, savedAt: a.created? new Date(a.created).toISOString(): new Date().toISOString() }; });
  } catch { alertsMap = {}; }

  el.innerHTML = data.map(l => {
    const valueRating = Math.round((l.score / l.price) * 10000) / 100;
    const isSaved = saved.includes(l.model);
    const alertId = `${l.brand} ${l.model}`.trim();
const existingAlert = alertsMap[alertId];
const q = (window.Marketplaces && window.Marketplaces.modelString) ? window.Marketplaces.modelString(l) : `${l.brand} ${l.model}`;
const shopeeHref = (window.Marketplaces && l.shopee_url && window.Marketplaces.isValidUrl(l.shopee_url)) ? l.shopee_url : (window.Marketplaces ? window.Marketplaces.shopeeSearch(q) : '#');
const priceHref  = (window.Marketplaces && l.price_source_url && window.Marketplaces.isValidUrl(l.price_source_url)) ? l.price_source_url : (window.Marketplaces ? window.Marketplaces.lazadaSearch(q) : '#');
const tiktokHref = (window.Marketplaces && l.tiktok_url && window.Marketplaces.isValidUrl(l.tiktok_url)) ? l.tiktok_url : (window.Marketplaces ? window.Marketplaces.tiktokSearch(q) : '#');
const buy = [
  `<a class="underline hover:text-[var(--c-accent-cyan)]" target="_blank" href="${priceHref}">”— Price Source</a>`,
  `<a class="underline hover:text-[var(--c-accent-cyan)]" target="_blank" href="${shopeeHref}">›’ Shopee</a>`,
  `<a class="underline hover:text-[var(--c-accent-cyan)]" target="_blank" href="${tiktokHref}">“± TikTok</a>`
].join(' €¢ ');

    return `
    <div class="p-4 bg-[var(--c-bg)] rounded-lg border border-[var(--c-border)] hover:border-[var(--c-accent-cyan)] transition-colors" style="line-height:1.75;">
      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3">
        <h3 class="text-base sm:text-lg md:text-xl font-bold">${l.brand} ${l.model}</h3>
        <span class="text-lg sm:text-xl md:text-2xl font-bold text-[var(--c-accent-pink)]">RM${(l.price||0).toLocaleString()}</span>
      </div>

      <!-- Badges -->
      <div class="flex flex-wrap gap-2 mb-3 text-xs">
        <span class="px-2 py-1 rounded ${l.platform === 'CUDA' ? 'bg-[var(--c-accent-cyan)]' : l.platform === 'NPU' ? 'bg-[var(--c-accent-pink)]' : 'bg-gray-600'} text-white font-semibold">${l.platform}</span>
        <span class="px-2 py-1 rounded bg-[var(--c-border)] text-[var(--c-text-primary)]">Score: ${l.score}</span>
        <span class="px-2 py-1 rounded bg-[var(--c-border)] text-[var(--c-text-primary)]">Value: ${valueRating}</span>
      </div>

      <!-- Progressive disclosure -->
      <details class="mt-3">
        <summary class="cursor-pointer text-[var(--c-accent-cyan)] font-semibold">“‹ Specs, Actions & Links</summary>
        
        <div class="mt-4 space-y-4">
          <!-- Spec Table -->
          <table class="w-full text-sm border-collapse">
            <tr><td class="py-1 pr-2 opacity-70">CPU:</td><td class="py-1 font-medium">${l.cpu}</td></tr>
            <tr><td class="py-1 pr-2 opacity-70">GPU:</td><td class="py-1 font-medium">${l.gpu}</td></tr>
            <tr><td class="py-1 pr-2 opacity-70">RAM:</td><td class="py-1 font-medium">${l.ram}</td></tr>
            <tr><td class="py-1 pr-2 opacity-70">Storage:</td><td class="py-1 font-medium">${l.storage}</td></tr>
            <tr><td class="py-1 pr-2 opacity-70">Display:</td><td class="py-1 font-medium">${l.display}</td></tr>
          </table>

          <!-- Actions -->
          <div class="space-y-2">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" class="compare-checkbox" data-model="${l.model}">
              <span class="text-sm">Compare (add to radar chart)</span>
            </label>
            
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" class="save-checkbox" data-model="${l.model}" ${isSaved ? 'checked' : ''}>
              <span class="text-sm">Save for later</span>
            </label>
            
            <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-center">
              <label class="text-sm whitespace-nowrap">Price alert (RM):</label>
              <input type="number" class="alert-input flex-1 h-8 px-2 py-1 text-sm bg-[var(--c-glass)] border border-[var(--c-border)] rounded" 
                     data-model="${l.model}" data-brand="${l.brand}"
                     placeholder="${l.price - 500}" 
                     value="${existingAlert?.alertRM || ''}">
              <button type="button" class="alert-save h-8 px-3 py-1 text-xs bg-[var(--c-accent-pink)] rounded shrink-0" data-model="${l.model}" data-brand="${l.brand}">Save</button>
            </div>
          </div>

          <!-- External Links -->
          <div class="pt-3 border-t border-[var(--c-border)] text-sm">
            ${buy || '<span class="opacity-70">No external links available</span>'}
          </div>
        </div>
      </details>
    </div>`;
  }).join('');

  // Attach event handlers (c4: localStorage integration)
  attachAppendicesHandlers();
}

/**
 * Attach event handlers for Appendices actions (c4)
 */
function attachAppendicesHandlers() {
  const container = document.getElementById('laptop-list-container');
  if (!container) return;

  const alertTimers = {};
// Compare checkboxes †’ update radar
  container.querySelectorAll('.compare-checkbox').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const model = e.target.dataset.model;
      const sel = STATE.ui.app.radarSelection;
      
      if (e.target.checked) {
        if (sel.length < 3 && !sel.includes(model)) {
          sel.push(model);
          // Update chip in Versus section
          const chip = document.querySelector(`button[data-model="${model}"]`);
          if (chip) chip.classList.add('active');
        } else if (sel.length >= 3) {
          e.target.checked = false;
          alert('Maximum 3 laptops for comparison');
        }
      } else {
        const idx = sel.indexOf(model);
        if (idx >= 0) {
          sel.splice(idx, 1);
          const chip = document.querySelector(`button[data-model="${model}"]`);
          if (chip) chip.classList.remove('active');
        }
      }
      
      UI_MODULE.renderRadarChart();
    });
  });

  // Save for later †’ localStorage
  container.querySelectorAll('.save-checkbox').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const model = e.target.dataset.model;
      const saved = JSON.parse(StorageUtil.safeGet('saves', '[]'));
      
      if (e.target.checked) {
        if (!saved.includes(model)) {
          saved.push(model);
          StorageUtil.safeSet('saves', JSON.stringify(saved));
        }
      } else {
        const idx = saved.indexOf(model);
        if (idx >= 0) {
          saved.splice(idx, 1);
          StorageUtil.safeSet('saves', JSON.stringify(saved));
        }
      }
    });
  });

  // Price alert †’ localStorage
  container.querySelectorAll('.alert-save').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const model = e.target.dataset.model;
    const brand = e.target.dataset.brand;
    const id = `${brand} ${model}`.trim();
    const input = container.querySelector(`.alert-input[data-model="${model}"][data-brand="${brand}"]`);
    const target = parseFloat(input.value);
    if (!target || target <= 0) { alert('Enter a valid target price'); return; }
    e.target.textContent = 'Saving...';
    clearTimeout(alertTimers[id]);
    alertTimers[id] = setTimeout(() => {
      let map = {};
      const raw = StorageUtil.safeGet('alerts', '{}');
      try { map = JSON.parse(raw) || {}; } catch { map = {}; }
      map[id] = { alertRM: target, savedAt: new Date().toISOString() };
      StorageUtil.safeSet('alerts', JSON.stringify(map));
      e.target.textContent = 'œ“ Saved';
      setTimeout(() => { e.target.textContent = 'Save'; }, 1200);
    }, 300);
  });
});

// Settings modal wiring ------------------------------------------------------
function hydrateSettingsPanel(){
  const trigger = document.getElementById('settings-trigger');
  const panel = document.getElementById('settings-panel');
  const modal = document.getElementById('settings-modal');
  if (!trigger || !panel || !modal) return;
  const closeBtn = document.getElementById('settings-close');
  const cancelBtn = document.getElementById('settings-cancel');
  const saveBtn = document.getElementById('settings-save');
  const backdrop = document.getElementById('settings-backdrop');
  const sourceInput = document.getElementById('settings-source');
  const statusEl = document.getElementById('settings-status');
  const lastRunEl = document.getElementById('settings-last-run');

  // hydrate values
  try { sourceInput.value = localStorage.getItem('LAPTOPS_SOURCE_URL') || ''; } catch {}
  try {
    const last = Number(localStorage.getItem('weekly:last')||0);
    if (last) lastRunEl.textContent = `Last refresh: ${new Date(last).toLocaleString('en-MY', { timeZone: 'Asia/Kuala_Lumpur' })}`;
  } catch {}

  function showStatus(text, variant='info'){
    if (!statusEl) return; statusEl.hidden = false; statusEl.dataset.variant = variant; statusEl.textContent = text;
  }
  function open(){ panel.setAttribute('aria-hidden','false'); modal.focus({ preventScroll:true }); }
  function close(){ panel.setAttribute('aria-hidden','true'); trigger.focus(); if (statusEl){ statusEl.hidden=true; statusEl.textContent=''; } }

  trigger.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  cancelBtn?.addEventListener('click', close);
  backdrop?.addEventListener('click', close);
  panel.addEventListener('keydown', (e)=>{ if (e.key==='Escape') { e.stopPropagation(); close(); } });

  saveBtn?.addEventListener('click', async ()=>{
    const url = (sourceInput.value||'').trim();
    if (url && !/^https?:\/\//i.test(url)) { showStatus('URL must start with https://', 'error'); sourceInput.focus(); return; }
    try {
      if (url) {
        localStorage.setItem('LAPTOPS_SOURCE_URL', url);
        showStatus('Saving€¦ fetching latest data.', 'info');
        Toast.show({ title:'Weekly source updated', message:'Pulling fresh laptops now.', variant:'success' });
        await API_MODULE.refreshWeekly();
      } else {
        localStorage.removeItem('LAPTOPS_SOURCE_URL');
        showStatus('Cleared custom source. Using core 35-list.', 'success');
        Toast.show({ title:'Custom source removed', message:'Reverting to built-in intelligence.', variant:'info' });
      }
      const last = Number(localStorage.getItem('weekly:last')||0);
      if (last) lastRunEl.textContent = `Last refresh: ${new Date(last).toLocaleString('en-MY', { timeZone: 'Asia/Kuala_Lumpur' })}`;
      setTimeout(close, 700);
    } catch (err) {
      showStatus('Failed to refresh source. Check console.', 'error');
      Toast.show({ title:'Weekly fetch error', message:String(err?.message||err), variant:'error' });
    }
  });
}
}

// Charts (rankings bar + value scatter)
function renderCharts(data) {
  if (!window.Chart) return;

  // Rankings bar (horizontal)
  const c1 = document.getElementById('rankingsChart');
  if (c1) {
    const top = [...data].slice(0, 10);
    const labels = top.map(x => `${x.brand} ${x.model}` );
    const scores = top.map(x => x.score);
    const opts = {
      indexAxis: 'y',
      maintainAspectRatio: false,
      scales: {
        x: { grid: { color: 'rgba(168,178,204,0.15)' }, ticks: { color: '#A8B2CC' } },
        y: { grid: { color: 'rgba(168,178,204,0.15)' }, ticks: { color: '#E6EDF3', font: { size: 11 } } }
      },
      plugins: { legend: { labels: { color: '#E6EDF3' } } }
    };
    if (STATE.ui.charts.rankings) {
      STATE.ui.charts.rankings.data.labels = labels;
      STATE.ui.charts.rankings.data.datasets[0].data = scores;
      STATE.ui.charts.rankings.update();
    } else {
      STATE.ui.charts.rankings = new Chart(c1, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Score', data: scores, backgroundColor: 'rgba(0,240,255,0.45)' }] },
        options: { ...opts, animation: false }
      });
    }
  }

  // Value scatter (price vs score)
  const c2 = document.getElementById('valueChart');
  if (c2) {
    const pts = data.map(l => ({ x: l.price, y: l.score, _p: l.platform }));
    const colors = pts.map(p => STATE.config.platformColorMap[p._p] || 'rgba(168,178,204,0.7)');
    const opts = {
      maintainAspectRatio: false,
      scales: {
        x: { title: { display: true, text: 'Price (MYR)' }, grid: { color: 'rgba(168,178,204,0.15)' }, ticks: { color: '#A8B2CC' } },
        y: { title: { display: true, text: 'Score' }, grid: { color: 'rgba(168,178,204,0.15)' }, ticks: { color: '#E6EDF3' } }
      },
      plugins: { legend: { labels: { color: '#E6EDF3' } } }
    };
    if (STATE.ui.charts.value) {
      STATE.ui.charts.value.data.datasets[0].data = pts;
      STATE.ui.charts.value.data.datasets[0].pointBackgroundColor = colors;
      STATE.ui.charts.value.update();
    } else {
      STATE.ui.charts.value = new Chart(c2, {
        type: 'scatter',
        data: { datasets: [{ label: 'Laptops', data: pts, parsing: false, pointRadius: 4, borderWidth: 0, pointBackgroundColor: colors }] },
        options: { ...opts, animation: false }
      });
    }
  }
}

// Brand dropdown
UI_MODULE.populateBrandFilter = function () {
  const sel = document.getElementById('brand-filter');
  if (!sel) return;
  const src = (STATE?.data?.allLaptops?.length ? STATE.data.allLaptops : STATE.data.fallbackLaptops) || [];
  const brands = [...new Set(src.map(x => x.brand))].sort();
  sel.innerHTML = '<option value="All" selected>All Brands</option>' +
    brands.map(b => `<option value="${b}">${b}</option>`).join('');
};

// Laptop selector (for Radar)
UI_MODULE.populateLaptopSelector = function () {
  const box = document.getElementById('laptop-selector-container');
  if (!box) return;
  const src = (STATE?.data?.allLaptops?.length ? STATE.data.allLaptops : STATE.data.fallbackLaptops) || [];
  const top = src.slice(0, 30);
  box.innerHTML = top.map((l) =>
    `<button class="px-2 py-1 border border-[var(--c-border)] rounded text-xs"
             data-model="${l.model}">
       ${l.brand} ${l.model}
     </button>`).join('');

  box.addEventListener('click', (e) => {
    const b = e.target.closest('button[data-model]');
    if (!b) return;
    const model = b.getAttribute('data-model');
    const sel = STATE.ui.app.radarSelection;
    const i = sel.indexOf(model);
    if (i >= 0) { sel.splice(i, 1); b.classList.remove('active'); }
    else if (sel.length < 3) { sel.push(model); b.classList.add('active'); }
    UI_MODULE.renderRadarChart();
  });
};

// Radar chart
UI_MODULE.renderRadarChart = function () {
  const canvas = document.getElementById('radarChart');
  if (!canvas || !window.Chart) return;

  const src = (STATE?.data?.allLaptops?.length ? STATE.data.allLaptops : STATE.data.fallbackLaptops) || [];
  const byModel = new Map(src.map(l => [l.model, l]));
  const labels = ['ai','thermals','upgrade','linux','portability','value'];
  const models = STATE.ui.app.radarSelection;

  const palette = [
    { bg:'rgba(0,240,255,0.32)', br:'rgba(0,240,255,0.9)' },
    { bg:'rgba(216,63,135,0.32)', br:'rgba(216,63,135,0.9)' },
    { bg:'rgba(255,215,0,0.35)', br:'rgba(255,215,0,0.9)' }
  ];

  const ds = models.map((m, i) => {
    const l = byModel.get(m);
    if (!l) return null;
    const p = palette[i%palette.length];
    return {
      label: `${l.brand} ${l.model}` ,
      data: labels.map(k => l.scores[k]),
      fill: true, backgroundColor: p.bg, borderColor: p.br, pointBackgroundColor: p.br, borderWidth: 2
    };
  }).filter(Boolean);
  if (!ds.length) return;

  const opts = {
    maintainAspectRatio: false,
    scales: {
      r: {
        suggestedMin: 0, suggestedMax: 10,
        angleLines: { color: 'rgba(168,178,204,0.2)' },
        grid: { color: 'rgba(168,178,204,0.2)' },
        pointLabels: { color: '#E6EDF3', font: { size: 12 } },
        ticks: { display: false }
      }
    },
    plugins: { legend: { position: 'bottom', labels: { color: '#E6EDF3' } } }
  };

  if (STATE.ui.charts.radar) {
    STATE.ui.charts.radar.data.labels = labels;
    STATE.ui.charts.radar.data.datasets = ds;
    STATE.ui.charts.radar.options = opts;
    STATE.ui.charts.radar.update();
  } else {
    STATE.ui.charts.radar = new Chart(canvas, { type: 'radar', data: { labels, datasets: ds }, options: { ...opts, animation: false } });
  }

  if (models.length >= 2) {
    const selected = models.map(m => byModel.get(m)).filter(Boolean);
    const out = document.getElementById('gemini-comparison-output');
    API_MODULE.callAIAgent('compareLaptops', { laptops: selected }, out);
  }
};

// Toolkit console (personalized per tool) €” commit c3
const TOOLKIT_UI = {
  'deal-assassin': {
    badge: 'Deal Assassin ”Ž',
    cta: 'Hunt Deal',
    placeholder: 'Example: RTX 4060 laptop under RM5500, 1TB SSD',
    prefill: 'Budget: RM5500\nPriority: Thermals & CUDA\nNotes: 16GB RAM OK, prefer 1TB storage',
    tips: [
      'Check street price vs RRP (retail price)',
      'Prioritize TGP (Total Graphics Power) over boost clocks',
      'Warranty ‰¥ 2y or on-site preferred for MY'
    ]
  },
  'upgrade-strategist': {
    badge: 'Upgrade Strategist š¡',
    cta: 'Plan Upgrade',
    placeholder: 'Base laptop + goal (e.g., IdeaPad Pro 5 €” run Llama 3 8B)',
    prefill: 'Current: IdeaPad Pro 5 16AHP9\nGoal: Run Llama 3 8B locally\nBudget for upgrades: RM800',
    tips: [
      'RAM: 32GB DDR5 for LLMs (check max supported)',
      'Cooling: repaste + cooling pad for sustained loads',
      'OS: WSL2 or dual-boot Linux for CUDA stacks'
    ]
  },
  'dream-rig-architect': {
    badge: 'Dream Rig Architect Ž¯',
    cta: 'Spec Rig',
    placeholder: 'Budget + use (e.g., RM6,500 for AI coding + video)',
    prefill: 'Budget: RM6500\nUse: AI coding (Cursor), light video (1080p60)\nPreference: Portability > raw power',
    tips: [
      'Laptop vs desktop: portability tax ~20-30% in MY',
      'NPU worth it if coding on battery often',
      'Display: 120Hz+ for smooth scrolling in IDE'
    ]
  },
  'elite-procurement': {
    badge: 'Elite Procurement Ž–ï¸',
    cta: 'Source Item',
    placeholder: 'Rare/limited item in MY (e.g., Zephyrus G14 AniMe)',
    prefill: 'Item: Zephyrus G14 (2024) with AniMe Matrix\nRegion: Klang Valley\nTimeline: 2-4 weeks OK',
    tips: [
      'Check parallel imports (warranty risk vs savings)',
      'Pre-orders: ASUS/Lenovo Malaysia official stores',
      'Gray market: Lowyat, FB groups (verify seller)'
    ]
  },
  'component-recon': {
    badge: 'Component Recon ”¬',
    cta: 'Analyze',
    placeholder: 'Component (e.g., RTX 4060 8GB laptop vs 7600S)',
    prefill: 'Compare: RTX 4060 8GB (laptop, 140W TGP) vs Radeon 7600S\nWorkload: Stable Diffusion SDXL',
    tips: [
      'Laptop GPUs: check TGP (115W€“140W for 4060)',
      'CUDA vs ROCm: 4060 wins for ML/AI workflows',
      'VRAM: 8GB minimum for SDXL (6GB tight)'
    ]
  },
  'performance-forecaster': {
    badge: 'Performance Forecaster “Š',
    cta: 'Forecast',
    placeholder: 'Laptop + workload (e.g., Swift X 16 €” SDXL)',
    prefill: 'Laptop: Acer Swift X 16 (Ryzen 7 8845HS, RTX 4050 6GB)\nApp: Stable Diffusion SDXL (512x512)\nSettings: FP16, xformers',
    tips: [
      'It/s (iterations/sec): ~1.2€“1.8 it/s for 4050',
      'Bottleneck: VRAM (6GB tight, use --lowvram)',
      'Driver: CUDA 12.x + PyTorch 2.x stable'
    ]
  },
  'system-integrity': {
    badge: 'System Integrity ›¡ï¸',
    cta: 'Diagnose',
    placeholder: 'Problem (e.g., Chart.js axes not visible on dark)',
    prefill: 'Issue: Chart.js axes/labels invisible on #010409 background\nBrowser: Chrome 120\nChart version: 4.x from CDN',
    tips: [
      'Chart.defaults.color = "#E6EDF3" (light on dark)',
      'Grid colors: rgba(168,178,204,0.15) for subtle',
      'Test: inspect canvas †’ check computed styles'
    ]
  },
  'ecosystem-architect': {
    badge: 'Ecosystem Architect Œ',
    cta: 'Optimize Flow',
    placeholder: 'Devices (e.g., iPhone + Windows laptop + Buds)',
    prefill: 'Current: iPhone 14, Legion Slim 5 (Windows), Galaxy Buds 2 Pro\nPain: No seamless handoff, files via WhatsApp',
    tips: [
      'Phone Link (Windows): clipboard + SMS sync',
      'iCloud for Windows: photos/files (but slow)',
      'Continuity: consider Mac if deep in Apple'
    ]
  },
  'longevity-analyst': {
    badge: 'Longevity Analyst ³',
    cta: 'Forecast Lifespan',
    placeholder: 'Model + horizon (e.g., G5 KF €” 3€“4 years?)',
    prefill: 'Laptop: Gigabyte G5 KF (i5-12500H, RTX 4060)\nHorizon: 3€“4 years\nUse: Gaming + coding',
    tips: [
      'CPU/GPU: 4060 good till 2027 for 1080p gaming',
      'RAM: 16GB †’ upgrade to 32GB by year 2',
      'Failure risk: hinge, battery (replace ~RM300)'
    ]
  },
  'asset-value': {
    badge: 'Asset Value ’°',
    cta: 'Estimate Value',
    placeholder: 'Model + condition (e.g., Zenbook 14 OLED €” Good)',
    prefill: 'Model: ASUS Zenbook 14 OLED (UX3405, i7-1355U)\nCondition: Good (minor scratches)\nAge: 18 months',
    tips: [
      'Depreciation: ~30% year 1, ~20% year 2 in MY',
      'OLED premium holds value (+10% vs IPS)',
      'Maximize: original box, warranty transferable'
    ]
  },
  'field-support': {
    badge: 'Field Support †˜',
    cta: 'Get Help',
    placeholder: 'Ask a specific support question',
    prefill: 'Question: How to enable NPU in Windows 11 for local AI?\nLaptop: IdeaPad Pro 5 16AHP9 (Ryzen 7 8845HS)',
    tips: [
      'NPU: check Device Manager †’ Neural Processors',
      'Drivers: AMD Software Adrenalin latest',
      'Test: Windows Studio Effects (webcam blur)'
    ]
  }
};

/**
 * Render Toolkit Console with personalized UX per tool
 * @param {string} tool - Tool ID (e.g., 'deal-assassin')
 */
UI_MODULE.renderToolkitConsole = function (tool = 'deal-assassin') {
  const cfg = TOOLKIT_UI[tool] || { 
    badge: tool, 
    cta: 'Run', 
    placeholder: 'Type your question€¦', 
    prefill: '', 
    tips: [] 
  };
  const el = document.getElementById('toolkit-console');
  if (!el) return;

  const tipsHtml = cfg.tips.length 
    ? `<ul class="text-xs space-y-1 opacity-80">${cfg.tips.map(t => `<li>€¢ ${t}</li>`).join('')}</ul>`
    : '';

  el.innerHTML = `
    <div class="console-animating space-y-3">
      <div class="flex items-center justify-between">
        <span class="text-lg font-semibold text-[var(--c-accent-cyan)]">${cfg.badge}</span>
        ${cfg.prefill ? `<button id="toolkit-use-sample" class="text-xs underline opacity-70 hover:opacity-100">Use sample</button>` : ''}
      </div>
      ${tipsHtml}
      <textarea id="toolkit-input" class="w-full h-28 text-sm" placeholder="${cfg.placeholder}"></textarea>
      <button id="toolkit-run" class="action-button self-start">${cfg.cta}</button>
      <div id="toolkit-output" class="gemini-output text-sm mt-3"></div>
    </div>`;

  if (cfg.prefill) {
    el.querySelector('#toolkit-use-sample')?.addEventListener('click', () => {
      el.querySelector('#toolkit-input').value = cfg.prefill;
    });
  }

  el.querySelector('#toolkit-run').addEventListener('click', debounce(() => {
    const query = el.querySelector('#toolkit-input').value || cfg.placeholder;
    API_MODULE.callAIAgent(tool, { query }, el.querySelector('#toolkit-output'));
  }, 250));
};

// Wire UI events
function registerEventHandlers({ ui, callAIAgent, computeFiltered }) {
  // price
  document.getElementById('price-filter')?.addEventListener('input', debounce((e) => {
    STATE.ui.app.price = +e.target.value;
    const pv = document.getElementById('price-value'); if (pv) pv.textContent = e.target.value;
    ui.renderAll(computeFiltered());
    sentimentCue('Price target locked. Let€™s hunt value.');
  }, 250));

  // platform buttons
  document.querySelectorAll('.platform-filter').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.platform-filter').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      STATE.ui.app.platform = btn.dataset.platform;
      ui.renderAll(computeFiltered());
      sentimentCue(btn.dataset.platform === 'All' ? 'Wide net. Kaa-Ching radar engaged.' : `${btn.dataset.platform} arsenal primed.`);
    });
  });

  // brand + sort selects
  document.getElementById('brand-filter')?.addEventListener('change', (e) => {
    STATE.ui.app.brand = e.target.value; ui.renderAll(computeFiltered());
    sentimentCue(e.target.value === 'All' ? 'All brands, full intelligence.' : `${e.target.value} focus locked.`);
  });
  document.getElementById('sort-filter')?.addEventListener('change', (e) => {
    STATE.ui.app.sort = e.target.value; ui.renderAll(computeFiltered());
    sentimentCue('Sorted for maximum clarity.');
  });

  // matchmaker
  document.getElementById('find-match-btn')?.addEventListener('click', debounce(() => {
    const payload = {
      criteria: {
        budget: document.getElementById('match-budget')?.value,
        usecase: document.getElementById('match-usecase')?.value,
        portability: document.getElementById('match-portability')?.value
      },
      laptops: computeFiltered()
    };
    callAIAgent('findMatch', payload, document.getElementById('matchmaker-output'));
  }, 250));

  // toolkit menu
  document.querySelectorAll('.tool-selector-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tool-selector-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      UI_MODULE.renderToolkitConsole(btn.dataset.tool);
    }); }

// Intel cards update
UI_MODULE.updateIntelUI = function (items = []) {
  [0,1,2].forEach(i => {
    const d = items[i]; if (!d) return;
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    set(`intel-${i}-title`, d.title || '');
    set(`intel-${i}-summary`, d.summary || '');
    set(`intel-${i}-verdict`, d.verdict || '');
  });
};

UI_MODULE.updateIntelUIWithRawText = function (text = '') {
  const el = document.getElementById('intel-0-summary'); if (el) el.textContent = text;
};
/* ---------- END SAFETY KIT ---------- */


  // --- NETLIFY DETECTION & PWA (c6) -----------------------------------------
  /**
   * Detect if running on Netlify by checking x-nf-request-id header
   * @returns {Promise<boolean>}
   */
  async function detectNetlify() {
    try {
      const res = await fetch(location.pathname, { 
        method: "HEAD", 
        cache: "no-store" 
      });
      return !!res.headers.get("x-nf-request-id");
    } catch {
      return false;
    }
  }

  // --- APP CONTROLLER & INITIALIZATION --------------------------------------
const APP = {
  async initialize() {

    // Initialize Enhanced UI toggle (c5)
    const uiEnhanced = StorageUtil.safeGet('ui_enhanced', '0');
    document.documentElement.dataset.enhancedUi = uiEnhanced;
    
    const btnNormal = document.getElementById('ui-normal');
    const btnLarge = document.getElementById('ui-large');
    
    if (uiEnhanced === '1') {
      btnNormal?.classList.remove('active');
      btnLarge?.classList.add('active');
    }
    // Hide toggle if user previously chose a setting
    const toggleBox = document.querySelector('.ui-toggle');
    if (StorageUtil.safeGet('ui_toggle_hidden', '0') === '1') toggleBox?.classList.add('hidden');

    btnNormal?.addEventListener('click', () => {
      document.documentElement.dataset.enhancedUi = '0';
      StorageUtil.safeSet('ui_enhanced', '0');
      btnNormal.classList.add('active');
      btnLarge.classList.remove('active');
      StorageUtil.safeSet('ui_toggle_hidden','1');
      toggleBox?.classList.add('hidden');
    });
    
    btnLarge?.addEventListener('click', () => {
      document.documentElement.dataset.enhancedUi = '1';
      StorageUtil.safeSet('ui_enhanced', '1');
      btnLarge.classList.add('active');
      btnNormal.classList.remove('active');
      StorageUtil.safeSet('ui_toggle_hidden','1');
      toggleBox?.classList.add('hidden');
    });

    UI_MODULE.configureCharts();
    // load archive from localStorage (if any)
    try { STATE.data.archiveLaptops = JSON.parse(localStorage.getItem('laptops:archive')||'[]'); } catch { STATE.data.archiveLaptops = []; }
    await API_MODULE.fetchMarketIntel();
    // weekly refresh pipeline (requires localStorage.LAPTOPS_SOURCE_URL)
    API_MODULE.refreshWeekly();
    // Settings modal interactions
    try { hydrateSettingsPanel(); } catch {}
    
    // Fallback data warning (MED-003)
    const usingFallback = !STATE.data.allLaptops || !STATE.data.allLaptops.length;
    if (usingFallback) {
      STATE.data.allLaptops = STATE.data.fallbackLaptops;
      // Add subtle badge to header
      const header = document.querySelector('header p');
      if (header) {
        header.innerHTML += ' <span class="text-xs opacity-60">(Data: fallback)</span>';
      }
    }

    STATE.data.allLaptops.forEach(laptop => {
      laptop.value_rating = (laptop.score * 100) / laptop.price;
    });

    STATE.data.sortedByRank = [...STATE.data.allLaptops]
      .sort((a, b) => b.score - a.score)
      .map((item, index) => ({ ...item, rank: index + 1 }));

    UI_MODULE.populateBrandFilter();
    UI_MODULE.populateLaptopSelector();

    const filtered = computeFilteredLaptops();
    UI_MODULE.renderAll(filtered);
    UI_MODULE.renderRadarChart();
    UI_MODULE.renderToolkitConsole('deal-assassin');

    registerEventHandlers({
      ui: UI_MODULE,
      callAIAgent: API_MODULE.callAIAgent,
      computeFiltered: computeFilteredLaptops
    });

    API_MODULE.callAIAgent('getFutureIntel', {}, null, {
      onIntelSuccess: UI_MODULE.updateIntelUI,
      onIntelFallback: UI_MODULE.updateIntelUIWithRawText
    });

    // Register Service Worker only on Netlify + HTTPS (c6: PWA gated)
    if ('serviceWorker' in navigator) {
      const isNetlify = await detectNetlify();
      const isHTTPS = location.protocol === 'https:';
      
      if (isNetlify && isHTTPS) {
        try {
          const reg = await navigator.serviceWorker.register('/service-worker.js');
          console.log('œ… Service Worker registered:', reg.scope);
          document.documentElement.dataset.netlify = '1';
          
          // Auto-enable Enhanced UI on mobile when on Netlify
          if (window.innerWidth <= 640 && uiEnhanced === '0') {
            document.documentElement.dataset.enhancedUi = '1';
            StorageUtil.safeSet('ui_enhanced', '1');
            btnLarge?.classList.add('active');
            btnNormal?.classList.remove('active');
          }
        } catch (error) {
          console.warn('SW registration failed:', error);
        }
      } else {
        console.log('SW skipped (localhost or non-Netlify)');
      }
    }
  }
};
  
document.addEventListener('DOMContentLoaded', () => {
  APP.initialize().then(() => {
    // Dev micro-tests (enable with ?dev=1)
    if (new URLSearchParams(location.search).get('dev') === '1') {
      try {
        // Parser snapshot test
        const tmp = document.createElement('div');
        tmp.style.position='fixed'; tmp.style.left='-9999px'; tmp.style.top='-9999px';
        document.body.appendChild(tmp);
        const md = '### TL;DR\nA\n\n### Recommendation\nB\n\n### Risks\nC';
        const deck = window.ReplyDeck?.render(tmp, md, { asOf: 'test' });
        if (deck?.count === 3) console.log('œ… DevTest: Parser snapshot OK (3 slides)'); else console.warn('Œ DevTest: Parser snapshot failed', deck?.count);
        window.ReplyDeck?.destroy(tmp); document.body.removeChild(tmp);

        // Height transition test
        const hc = document.createElement('div'); hc.className='reply-wrap'; document.body.appendChild(hc);
        const shortMd = '### TL;DR\nshort';
        animateInto(hc, ()=>{ hc.innerHTML=''; window.ReplyDeck?.render(hc, shortMd, { asOf: 't' }); });
        const before = hc.scrollHeight;
        const longMd = '### TL;DR\nshort\n\n### Recommendation\nline1\nline2\nline3\nline4\n\n### Risks\nX';
        animateInto(hc, ()=>{ hc.innerHTML=''; window.ReplyDeck?.render(hc, longMd, { asOf: 't' }); });
        setTimeout(()=>{
          const after = hc.scrollHeight; console.log('œ… DevTest: Height transition', { before, after, delta: after-before });
          window.ReplyDeck?.destroy(hc); document.body.removeChild(hc);
        }, 300);
      } catch (e) { console.warn('Dev tests errored', e); }
    }
  }); })();
</script>
  <!-- Modal containers for Reply Modal Deck -->
  <div id="ai-modal-backdrop"></div>
  <div id="ai-modal" style="pointer-events:none;">
    <div class="ai-deck-shell">
      <div class="ai-modal-sheet" role="dialog" aria-modal="true" aria-labelledby="ai-modal-title" tabindex="-1" inert>
        <div class="ai-modal-header">
          <div class="ai-modal-title-wrap">
            <div id="ai-modal-title" class="ai-modal-title text-[var(--c-accent-cyan)]">AI Bradaa</div>
            <span class="ai-modal-tagline">Strategist Mode €¢ Powered by Kaa-Ching!</span>
            <div class="ai-progress-bar" aria-hidden="true"></div>
            <div id="ai-hero-copy" class="ai-hero-copy" role="status" aria-live="polite">AI Bradaa is crunching the playbook for you.</div>
          </div>
          <div class="flex items-center gap-2">
            <button id="ai-minimize" class="ai-close" aria-label="Minimize">Min</button>
            <div class="ai-aa-wrapper">
              <button id="textsize-trigger" class="ai-close" aria-haspopup="true" aria-expanded="false" title="Text size" data-ai-deck-aa>Aa</button>
              <div class="ai-deck__aa-menu" id="ai-aa-menu" role="menu" aria-expanded="false">
                <button class="ai-deck__aa-btn" type="button" role="menuitemradio" data-aa-size="sm" aria-checked="false">A-</button>
                <button class="ai-deck__aa-btn" type="button" role="menuitemradio" data-aa-size="md" aria-checked="false">A</button>
                <button class="ai-deck__aa-btn" type="button" role="menuitemradio" data-aa-size="lg" aria-checked="false">A+</button>
              </div>
            </div>
            <button id="ai-close" class="ai-close" aria-label="Close">Close</button>
          </div>
        </div>
        <div class="ai-modal-body">
          <div class="ai-modal-scroll" id="ai-modal-scroll">
            <div id="ai-sticky-head" class="ai-sticky-head" hidden>
              <div class="ai-sticky-title">AI Bradaa Recommendation</div>
              <div class="ai-sticky-meta"></div>
            </div>
            <div id="ai-deck-root" class="ai-deck" tabindex="0" aria-roledescription="carousel" aria-label="AI Bradaa response"></div>
            <div id="ai-deck-dots" class="ai-dots" role="tablist"></div>
          </div>
        </div>
        <div class="ai-modal-footer">
          <div id="ai-asof" class="ai-footer-asof text-xs opacity-70"></div>
          <div id="ai-live" class="sr-only" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom-right dock for minimized modal / completion notify -->
  <div id="ai-dock">
    <button id="ai-dock-btn" class="ai-dock-bubble" aria-label="Open AI Bradaa panel">
      <img src="/icons/ai-bradaa.svg" alt="">
      <span id="ai-dock-text" class="text-sm opacity-80">AI Bradaa</span>
    </button>
  </div>

</body>
</html>














