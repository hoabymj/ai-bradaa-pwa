<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  base-uri 'self';
  form-action 'self';
  img-src 'self' data: blob: https:;
  font-src 'self' https://fonts.gstatic.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net;
  connect-src 'self' https://generativelanguage.googleapis.com;
  ">
    <title>AI Bradaa Strategic Command v15.2 (Architect Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/lib/ai/geminiClient.js"></script>
    <script src="/lib/links/marketplaces.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/icons/ai-bradaa.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#010409">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Bradaa">

    <style>
        :root {
            --c-bg: #010409;
            --c-glass: rgba(13, 17, 23, 0.6);
            --c-border: rgba(48, 54, 61, 0.8);
            --c-glow: rgba(0, 240, 255, 0.7);
            --c-accent-pink: #D83F87;
            --c-accent-cyan: #00F0FF;
            --c-text-primary: #E6EDF3;
            --c-text-secondary: #A8B2CC;
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Share Tech Mono', monospace;
        }
        body { font-family: var(--font-body); background-color: var(--c-bg); color: var(--c-text-primary); }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background-image:
                radial-gradient(circle at 10% 20%, var(--c-accent-cyan), transparent 30%),
                radial-gradient(circle at 90% 80%, var(--c-accent-pink), transparent 30%),
                radial-gradient(circle at 50% 50%, #4A00E0, transparent 40%);
            background-size: 200% 200%; filter: blur(100px); opacity: 0.15; z-index: -1;
            animation: aurora 25s linear infinite;
        }
        @keyframes aurora { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .font-display { font-family: var(--font-display); text-shadow: 0 0 5px var(--c-accent-cyan), 0 0 10px var(--c-accent-cyan); }
        .card { background-color: var(--c-glass); backdrop-filter: blur(24px); border: 1px solid var(--c-border); border-radius: 0.75rem; position: relative; overflow: hidden; }
        .card::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; z-index: 0;
            background: conic-gradient(from 180deg at 50% 50%, var(--c-accent-cyan), var(--c-accent-pink), var(--c-accent-cyan));
            transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.5s ease-in-out; animation: rotate 8s linear infinite;
        }
        .card:hover::before { opacity: 0.5; }
        @keyframes rotate { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .card-content { position: relative; z-index: 1; padding: 1.5rem; }
        .nav-sticky { position: sticky; top: 0; z-index: 50; background-color: rgba(1, 4, 9, 0.7); backdrop-filter: blur(12px); border-bottom: 1px solid var(--c-border); }
        .nav-button { border-bottom: 2px solid transparent; transition: all 0.3s; }
        .nav-button:hover, .nav-button.active { color: var(--c-accent-cyan); border-bottom-color: var(--c-accent-cyan); text-shadow: 0 0 5px var(--c-accent-cyan); }
        .filter-button.active { background-color: var(--c-accent-pink); border-color: var(--c-accent-pink); color: var(--c-text-primary); }
        .tool-selector-btn { text-align: left; width: 100%; padding: 0.75rem; border-radius: 0.375rem; transition: all 0.2s; border: 1px solid transparent;}
        .tool-selector-btn:hover { background-color: var(--c-border); }
        .tool-selector-btn.active {
            background-color: var(--c-accent-cyan);
            color: var(--c-bg);
            border-color: var(--c-accent-cyan);
            font-weight: bold;
            box-shadow: 0 0 8px var(--c-accent-cyan), 0 0 16px rgba(0, 240, 255, 0.5);
        }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--c-accent-cyan); }
        select, input, textarea { font-family: var(--font-body); background-color: rgba(1, 4, 9, 0.8); border: 1px solid var(--c-border); border-radius: 0.375rem; padding: 0.65rem; }
        .action-button { background-color: var(--c-accent-pink); color: white; padding: 0.65rem 1.5rem; font-weight: bold; border-radius: 0.375rem; transition: opacity 0.2s; cursor: pointer; } .action-button:hover { opacity: 0.9; }
        section { padding-top: 6rem; margin-top: -5rem; }
        .gemini-output { white-space: pre-wrap; line-height: 1.7; }
        .gemini-output h3 { font-family: var(--font-display); color: var(--c-accent-cyan); margin-top: 1rem; margin-bottom: 0.5rem;}
        .gemini-output ul { list-style-type: disc; padding-left: 1.5rem; }
        .gemini-output strong { color: var(--c-accent-pink); }

        @keyframes consoleFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .console-animating > * {
            animation: consoleFadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        #laptop-selector-container button.active{
          background-color: var(--c-accent-cyan);
          color: var(--c-bg);
          border-color: var(--c-accent-cyan);
          box-shadow: 0 0 6px var(--c-accent-cyan);
        }

        /* Feature flag: Enhanced UI (c5) â€” default OFF */
        html[data-enhanced-ui="1"] {
          font-size: clamp(15px, 1.25vw, 18px);
        }
        html[data-enhanced-ui="1"] .card-content {
          padding: clamp(1rem, 2.4vw, 1.8rem);
        }
        html[data-enhanced-ui="1"] h1 {
          font-size: clamp(2.2rem, 4.2vw, 3.2rem);
          text-align: center;
        }
        html[data-enhanced-ui="1"] h2 {
          font-size: clamp(1.6rem, 2.6vw, 2.2rem);
          text-align: center;
        }
        html[data-enhanced-ui="1"] h3 {
          font-size: clamp(1.2rem, 1.8vw, 1.4rem);
        }
        html[data-enhanced-ui="1"] .gemini-output {
          line-height: 1.8;
        }
        html[data-enhanced-ui="1"] header p {
          text-align: center;
        }

        /* UI toggle button */
        .ui-toggle {
          position: fixed;
          top: 80px;
          right: 1rem;
          z-index: 100;
          display: flex;
          gap: 0.5rem;
          padding: 0.5rem;
          background: var(--c-glass);
          backdrop-filter: blur(12px);
          border: 1px solid var(--c-border);
          border-radius: 0.5rem;
          font-size: 0.75rem;
        }
        .ui-toggle button {
          padding: 0.25rem 0.5rem;
          border: 1px solid var(--c-border);
          border-radius: 0.25rem;
          background: transparent;
          color: var(--c-text-secondary);
          cursor: pointer;
          transition: all 0.2s;
        }
        .ui-toggle button.active {
          background: var(--c-accent-cyan);
          color: var(--c-bg);
          border-color: var(--c-accent-cyan);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- UI Toggle (c5: feature flag) -->
    <div class="ui-toggle">
      <span class="opacity-70">Text:</span>
      <button id="ui-normal" class="active">Normal</button>
      <button id="ui-large">Large</button>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="text-center py-8">
            <h1 class="font-display text-4xl md:text-6xl font-black">AI BRADAA</h1>
            <p class="text-lg text-[var(--c-text-secondary)] mt-2">Powered by Kaa-Ching!</p>
        </header>

        <nav class="nav-sticky py-3 mb-12">
            <div class="flex flex-wrap justify-center gap-4 md:gap-6 text-sm">
                <a href="#matchmaker" class="nav-button active px-1 py-2 font-semibold">Matchmaker</a>
                <a href="#comparison" class="nav-button px-1 py-2 font-semibold">Versus</a>
                <a href="#explorer" class="nav-button px-1 py-2 font-semibold">Explorer</a>
                <a href="#toolkit" class="nav-button px-1 py-2 font-semibold">Ops Command</a>
                <a href="#intelligence" class="nav-button px-1 py-2 font-semibold">Intel</a>
                <a href="#appendices" class="nav-button px-1 py-2 font-semibold">Appendices</a>
                <a href="#camera-tech" class="nav-button px-1 py-2 font-semibold">Camera Tech</a>
            </div>
        </nav>

        <main class="space-y-16">
            <section id="matchmaker" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">AI Laptop Matchmaker</h2>
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                        <div class="space-y-4">
                            <p class="text-[var(--c-text-secondary)]">Yo. I'm AI Bradaa. Stop guessing. Provide your parameters, and I'll give you the optimal choice. Let's execute.</p>
                            <div><label class="block mb-2">1. Your Budget (MYR)</label><select id="match-budget" class="w-full"><option>Under RM4,500</option><option selected>RM4,500 - RM7,000</option><option>No Budget (Concierge)</option></select></div>
                            <div><label class="block mb-2">2. Primary Use Case</label><select id="match-usecase" class="w-full"><option>AI/ML & Coding</option><option>Creative Work (Video/3D)</option><option>Gaming & Everyday Use</option></select></div>
                            <div><label class="block mb-2">3. Portability Need</label><select id="match-portability" class="w-full"><option>Mostly at a desk</option><option>Always on the move</option><option>A mix of both</option></select></div>
                            <button id="find-match-btn" class="w-full action-button">âœ¨ Find My Match</button>
                        </div>
                        <div id="matchmaker-output" class="p-4 bg-[var(--c-bg)] rounded-lg min-h-[250px] text-[var(--c-text-secondary)] gemini-output">Your AI recommendation will appear here...</div>
                    </div>
                </div>
            </section>

            <section id="comparison" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Head-to-Head Comparison</h2>
                    <p class="text-sm text-[var(--c-text-secondary)] mb-4">Select 2 or 3 units for a tactical breakdown. AI Bradaa will generate an automated strategic analysis.</p>
                    <div class="max-h-48 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-2 mb-6 p-2 bg-[var(--c-bg)] rounded-lg" id="laptop-selector-container">Loading Intel...</div>
                    <div class="grid md:grid-cols-2 gap-8 items-center">
                         <div style="position: relative; height:450px;"><canvas id="radarChart"></canvas></div>
                         <div id="gemini-comparison-output" class="p-4 bg-[var(--c-bg)] rounded-lg min-h-[300px] text-sm text-[var(--c-text-secondary)] gemini-output">Select laptops to begin analysis...</div>
                    </div>
                </div>
            </section>

            <section id="explorer" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Interactive Market Explorer</h2>
                    <div id="filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-[var(--c-bg)] rounded-lg">
                        <div><label class="font-semibold text-sm mb-2 block">Price Range (â‰¤ RM<span id="price-value">7000</span>)</label><input type="range" id="price-filter" min="3500" max="7000" value="7000" step="100" class="w-full"></div>
                        <div><label class="font-semibold text-sm mb-2 block">Platform</label><div class="flex gap-2"><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md active" data-platform="All">All</button><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-platform="CUDA">CUDA</button><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-platform="NPU">NPU</button><button class="filter-button platform-filter flex-1 border border-[var(--c-border)] px-3 py-2 text-sm rounded-md" data-platform="Mac">Mac</button></div></div>
                        <div><label class="font-semibold text-sm mb-2 block">Brand</label><select id="brand-filter" class="w-full"><option value="All" selected>All Brands</option></select></div>
                        <div><label class="font-semibold text-sm mb-2 block">Sort By</label><select id="sort-filter" class="w-full"><option value="score_desc" selected>Score (High-Low)</option><option value="price_asc">Price (Low-High)</option><option value="price_desc">Price (High-Low)</option><option value="value_desc">Value Rating (Score-to-Price Ratio)</option></select></div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <div style="position: relative; height:500px;"><canvas id="rankingsChart"></canvas></div>
                        <div style="position: relative; height:500px;"><canvas id="valueChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section id="toolkit" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">AI Bradaa Toolkit</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="md:col-span-1 space-y-2 max-h-[600px] overflow-y-auto">
                            <button class="tool-selector-btn active" data-tool="deal-assassin">Deal Assassin</button>
                            <button class="tool-selector-btn" data-tool="upgrade-strategist">Upgrade Strategist</button>
                            <button class="tool-selector-btn" data-tool="dream-rig-architect">Dream Rig Architect</button>
                            <button class="tool-selector-btn" data-tool="elite-procurement">Elite Procurement</button>
                            <button class="tool-selector-btn" data-tool="component-recon">Component Recon</button>
                            <button class="tool-selector-btn" data-tool="performance-forecaster">Performance Forecaster</button>
                            <button class="tool-selector-btn" data-tool="system-integrity">System Integrity Analysis</button>
                            <button class="tool-selector-btn" data-tool="ecosystem-architect">Ecosystem Architect</button>
                            <button class="tool-selector-btn" data-tool="longevity-analyst">Longevity Analyst</button>
                            <button class="tool-selector-btn" data-tool="asset-value">Asset Value Forecaster</button>
                            <button class="tool-selector-btn" data-tool="field-support">Field Support</button>
                        </div>
                        <div id="toolkit-console" class="md:col-span-2 bg-[var(--c-bg)] p-4 rounded-lg flex flex-col">
                        </div>
                    </div>
                </div>
            </section>

             <section id="intelligence" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Latest Tech Intel</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="p-4 bg-[var(--c-bg)] rounded-lg">
                            <h3 id="intel-0-title" class="font-display text-lg text-[var(--c-accent-pink)]">Acquiring Intel...</h3>
                            <p id="intel-0-summary" class="text-xs text-[var(--c-text-secondary)] mt-2">AI Bradaa is scanning for intel...</p>
                            <p class="mt-3 font-semibold">Verdict: <span id="intel-0-verdict" class="text-[var(--c-accent-pink)]">STANDBY</span></p>
                        </div>
                        <div class="p-4 bg-[var(--c-bg)] rounded-lg">
                            <h3 id="intel-1-title" class="font-display text-lg text-[var(--c-accent-cyan)]">Acquiring Intel...</h3>
                            <p id="intel-1-summary" class="text-xs text-[var(--c-text-secondary)] mt-2">AI Bradaa is scanning for intel...</p>
                            <p class="mt-3 font-semibold">Verdict: <span id="intel-1-verdict" class="text-[var(--c-accent-cyan)]">STANDBY</span></p>
                        </div>
                        <div class="p-4 bg-[var(--c-bg)] rounded-lg">
                            <h3 id="intel-2-title" class="font-display text-lg text-[var(--c-text-secondary)]">Acquiring Intel...</h3>
                            <p id="intel-2-summary" class="text-xs text-[var(--c-text-secondary)] mt-2">AI Bradaa is scanning for intel...</p>
                            <p class="mt-3 font-semibold">Verdict: <span id="intel-2-verdict" class="text-[var(--c-text-secondary)]">STANDBY</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="appendices" class="card">
                <div class="card-content">
                    <h2 class="font-display text-2xl mb-4 text-[var(--c-accent-cyan)]">Appendices: Full Laptop Database</h2>
                    <p class="text-sm text-[var(--c-text-secondary)] mb-4 text-center">This list is updated automatically by the filters in the <a href="#explorer" class="underline text-[var(--c-accent-cyan)]">Explorer</a> section.</p>
                    <div id="laptop-list-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 max-h-[80vh] overflow-y-auto p-2">
                        <p class="text-center xl:col-span-3">Loading market data...</p>
                    </div>
                </div>
            </section>

            <section id="camera-tech" class="card">
                <div class="card-content flex flex-col justify-center items-center text-center min-h-[250px]">
                    <h2 class="font-display text-2xl text-[var(--c-text-secondary)]">Camera &amp; Smartphone Tech Division</h2>
                    <p class="mt-4 text-[var(--c-text-secondary)]">A new strategic vertical is under development.</p>
                    <p class="mt-2 text-[var(--c-text-secondary)]">Mobile gear ops (smartphones, lenses) are queuing up next.</p>
                    <p class="font-display text-4xl mt-4 animate-pulse">COMING SOON</p>
                </div>
            </section>
        </main>
    </div>

<script>
/* ==========================================================================
   AI Bradaa Strategic Command â€” v15.2 (Architect Edition)
   Code refactored for clarity, performance, and robustness.
   All AI features are live and persona-aligned.
   ========================================================================== */

// --- AI & VALIDATION CONSTANTS --------------------------------------------

const KAACHING_VAB = `
You are **AI Bradaa**, operating under **Kaa-Ching Virtual Board Assistance (VAB) â€” AI Agent**.
Mission: pragmatic Malaysian tech advisor focused on **value, reliability, thermals, upgrade paths**, and fewer headaches.
Tone: friendly, confident, direct, lightly playful. Prefer **MYR** and Malaysia context.
Format: Markdown with **### headings** and concise bullet points. Be decisive; explain *why* with concrete factors (price/TGP/thermals/ports/ecosystem).
Rules:
- Don't fabricate price/stock. If unsure, say so and give next steps.
- Optimize for "best value" and minimum friction. Offer 1â€“2 alternatives only when useful.
`;

const MENTOR_LENSES = [
  { id:'csp',          mentor:'CSP Guardian',               lens:'CSP Compliance',              brief:'Single CSP meta; only approved hosts; AI connect-src ok; images allowed (self,data,blob,https); fonts/styles/scripts from whitelisted CDNs.' },
  { id:'uiux',         mentor:'UI/UX Lead',                 lens:'UI/UX Parity',                brief:'Sections/IDs match v15.2; sticky nav; glass cards; no markup drift; headings text exact (Toolkit heading = "AI Bradaa Toolkit").' },
  { id:'func',         mentor:'Functional QA',              lens:'Functional Integrity',        brief:'Filters, radar select (â‰¤3), price menu toggle, Toolkit actions call AI, Intel init, no console errors.' },
  { id:'fallback',     mentor:'Data Reliability Officer',   lens:'Fallback Data Guarantee',     brief:'`fallbackLaptops` = 35 exact items; proper keys; inch quotes escaped; fetch fallback path works.' },
  { id:'charts',       mentor:'DataViz Engineer',           lens:'Chart Readiness',             brief:'Chart.js defaults configured; rankings bar, value scatter, radar all initialize; platformColorMap applied.' },
  { id:'pwa',          mentor:'PWA Engineer',               lens:'PWA Readiness',               brief:'Manifest linked; icons present; theme colors set; installable.' },
  { id:'a11y',         mentor:'Accessibility Advocate',     lens:'Accessibility & Semantics',   brief:'Heading hierarchy; discernible button text; keyboard operable; contrast per v15.2 palette.' },
  { id:'perf',         mentor:'Performance Engineer',       lens:'Performance & Bloat Control', brief:'Only Tailwind/Chart.js/Fonts CDNs; no extra blocking scripts; efficient init.' },
  { id:'maintain',     mentor:'Maintainability Coach',      lens:'Maintainability',             brief:'Single source of truth (VAB); clean prompt builder; no duplicated constants; comments preserved.' },
  { id:'nocollateral', mentor:'Change Control Officer',     lens:'No Collateral Changes',       brief:'Only intended files modified; no unrelated configs or serverless affected.' },
];

const LENSES_WEIGHTS = { uiux:20, func:20, fallback:15, csp:10, charts:10, pwa:10, perf:5, a11y:5, maintain:3, nocollateral:2 };
;(() => {
  'use strict';

  // --- STATE & CONSTANTS ----------------------------------------------------
  const STATE = {
    data: {
      allLaptops: [],
      sortedByRank: [],
      fallbackLaptops: [
        { "brand": "Illegear", "model": "Illegear Z7 (2025)", "price": 6899, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Illegear+Z7", "cpu": "Intel Core i7-14700HX", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5 5600MHz", "storage": "1TB NVMe Gen4 SSD", "display": "17.3\" QHD 240Hz", "price_source_url": "https://www.illegear.com/laptops/z7/", "shopee_url": "https://shopee.com.my/search?keyword=Illegear%20Z7", "tiktok_url": "https://www.tiktok.com/tag/illegearz7", "score": 95, "platform": "CUDA", "why": "Exceptional thermal performance and full-power RTX 4060.", "scores": { "ai": 9, "thermals": 10, "upgrade": 9, "linux": 7, "portability": 6, "value": 9 } },
        { "brand": "Lenovo", "model": "Legion Slim 5 16APH8", "price": 6299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Legion+Slim+5", "cpu": "AMD Ryzen 7 7840HS", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5 5600MHz", "storage": "512GB NVMe Gen4 SSD", "display": "16\" WQXGA 165Hz", "price_source_url": "https://www.lenovo.com/my/en/p/laptops/legion-laptops/legion-slim-series/legion-slim-5-gen-8-(16-inch-amd)/82y9006qmj", "shopee_url": "https://shopee.com.my/search?keyword=Legion%20Slim%205", "tiktok_url": null, "score": 93, "platform": "CUDA", "why": "Outstanding balance of build quality, performance, and aesthetic.", "scores": { "ai": 9, "thermals": 9, "upgrade": 8, "linux": 8, "portability": 7, "value": 9 } },
        { "brand": "ASUS", "model": "ROG Zephyrus G14 (2023)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Zephyrus+G14", "cpu": "AMD Ryzen 7 7735HS", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "14\" QHD+ 165Hz", "price_source_url": "https://www.asus.com/my/laptops/for-gaming/rog-republic-of-gamers/rog-zephyrus-g14-2023/", "shopee_url": "https://shopee.com.my/search?keyword=Zephyrus%20G14%202023", "tiktok_url": "https://www.tiktok.com/tag/zephyrusg14", "score": 92, "platform": "CUDA", "why": "Benchmark for compact power; incredible performance in a 14-inch chassis.", "scores": { "ai": 8, "thermals": 8, "upgrade": 7, "linux": 8, "portability": 9, "value": 8 } },
        { "brand": "ASUS", "model": "TUF Gaming A16 FA617NS", "price": 5599, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ASUS+TUF+A16", "cpu": "AMD Ryzen 9 7940HS", "gpu": "AMD Radeon RX 7600S", "ram": "16GB DDR5 4800MHz", "storage": "512GB NVMe Gen4 SSD", "display": "16\" FHD+ 165Hz", "price_source_url": "https://www.asus.com/my/laptops/for-gaming/tuf-gaming/asus-tuf-gaming-a16-advantage-edition-2023/", "shopee_url": "https://shopee.com.my/search?keyword=TUF%20Gaming%20A16", "tiktok_url": null, "score": 91, "platform": "CUDA", "why": "All-AMD advantage provides incredible efficiency and battery life.", "scores": { "ai": 8, "thermals": 9, "upgrade": 8, "linux": 9, "portability": 6, "value": 10 } },
        { "brand": "Gigabyte", "model": "AORUS 15 (2024)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Gigabyte+AORUS", "cpu": "Intel Core i7-13700H", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5", "storage": "1TB NVMe Gen4 SSD", "display": "15.6\" QHD 165Hz", "price_source_url": "https://www.gigabyte.com/my/Laptop/AORUS-15--2024", "shopee_url": "https://shopee.com.my/search?keyword=AORUS%2015%20BKG", "tiktok_url": null, "score": 90, "platform": "CUDA", "why": "Premium gaming build with a high-TGP RTX 4060 at budget's edge.", "scores": { "ai": 9, "thermals": 9, "upgrade": 8, "linux": 6, "portability": 5, "value": 8 } },
        { "brand": "Aftershock", "model": "Apex 15X (Gen 13)", "price": 6450, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Aftershock+Apex", "cpu": "Intel Core i7-13700HX", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5", "storage": "1TB NVMe Gen4 SSD", "display": "15.6\" QHD 165Hz", "price_source_url": "https://www.aftershockpc.com.my/products/apex-15x-13th-gen-rtx-4060", "shopee_url": "https://shopee.com.my/search?keyword=Aftershock%20Apex%2015X", "tiktok_url": null, "score": 90, "platform": "CUDA", "why": "Highly customizable, offering desktop-like power in a laptop form factor.", "scores": { "ai": 9, "thermals": 9, "upgrade": 10, "linux": 7, "portability": 5, "value": 8 } },
        { "brand": "Apple", "model": "MacBook Air 15-inch (M3)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MacBook+Air+15", "cpu": "Apple M3 Chip", "gpu": "10-core GPU", "ram": "8GB Unified Memory", "storage": "512GB SSD", "display": "15.3\" Liquid Retina", "price_source_url": "https://www.apple.com/my/shop/buy-mac/macbook-air/15-inch-m3", "shopee_url": "https://shopee.com.my/search?keyword=MacBook%20Air%2015%20M3", "tiktok_url": "https://www.tiktok.com/tag/macbookairm3", "score": 89, "platform": "Mac", "why": "Unbeatable power efficiency and silent, fanless design for AI on the go.", "scores": { "ai": 8, "thermals": 10, "upgrade": 1, "linux": 1, "portability": 10, "value": 7 } },
        { "brand": "Lenovo", "model": "IdeaPad Pro 5 16AHP9", "price": 5499, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=IdeaPad+Pro+5", "cpu": "AMD Ryzen 7 8845HS", "gpu": "NVIDIA RTX 3050 6GB", "ram": "16GB LPDDR5X", "storage": "1TB NVMe SSD", "display": "16\" 2.5K 120Hz", "price_source_url": "https://www.lenovo.com/my/en/p/laptops/ideapad/ideapad-pro-series/ideapad-pro-5-gen-9-(16-inch-amd)/len101i0062", "shopee_url": "https://shopee.com.my/search?keyword=IdeaPad%20Pro%205%2016AHP9", "tiktok_url": null, "score": 88, "platform": "NPU", "why": "Powerful AMD Ryzen 8000 series NPU for productive multitasking.", "scores": { "ai": 8, "thermals": 8, "upgrade": 2, "linux": 8, "portability": 6, "value": 9 } },
        { "brand": "Razer", "model": "Razer Blade 14 (2023)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Razer+Blade+14", "cpu": "AMD Ryzen 9 7940HS", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB LPDDR5X", "storage": "1TB NVMe SSD", "display": "14\" QHD+ 240Hz", "price_source_url": "https://www.razer.com/my-en/gaming-laptops/Razer-Blade-14/RZ09-0493BND3-R3B1", "shopee_url": "https://shopee.com.my/search?keyword=Razer%20Blade%2014%202023", "tiktok_url": null, "score": 88, "platform": "CUDA", "why": "Unparalleled CNC-milled aluminum build quality in a compact form factor.", "scores": { "ai": 8, "thermals": 8, "upgrade": 1, "linux": 6, "portability": 9, "value": 7 } },
        { "brand": "HP", "model": "Omen 16 (2024)", "price": 5999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=HP+Omen+16", "cpu": "Intel Core i7-14700HX", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" QHD 165Hz", "price_source_url": "https://www.hp.com/my-en/laptops/gaming/omen-16-intel/", "shopee_url": "https://shopee.com.my/search?keyword=HP%20Omen%2016", "tiktok_url": null, "score": 87, "platform": "CUDA", "why": "Great thermal performance with OMEN Tempest Cooling.", "scores": { "ai": 8, "thermals": 9, "upgrade": 7, "linux": 7, "portability": 6, "value": 8 } },
        { "brand": "Apple", "model": "MacBook Pro 14-inch (M3)", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MacBook+Pro+14", "cpu": "Apple M3 Pro", "gpu": "14-core GPU", "ram": "16GB Unified Memory", "storage": "512GB SSD", "display": "14.2\" Liquid Retina XDR", "price_source_url": "https://www.apple.com/my/macbook-pro-14-and-16/", "shopee_url": "https://shopee.com.my/search?keyword=MacBook%20Pro%2014%20M3", "tiktok_url": "https://www.tiktok.com/tag/macbookprom3", "score": 87, "platform": "Mac", "why": "Pro-grade performance with exceptional display quality.", "scores": { "ai": 9, "thermals": 9, "upgrade": 1, "linux": 1, "portability": 8, "value": 7 } },
        { "brand": "MSI", "model": "Pulse 15 B13V", "price": 5899, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MSI+Pulse+15", "cpu": "Intel Core i7-13700H", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR5", "storage": "1TB NVMe SSD", "display": "15.6\" FHD 144Hz", "price_source_url": "https://my.msi.com/Laptop/Pulse-15-B13V/", "shopee_url": "https://shopee.com.my/search?keyword=MSI%20Pulse%2015", "tiktok_url": null, "score": 86, "platform": "CUDA", "why": "Solid cooling system with Cooler Boost 5 technology.", "scores": { "ai": 8, "thermals": 8, "upgrade": 7, "linux": 7, "portability": 6, "value": 8 } },
        { "brand": "ASUS", "model": "VivoBook Pro 16X", "price": 5499, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=VivoBook+Pro+16X", "cpu": "AMD Ryzen 7 7840HS", "gpu": "NVIDIA RTX 3050 6GB", "ram": "16GB DDR5", "storage": "1TB NVMe SSD", "display": "16\" 2.8K OLED 120Hz", "price_source_url": "https://www.asus.com/my/laptops/for-creators/vivobook/vivobook-pro-16x-k6604/", "shopee_url": "https://shopee.com.my/search?keyword=VivoBook%20Pro%2016X", "tiktok_url": null, "score": 86, "platform": "NPU", "why": "Outstanding OLED display with creator-focused features.", "scores": { "ai": 7, "thermals": 8, "upgrade": 7, "linux": 8, "portability": 7, "value": 9 } },
        { "brand": "Acer", "model": "Swift X 16 (2024)", "price": 5799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Acer+Swift+X+16", "cpu": "AMD Ryzen 7 8845HS", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB LPDDR5X", "storage": "1TB NVMe SSD", "display": "16\" 2.5K 165Hz", "price_source_url": "https://store.acer.com/en-my/swift/", "shopee_url": "https://shopee.com.my/search?keyword=Acer%20Swift%20X%2016", "tiktok_url": null, "score": 85, "platform": "NPU", "why": "Excellent balance of performance and portability with NPU.", "scores": { "ai": 8, "thermals": 7, "upgrade": 6, "linux": 8, "portability": 8, "value": 8 } },
        { "brand": "Huawei", "model": "MateBook D16 (2024)", "price": 4999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MateBook+D16", "cpu": "Intel Core i7-13700H", "gpu": "Intel Arc A370M", "ram": "16GB LPDDR5", "storage": "1TB NVMe SSD", "display": "16\" 2.5K 60Hz", "price_source_url": "https://consumer.huawei.com/my/laptops/matebook-d-16-2024/", "shopee_url": "https://shopee.com.my/search?keyword=Huawei%20MateBook%20D16", "tiktok_url": null, "score": 85, "platform": "NPU", "why": "Great value with Intel NPU and premium build quality.", "scores": { "ai": 7, "thermals": 8, "upgrade": 5, "linux": 7, "portability": 8, "value": 9 } },
        { "brand": "HP", "model": "Envy x360 (2024)", "price": 4799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=HP+Envy+x360", "cpu": "Intel Core i7-13700H", "gpu": "Intel Arc A370M", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "15.6\" OLED Touch", "price_source_url": "https://www.hp.com/my-en/laptops/envy/envy-x360-15-intel/", "shopee_url": "https://shopee.com.my/search?keyword=HP%20Envy%20x360", "tiktok_url": null, "score": 84, "platform": "NPU", "why": "Versatile 2-in-1 design with excellent OLED display.", "scores": { "ai": 7, "thermals": 7, "upgrade": 6, "linux": 7, "portability": 8, "value": 8 } },
        { "brand": "MSI", "model": "Modern 15 (2024)", "price": 4299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MSI+Modern+15", "cpu": "Intel Core i7-13620H", "gpu": "Intel Arc A350M", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "15.6\" FHD IPS", "price_source_url": "https://my.msi.com/Laptop/Modern-15-B13M/", "shopee_url": "https://shopee.com.my/search?keyword=MSI%20Modern%2015", "tiktok_url": null, "score": 83, "platform": "NPU", "why": "Business-focused laptop with good AI acceleration.", "scores": { "ai": 7, "thermals": 7, "upgrade": 7, "linux": 7, "portability": 8, "value": 8 } },
        { "brand": "Dell", "model": "Inspiron 16 Plus (2024)", "price": 5299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Dell+Inspiron+16", "cpu": "Intel Core i7-13700H", "gpu": "NVIDIA RTX 3050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" 2.5K 120Hz", "price_source_url": "https://www.dell.com/my/p/inspiron-16-plus-laptop/", "shopee_url": "https://shopee.com.my/search?keyword=Dell%20Inspiron%2016%20Plus", "tiktok_url": null, "score": 83, "platform": "CUDA", "why": "Great build quality with good performance for creators.", "scores": { "ai": 7, "thermals": 8, "upgrade": 8, "linux": 8, "portability": 7, "value": 8 } },
        { "brand": "Lenovo", "model": "Yoga 7i (2024)", "price": 5199, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Lenovo+Yoga+7i", "cpu": "Intel Core i7-13700H", "gpu": "Intel Arc A370M", "ram": "16GB LPDDR5X", "storage": "1TB NVMe SSD", "display": "14\" 2.8K OLED Touch", "price_source_url": "https://www.lenovo.com/my/en/laptops/yoga/yoga-7-series/", "shopee_url": "https://shopee.com.my/search?keyword=Lenovo%20Yoga%207i", "tiktok_url": null, "score": 82, "platform": "NPU", "why": "Premium 2-in-1 with excellent OLED display and build.", "scores": { "ai": 7, "thermals": 7, "upgrade": 5, "linux": 8, "portability": 9, "value": 7 } },
        { "brand": "Honor", "model": "MagicBook X16 Pro", "price": 4299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Honor+MagicBook", "cpu": "Intel Core i5-13500H", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5", "storage": "512GB NVMe SSD", "display": "16\" 2.5K IPS", "price_source_url": "https://www.hihonor.com/my/laptops/honor-magicbook-x-16/", "shopee_url": "https://shopee.com.my/search?keyword=Honor%20MagicBook%20X16", "tiktok_url": null, "score": 82, "platform": "NPU", "why": "Great value with good build and display quality.", "scores": { "ai": 6, "thermals": 7, "upgrade": 6, "linux": 7, "portability": 8, "value": 9 } },
        { "brand": "Acer", "model": "Predator Helios Neo 16", "price": 5999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Predator+Helios", "cpu": "Intel Core i7-13700HX", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" WQXGA 165Hz", "price_source_url": "https://store.acer.com/en-my/predator/", "shopee_url": "https://shopee.com.my/search?keyword=Predator%20Helios%20Neo%2016", "tiktok_url": null, "score": 81, "platform": "CUDA", "why": "Strong gaming performance with good cooling system.", "scores": { "ai": 8, "thermals": 8, "upgrade": 7, "linux": 6, "portability": 5, "value": 7 } },
        { "brand": "ASUS", "model": "ProArt Studiobook 16", "price": 6799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ProArt+Studiobook", "cpu": "AMD Ryzen 9 7940HS", "gpu": "NVIDIA RTX 4060 8GB", "ram": "32GB DDR5", "storage": "1TB NVMe SSD", "display": "16\" 3.2K OLED", "price_source_url": "https://www.asus.com/my/laptops/for-creators/proart-studiobook/", "shopee_url": "https://shopee.com.my/search?keyword=ASUS%20ProArt%20Studiobook", "tiktok_url": null, "score": 81, "platform": "CUDA", "why": "Creator-focused with Calman-verified OLED display.", "scores": { "ai": 9, "thermals": 8, "upgrade": 7, "linux": 7, "portability": 6, "value": 7 } },
        { "brand": "Lenovo", "model": "ThinkPad X1 Carbon Gen 11", "price": 6899, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ThinkPad+X1", "cpu": "Intel Core i7-1355U", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5", "storage": "1TB NVMe SSD", "display": "14\" 2.8K OLED", "price_source_url": "https://www.lenovo.com/my/en/p/laptops/thinkpad/thinkpadx1/", "shopee_url": "https://shopee.com.my/search?keyword=ThinkPad%20X1%20Carbon", "tiktok_url": null, "score": 80, "platform": "NPU", "why": "Premium business laptop with excellent build quality.", "scores": { "ai": 6, "thermals": 7, "upgrade": 4, "linux": 10, "portability": 10, "value": 6 } },
        { "brand": "HP", "model": "ZBook Studio G10", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ZBook+Studio", "cpu": "Intel Core i7-13700H", "gpu": "NVIDIA RTX 4050 6GB", "ram": "32GB DDR5", "storage": "1TB NVMe SSD", "display": "16\" 4K OLED", "price_source_url": "https://www.hp.com/my-en/workstations/zbook-studio/", "shopee_url": "https://shopee.com.my/search?keyword=HP%20ZBook%20Studio", "tiktok_url": null, "score": 80, "platform": "CUDA", "why": "Workstation-class performance with stunning display.", "scores": { "ai": 8, "thermals": 7, "upgrade": 6, "linux": 8, "portability": 7, "value": 6 } },
        { "brand": "Framework", "model": "Laptop 16", "price": 5999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Framework+16", "cpu": "AMD Ryzen 7 7840HS", "gpu": "AMD Radeon 780M", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" 2.5K 165Hz", "price_source_url": "https://frame.work/my/en/laptop-16", "shopee_url": null, "tiktok_url": null, "score": 79, "platform": "NPU", "why": "Highly modular and repairable design with good performance.", "scores": { "ai": 7, "thermals": 7, "upgrade": 10, "linux": 9, "portability": 7, "value": 7 } },
        { "brand": "Gigabyte", "model": "G5 KF", "price": 4999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Gigabyte+G5", "cpu": "Intel Core i5-12500H", "gpu": "NVIDIA RTX 4060 8GB", "ram": "16GB DDR4", "storage": "512GB NVMe SSD", "display": "15.6\" FHD 144Hz", "price_source_url": "https://www.gigabyte.com/my/Laptop/G5--Intel-12th-Gen", "shopee_url": "https://shopee.com.my/search?keyword=Gigabyte%20G5%20KF", "tiktok_url": null, "score": 79, "platform": "CUDA", "why": "Great value gaming laptop with RTX 4060.", "scores": { "ai": 8, "thermals": 7, "upgrade": 8, "linux": 6, "portability": 6, "value": 9 } },
        { "brand": "MSI", "model": "Katana 15", "price": 4899, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MSI+Katana", "cpu": "Intel Core i7-12650H", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "15.6\" FHD 144Hz", "price_source_url": "https://my.msi.com/Laptop/Katana-15-B12V/", "shopee_url": "https://shopee.com.my/search?keyword=MSI%20Katana%2015", "tiktok_url": null, "score": 78, "platform": "CUDA", "why": "Budget-friendly gaming laptop with good performance.", "scores": { "ai": 7, "thermals": 7, "upgrade": 7, "linux": 6, "portability": 6, "value": 8 } },
        { "brand": "Lenovo", "model": "ThinkBook 16p Gen 4", "price": 5799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ThinkBook+16p", "cpu": "AMD Ryzen 7 7840HS", "gpu": "NVIDIA RTX 4050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "16\" 2.5K IPS", "price_source_url": "https://www.lenovo.com/my/en/p/laptops/thinkbook/thinkbook-series/thinkbook-16p-gen-4/", "shopee_url": "https://shopee.com.my/search?keyword=ThinkBook%2016p", "tiktok_url": null, "score": 78, "platform": "NPU", "why": "Business laptop with creator-focused features.", "scores": { "ai": 7, "thermals": 7, "upgrade": 7, "linux": 8, "portability": 6, "value": 7 } },
        { "brand": "ASUS", "model": "ExpertBook B9 OLED", "price": 6799, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=ExpertBook+B9", "cpu": "Intel Core i7-1355U", "gpu": "Intel Iris Xe", "ram": "32GB LPDDR5", "storage": "2TB NVMe SSD", "display": "14\" 2.8K OLED", "price_source_url": "https://www.asus.com/my/laptops/for-work/expertbook/expertbook-b9-oled-b9403/", "shopee_url": "https://shopee.com.my/search?keyword=ASUS%20ExpertBook%20B9", "tiktok_url": null, "score": 77, "platform": "NPU", "why": "Ultra-lightweight business laptop with great battery life.", "scores": { "ai": 6, "thermals": 7, "upgrade": 3, "linux": 7, "portability": 10, "value": 6 } },
        { "brand": "Acer", "model": "Aspire 7", "price": 3999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Aspire+7", "cpu": "AMD Ryzen 5 7535HS", "gpu": "NVIDIA RTX 3050 6GB", "ram": "16GB DDR5", "storage": "512GB NVMe SSD", "display": "15.6\" FHD IPS", "price_source_url": "https://store.acer.com/en-my/aspire-7-gaming-laptop-a715-43g", "shopee_url": "https://shopee.com.my/search?keyword=Acer%20Aspire%207", "tiktok_url": null, "score": 77, "platform": "CUDA", "why": "Entry-level gaming laptop with good upgrade options.", "scores": { "ai": 6, "thermals": 7, "upgrade": 8, "linux": 7, "portability": 7, "value": 9 } },
        { "brand": "Huawei", "model": "MateBook X Pro", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=MateBook+X+Pro", "cpu": "Intel Core i7-1360P", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5", "storage": "1TB NVMe SSD", "display": "14.2\" 3.1K Touch", "price_source_url": "https://consumer.huawei.com/my/laptops/matebook-x-pro-2023/", "shopee_url": "https://shopee.com.my/search?keyword=Huawei%20MateBook%20X%20Pro", "tiktok_url": null, "score": 76, "platform": "NPU", "why": "Premium ultrabook with excellent display and build.", "scores": { "ai": 6, "thermals": 7, "upgrade": 2, "linux": 6, "portability": 9, "value": 6 } },
        { "brand": "Acer", "model": "Swift 5", "price": 5499, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Acer+Swift+5", "cpu": "Intel Core i7-1360P", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5", "storage": "1TB NVMe SSD", "display": "14\" 2.8K OLED", "price_source_url": "https://store.acer.com/en-my/swift-5", "shopee_url": "https://shopee.com.my/search?keyword=Acer%20Swift%205", "tiktok_url": null, "score": 76, "platform": "NPU", "why": "Premium ultraportable with great display.", "scores": { "ai": 6, "thermals": 7, "upgrade": 3, "linux": 7, "portability": 9, "value": 7 } },
        { "brand": "HP", "model": "Pavilion Plus 14", "price": 4299, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Pavilion+Plus", "cpu": "AMD Ryzen 7 7840U", "gpu": "AMD Radeon 780M", "ram": "16GB LPDDR5", "storage": "512GB NVMe SSD", "display": "14\" 2.8K OLED", "price_source_url": "https://www.hp.com/my-en/laptops/pavilion/pavilion-plus-14-laptop-pc/", "shopee_url": "https://shopee.com.my/search?keyword=HP%20Pavilion%20Plus%2014", "tiktok_url": null, "score": 75, "platform": "NPU", "why": "Great value with OLED display and good performance.", "scores": { "ai": 7, "thermals": 7, "upgrade": 4, "linux": 7, "portability": 8, "value": 8 } },
        { "brand": "Infinix", "model": "INBOOK X2", "price": 3699, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Infinix+INBOOK", "cpu": "Intel Core i7-1260P", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR4X", "storage": "512GB NVMe SSD", "display": "14\" FHD+ IPS", "price_source_url": "https://my.infinixmobility.com/laptops/inbook/", "shopee_url": "https://shopee.com.my/search?keyword=Infinix%20INBOOK%20X2", "tiktok_url": null, "score": 75, "platform": "NPU", "why": "Budget-friendly with good build and performance.", "scores": { "ai": 6, "thermals": 7, "upgrade": 5, "linux": 7, "portability": 8, "value": 9 } },
        { "brand": "Microsoft", "model": "Surface Laptop 5 15-inch", "price": 6999, "imageUrl": "https://placehold.co/600x400/2A4A5C/FFFFFF?text=Surface+Laptop+5", "cpu": "Intel Core i7-1355U", "gpu": "Intel Iris Xe", "ram": "16GB LPDDR5X", "storage": "512GB NVMe SSD", "display": "15\" PixelSense Touch", "price_source_url": "https://www.microsoft.com/en-my/surface/devices/surface-laptop-5", "shopee_url": "https://shopee.com.my/search?keyword=Surface%20Laptop%205", "tiktok_url": null, "score": 75, "platform": "NPU", "why": "Premium build with excellent display and keyboard.", "scores": { "ai": 6, "thermals": 7, "upgrade": 2, "linux": 5, "portability": 8, "value": 7 } }
      ]
    },
    ui: {
      app: {
        price: 7000,
        platform: 'All',
        brand: 'All',
        sort: 'score_desc',
        radarSelection: []
      },
      charts: {
        rankings: null,
        radar: null,
        value: null
      },
      elements: {}
    },
    config: {
      chartFont: { family: "'Share Tech Mono', monospace", size: 12 },
      platformColors: {
        CUDA: 'text-[#00F0FF]',
        NPU: 'text-[#D83F87]',
        Mac: 'text-gray-400'
      },
      platformColorMap: {
        CUDA: 'rgba(0, 240, 255, 0.7)',
        NPU: 'rgba(216, 63, 135, 0.7)',
        Mac: 'rgba(168, 178, 204, 0.7)'
      }
    },
    affiliate: {
      SHOPEE_AFFILIATE_ID: self.SHOPEE_AFFILIATE_ID || null,
      LAZADA_AFFILIATE_ID: self.LAZADA_AFFILIATE_ID || null,
      TIKTOK_AFFILIATE_ID: self.TIKTOK_AFFILIATE_ID || null,
      INVOLVE_ASIA_ID: self.INVOLVE_ASIA_ID || null
    }
  };

  // --- Data Validation Functions ---------------------------------------------
  const validateLaptopData = (laptop, index) => {
    // Required fields validation
    const requiredFields = ['brand', 'model', 'price', 'cpu', 'gpu', 'ram', 'storage', 'display', 'score', 'platform', 'why', 'scores'];
    requiredFields.forEach(field => {
      console.assert(Object.prototype.hasOwnProperty.call(laptop, field), 
        `Laptop at index ${index} missing required field: ${field}`);
    });

    // Type validations
    console.assert(typeof laptop.price === 'number', `Laptop ${laptop.model}: price must be a number`);
    console.assert(typeof laptop.score === 'number', `Laptop ${laptop.model}: score must be a number`);
    console.assert(['CUDA', 'NPU', 'Mac'].includes(laptop.platform), 
      `Laptop ${laptop.model}: invalid platform ${laptop.platform}`);

    // Value range validations
    console.assert(laptop.price >= 3500 && laptop.price <= 7000, 
      `Laptop ${laptop.model}: price ${laptop.price} outside valid range (3500-7000)`);
    console.assert(laptop.score >= 0 && laptop.score <= 100, 
      `Laptop ${laptop.model}: score ${laptop.score} outside valid range (0-100)`);

    // Scores object validation
    const requiredScores = ['ai', 'thermals', 'upgrade', 'linux', 'portability', 'value'];
    requiredScores.forEach(score => {
      console.assert(Object.prototype.hasOwnProperty.call(laptop.scores, score), 
        `Laptop ${laptop.model} missing required score: ${score}`);
      console.assert(typeof laptop.scores[score] === 'number', 
        `Laptop ${laptop.model}: score ${score} must be a number`);
      console.assert(laptop.scores[score] >= 0 && laptop.scores[score] <= 10, 
        `Laptop ${laptop.model}: score ${score} outside valid range (0-10)`);
    });

    // URL validations
    console.assert(laptop.price_source_url && typeof laptop.price_source_url === 'string', 
      `Laptop ${laptop.model}: invalid price_source_url`);
    console.assert(!laptop.tiktok_url || typeof laptop.tiktok_url === 'string', 
      `Laptop ${laptop.model}: invalid tiktok_url format`);
    console.assert(!laptop.shopee_url || typeof laptop.shopee_url === 'string', 
      `Laptop ${laptop.model}: invalid shopee_url format`);
  };

  // Validate the entire fallback dataset
  const validateFallbackData = () => {
    console.assert(Array.isArray(STATE.data.fallbackLaptops), 
      'fallbackLaptops must be an array');
    console.assert(STATE.data.fallbackLaptops.length >= 20,
      `Expected at least 20 laptops in fallback data, got ${STATE.data.fallbackLaptops.length}`);
    
    STATE.data.fallbackLaptops.forEach((laptop, index) => {
      validateLaptopData(laptop, index);
    });

    // Verify unique models
    const models = new Set(STATE.data.fallbackLaptops.map(l => l.model));
    console.assert(models.size === STATE.data.fallbackLaptops.length, 
      'Duplicate laptop models found in fallback data');

    // Verify score distribution
    const scores = STATE.data.fallbackLaptops.map(l => l.score).sort((a, b) => b - a);
    console.assert(scores[0] <= 100, 'Maximum score exceeds 100');
    console.assert(scores[scores.length - 1] >= 70, 'Minimum score below 70');
    
    console.log('âœ… Fallback data validation complete');
  };

  // Run validation on initialization
  validateFallbackData();

  // --- API & DATA MODULE ----------------------------------------------------
  // Prompt builder (Kaa-Ching VAB persona + all Toolkit tasks)
function buildPrompts(task, payload) {
  const persona = KAACHING_VAB;

  let systemPrompt = `${persona}
General rules:
- Use Markdown with ### headings and concise bullets.
- Be decisive; say WHY (price, thermals/TGP, upgrades, ecosystem).
- Assume the user wants best value and minimum headaches.`;

  let userPrompt = `Context:\n${JSON.stringify(payload || {}, null, 2)}`;
  let generationConfig = { responseMimeType: "text/markdown" };

  switch (task) {
    case 'findMatch':
      systemPrompt = `${persona}
Task: From the provided laptop list, pick ONE best match for the criteria.
Output:
### Recommendation
- **Model:** â€¦
- **Price:** â€¦
- **Why:** 3â€“5 bullets (thermals, CUDA/NPU fit, portability, value)
### Alternatives (optional)
- 1â€“2 models with one-line why`;
      userPrompt =
`Criteria:
- Budget: ${payload?.criteria?.budget}
- Main Use: ${payload?.criteria?.usecase}
- Portability: ${payload?.criteria?.portability}

Laptops JSON:
${JSON.stringify(payload?.laptops || [], null, 2)}`;
      break;

    case 'compareLaptops':
      systemPrompt = `${persona}
Task: Compare the selected laptops side-by-side.
Output:
### TL;DR
- One-line verdict (who should buy which)
### Model A vs B (and C)
- Strengths
- Weaknesses
- Best for
### Final Call
- Pick per persona (student dev / creator / gamer / mobile coder)`;
      userPrompt = `Compare these:\n${JSON.stringify(payload?.laptops || [], null, 2)}`;
      break;

    case 'getFutureIntel':
      systemPrompt = `${persona}
Return **JSON** only with key "intelligence": [{title, summary, verdict} x3].
Keep summary one sentence; verdict ONE WORD: SOLID/WAIT/HYPE.`;
      generationConfig.responseMimeType = "application/json";
      userPrompt = "Top 3 consumer-relevant tech updates in Malaysia right now.";
      break;

    // Toolkit tools
    case 'deal-assassin':
      systemPrompt = `${persona}
Task: Find where the named product usually has the **best value** in MY (official vs Shopee/TikTok/etc). Consider warranty, street price, promos.
Output:
### Best Deal Now
- Store/Platform + Why (price, warranty, returns)
- Target price to aim
### Negotiation/Buying Tips
- 3â€“5 bullets
### Alternatives @ Similar Price (optional)`;
      userPrompt = `Product: ${payload?.query || ""}`;
      break;

    case 'upgrade-strategist':
      systemPrompt = `${persona}
Task: Create a pragmatic upgrade plan for the chosen base laptop and goal (e.g., 13B LLM local).
Output:
### Plan
- RAM/storage targets
- Thermals (cooling pad, repaste?)
- OS/driver notes (CUDA/NPU stacks)
### Shopping List
- Exact SKUs/spec hints + expected MYR`;
      userPrompt = `Base laptop: ${payload?.laptop}\nGoal: ${payload?.goal}\nLaptop JSON: ${JSON.stringify(payload?.laptopData || {}, null, 2)}`;
      break;

    case 'dream-rig-architect':
      systemPrompt = `${persona}
Task: Spec the best rig under budget for the stated use (dev/AI/creator/gaming).
Output:
### Build/Buy Call
- Laptop vs desktop (and why)
### Spec
- CPU, GPU/NPU, RAM, storage, display
### Why This Wins in MY
- 3â€“5 bullets`;
      userPrompt = `Budget (MYR): ${payload?.budget}\nUse: ${payload?.use}`;
      break;

    case 'elite-procurement':
      systemPrompt = `${persona}
Task: Suggest concrete leads in Malaysia (retailers, niche stores, import tips).
Output:
### Where to Look
- 3â€“6 leads
### Risk & Warranty Notes
### ETA / Odds`;
      userPrompt = `Rare item: ${payload?.item}`;
      break;

    case 'component-recon':
      systemPrompt = `${persona}
Task: Explain a componentâ€™s positioning, performance tier, and compatibility.
Output:
### What It Is
### Real-World Performance
### Pairing/Compatibility
### Watch-outs`;
      userPrompt = `Component: ${payload?.component || payload?.query || ""}`;
      break;

    case 'performance-forecaster':
      systemPrompt = `${persona}
Task: Forecast performance of the laptop on a named app/workload (e.g., SDXL, Llama.cpp).
Output:
### Expected Performance
- Ballpark metrics (it/s, min vRAM/RAM) + bottlenecks
### Tweaks
- Drivers, flags, quantization, runtime tips
### Confidence
- High/Med/Low`;
      userPrompt = `Laptop: ${payload?.laptop}\nApp: ${payload?.app}\nLaptop JSON: ${JSON.stringify(payload?.laptopData || {}, null, 2)}`;
      break;

    case 'system-integrity':
      systemPrompt = `${persona}
Task: Diagnose the issue and give a clean runbook.
Output:
### Likely Root Causes
### Fix Steps (ordered)
### Verification
### Prevention`;
      userPrompt = `Issue: ${payload?.issue || payload?.query || ""}`;
      break;

    case 'ecosystem-architect':
      systemPrompt = `${persona}
Task: Recommend the best ecosystem fit (Apple/Samsung/Windows mix).
Output:
### Fit
- What to keep/add
### Why
- Handoff/Continuity/Phone-PC bridge
### Settings to Enable`;
      userPrompt = `Current devices: ${payload?.devices || payload?.query || ""}`;
      break;

    case 'longevity-analyst':
      systemPrompt = `${persona}
Task: Estimate usable lifespan and likely upgrade/replace windows.
Output:
### Lifespan
### Failure Risk / Parts
### Upgrade Path
### Replace Whenâ€¦`;
      userPrompt = `Laptop: ${payload?.laptop}\nLaptop JSON: ${JSON.stringify(payload?.laptopData || {}, null, 2)}`;
      break;

    case 'asset-value':
      systemPrompt = `${persona}
Task: Forecast resale value range in Malaysia for the model/condition.
Output:
### Todayâ€™s Range (MYR)
### 6â€“12 Month Trend
### How to Maximize Value`;
      userPrompt = `Laptop: ${payload?.laptop}\nCondition: ${payload?.condition || "Good"}`;
      break;

    case 'field-support':
      systemPrompt = `${persona}
Task: Provide a crisp, step-wise answer to the tech support query.
Output:
### Do This
1. â€¦
2. â€¦
### Why It Works
### If That Fails`;
      userPrompt = `Question: ${payload?.query || ""}`;
      break;
  }

  return { systemPrompt, userPrompt, generationConfig };
}

  // --- STORAGE UTILITIES (localStorage guards) -------------------------------
  const StorageUtil = {
    safeGet(key, fallback = "") {
      try {
        return localStorage.getItem(key) || fallback;
      } catch {
        console.warn(`localStorage.getItem("${key}") failed (private mode?)`);
        return fallback;
      }
    },
    safeSet(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch {
        console.warn(`localStorage.setItem("${key}") failed`);
        return false;
      }
    },
    safeRemove(key) {
      try {
        localStorage.removeItem(key);
      } catch {
        console.warn(`localStorage.removeItem("${key}") failed`);
      }
    }
  };

  // --- API MODULE -----------------------------------------------------------
  const API_MODULE = {
    async fetchMarketIntel() {
      try {
        const response = await fetch('data/laptops.json');
        if (!response.ok) throw new Error('Local JSON not found.');
        STATE.data.allLaptops = await response.json();
      } catch (error) {
        // Using embedded fallback data (silent to keep console clean)
        STATE.data.allLaptops = STATE.data.fallbackLaptops;
      },

      /**
       * Call AI Agent with retry logic and telemetry
       * @param {string} task - Task name (e.g., 'findMatch', 'compareLaptops')
       * @param {object} payload - Data for the prompt
       * @param {HTMLElement} outputElement - DOM element to render response
       * @param {object} callbacks - { onIntelSuccess, onIntelFallback }
       * @example
       *   API_MODULE.callAIAgent('deal-assassin', { query: 'RTX 4060 laptop' }, outputDiv);
       */
      async callAIAgent(task, payload, outputElement, callbacks = {}) {
        const { onIntelSuccess, onIntelFallback } = callbacks;

        if (outputElement) {
          outputElement.textContent = 'AI Bradaa is thinking...';
          outputElement.className = 'gemini-output text-sm animate-pulse';
        }

        const { systemPrompt, userPrompt, generationConfig } = buildPrompts(task, payload);
        const apiKey = self.GEMINI_API_KEY || StorageUtil.safeGet("GEMINI_API_KEY");

        if (!apiKey) {
          if (outputElement) {
            outputElement.innerHTML = `
              <div class="text-[var(--c-accent-pink)]">âš ï¸ AI is disabled</div>
              <p class="mt-2 text-sm">Set API key in dev console:</p>
              <code class="block bg-[var(--c-bg)] p-2 mt-1 text-xs">localStorage.setItem('GEMINI_API_KEY','YOUR_KEY');</code>
              <p class="mt-1 text-xs opacity-70">Then refresh.</p>
            `;
            outputElement.className = 'gemini-output';
          }
          return;
        }

        try {
          const res = await window.GeminiClient.generate({ systemPrompt, userPrompt, generationConfig, apiKey });
          if (!res.ok) {
            if (task === 'getFutureIntel') {
              const fb = [
                { title: 'RTX 4060 Value Sweet Spot', summary: 'Street price in MY hovers RM4.8kâ€“5.5k with 1TB SSD promos; prioritize 140W TGP variants for AI workloads. (fallback)', verdict: 'SOLID' },
                { title: 'NPU Usefulness in 2025', summary: 'Decent for battery life in webcam/background tasks; CUDA still wins for local LLMs on laptops. (fallback)', verdict: 'WAIT' },
                { title: 'TikTok Shop Flash Deals', summary: 'Short windows undercut official stores by 5â€“12% but watch warranty scope; Shopee Preferred+ safer choice. (fallback)', verdict: 'HYPE' }
              ];
              onIntelSuccess?.(fb);
              return;
            }
            if (outputElement) {
              outputElement.innerHTML = `<div class="text-[var(--c-accent-pink)]">AI Error ${res.status} â€” check quota or retry</div>`;
              outputElement.className = 'gemini-output';
            }
            return;
          }

          const text = res.text || '';
          if (task === 'getFutureIntel') {
            try {
              const intelData = JSON.parse(text);
              if (!intelData.intelligence) throw new Error('no-intel');
              onIntelSuccess?.(intelData.intelligence);
            } catch {
              const fb = [
                { title: 'RTX 4060 Value Sweet Spot', summary: 'Street price in MY hovers RM4.8kâ€“5.5k with 1TB SSD promos; prioritize 140W TGP variants for AI workloads. (fallback)', verdict: 'SOLID' },
                { title: 'NPU Usefulness in 2025', summary: 'Decent for battery life in webcam/background tasks; CUDA still wins for local LLMs on laptops. (fallback)', verdict: 'WAIT' },
                { title: 'TikTok Shop Flash Deals', summary: 'Short windows undercut official stores by 5â€“12% but watch warranty scope; Shopee Preferred+ safer choice. (fallback)', verdict: 'HYPE' }
              ];
              onIntelSuccess?.(fb);
            }
            return;
          }

          if (outputElement) {
            outputElement.innerHTML = text || 'Sorry, AI Bradaa could not provide a clear answer. Please try again.';
            outputElement.className = 'gemini-output';
          }
        } catch (_) {
          if (outputElement) {
            outputElement.innerHTML = `<div class="text-[var(--c-accent-pink)]">Network Error â€” retry</div>`;
            outputElement.className = 'gemini-output';
          }
        }
      }

      /* Legacy AI fetch disabled â€” routed via GeminiClient only
      const { systemPrompt, userPrompt, generationConfig } = buildPrompts(task, payload);
      const apiKey = self.GEMINI_API_KEY || StorageUtil.safeGet("GEMINI_API_KEY");

      if (!apiKey) {
        if (outputElement) {
          outputElement.innerHTML = `
            <div class="text-[var(--c-accent-pink)]">âš ï¸ AI is disabled</div>
            <p class="mt-2 text-sm">Set API key in dev console:</p>
            <code class="block bg-[var(--c-bg)] p-2 mt-1 text-xs">localStorage.setItem('GEMINI_API_KEY','YOUR_KEY');</code>
            <p class="mt-1 text-xs opacity-70">Then refresh.</p>
          `;
          outputElement.className = 'gemini-output';
        }
        return;
      }

      // Centralized Gemini client first (multi-endpoint + retries)
      try {
        const res = await window.GeminiClient.generate({ systemPrompt, userPrompt, generationConfig, apiKey });
        if (!res.ok) {
          if (task === 'getFutureIntel') {
            const fb = [
              { title: 'RTX 4060 Value Sweet Spot', summary: 'Street price in MY hovers RM4.8kâ€“5.5k with 1TB SSD promos; prioritize 140W TGP variants for AI workloads.', verdict: 'SOLID' },
              { title: 'NPU Usefulness in 2025', summary: 'Decent for battery life in webcam/background tasks; CUDA still wins for local LLMs on laptops.', verdict: 'WAIT' },
              { title: 'TikTok Shop Flash Deals', summary: 'Short windows undercut official stores by 5â€“12% but watch warranty scope; Shopee Preferred+ safer choice.', verdict: 'HYPE' }
            ];
            onIntelSuccess?.(fb);
            return;
          }
          if (outputElement) {
            outputElement.innerHTML = `<div class="text-[var(--c-accent-pink)]">AI Error ${res.status} â€” check quota or retry</div>`;
            outputElement.className = 'gemini-output';
          }
          return;
        }
        const text = res.text || '';
        if (task === 'getFutureIntel') {
          try {
            const intelData = JSON.parse(text);
            if (!intelData.intelligence) throw new Error('no-intel');
            onIntelSuccess?.(intelData.intelligence);
          } catch {
            const fb = [
              { title: 'RTX 4060 Value Sweet Spot', summary: 'Street price in MY hovers RM4.8kâ€“5.5k with 1TB SSD promos; prioritize 140W TGP variants for AI workloads.', verdict: 'SOLID' },
              { title: 'NPU Usefulness in 2025', summary: 'Decent for battery life in webcam/background tasks; CUDA still wins for local LLMs on laptops.', verdict: 'WAIT' },
              { title: 'TikTok Shop Flash Deals', summary: 'Short windows undercut official stores by 5â€“12% but watch warranty scope; Shopee Preferred+ safer choice.', verdict: 'HYPE' }
            ];
            onIntelSuccess?.(fb);
          }
          return;
        }
        if (outputElement) {
          outputElement.innerHTML = text || 'Sorry, AI Bradaa could not provide a clear answer. Please try again.';
          outputElement.className = 'gemini-output';
        }
        return;
      } catch (_) {
        if (outputElement) {
          outputElement.innerHTML = `<div class="text-[var(--c-accent-pink)]">Network Error â€” retry</div>`;
          outputElement.className = 'gemini-output';
        }
        return;
      }

      // Stable endpoint with header auth (CRIT-001 fix)
      const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";
      
      const requestBody = {
        contents: [{ role: "user", parts: [{ text: userPrompt }] }],
        systemInstruction: { role: "system", parts: [{ text: systemPrompt }] },
        generationConfig
      };

      // Exponential backoff retry (HIGH-001 fix)
      const maxRetries = 4;
      const delays = [500, 1000, 2000, 4000];
      
      for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-goog-api-key": apiKey  // Header auth (CRIT-001 fix)
            },
            body: JSON.stringify(requestBody),
            mode: "cors",
            credentials: "omit"
          });

          // Enhanced telemetry (HIGH-005 fix)
          if (!response.ok) {
            const rawText = await response.text();
            let errorData = {};
            try {
              errorData = JSON.parse(rawText);
            } catch {
              errorData = { message: rawText };
            }
            
            console.error(`Gemini error (attempt ${attempt + 1}/${maxRetries}):`, {
              status: response.status,
              statusText: response.statusText,
              body: errorData
            });

            // Retry on 429 (rate limit) or 5xx (server errors)
            if ((response.status === 429 || response.status >= 500) && attempt < maxRetries - 1) {
              await new Promise(resolve => setTimeout(resolve, delays[attempt]));
              continue;  // Retry
            }

            // Final failure: show detailed error
            if (outputElement) {
              outputElement.innerHTML = `
                <div class="text-[var(--c-accent-pink)]">âŒ AI Error ${response.status}</div>
                <p class="mt-2 text-sm">${response.statusText}</p>
                <details class="mt-2">
                  <summary class="cursor-pointer text-xs">Server response</summary>
                  <pre class="mt-1 text-xs bg-[var(--c-bg)] p-2 overflow-auto">${JSON.stringify(errorData, null, 2)}</pre>
                </details>
                <p class="mt-2 text-xs opacity-70">What to do next: Check your API key quota or try again in a few minutes.</p>
              `;
              outputElement.className = 'gemini-output';
            }
            return;
          }

          // Success
          const result = await response.json();
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

          if (task === 'getFutureIntel') {
            try {
              const intelData = JSON.parse(text);
              if (!intelData.intelligence) {
                throw new Error('Formatted JSON not found in AI response for Intel.');
              }
              onIntelSuccess?.(intelData.intelligence);
            } catch (error) {
              console.error('Failed to parse Intel JSON:', error, 'Raw text:', text);
              onIntelFallback?.(text);
            }
            return;
          }

          if (outputElement) {
            // Safe innerHTML usage (CRIT-002 mitigation: AI responses are from trusted Gemini API, but still sanitize user input in templates)
            outputElement.innerHTML = text || 'Sorry, AI Bradaa could not provide a clear answer. Please try again.';
            outputElement.className = 'gemini-output';
          }
          return;  // Success, exit retry loop

        } catch (error) {
          console.error(`AI Agent network error (attempt ${attempt + 1}/${maxRetries}):`, error);
          
          if (attempt < maxRetries - 1) {
            await new Promise(resolve => setTimeout(resolve, delays[attempt]));
            continue;  // Retry
          }

          // Final network failure
          if (outputElement) {
            outputElement.innerHTML = `
              <div class="text-[var(--c-accent-pink)]">âŒ Network Error</div>
              <p class="mt-2 text-sm">Could not connect to AI. Please check your internet connection.</p>
              <details class="mt-2">
                <summary class="cursor-pointer text-xs">Technical details</summary>
                <pre class="mt-1 text-xs bg-[var(--c-bg)] p-2">${error.message}</pre>
              </details>
            `;
            outputElement.className = 'gemini-output';
          }
        }
      }
    }
  };
  */

  };
// --- UI MODULE -----------------------------------------------------------
  const UI_MODULE = {
    configureCharts() {
      if (!window.Chart) return;
      Chart.defaults.color = '#E6EDF3';
      Chart.defaults.font = STATE.config.chartFont;
      Chart.defaults.borderColor = 'rgba(168,178,204,0.25)';
    },

    renderAll(data) {
      renderAppendicesList(data);
      renderCharts(data);
    }
  };

  //* ---------- SAFETY KIT (no UI/UX changes): define required functions so init runs ---------- */

// Compute filter results from current UI state
function computeFilteredLaptops() {
  const { price, platform, brand, sort } = STATE.ui.app;
  const src = (STATE?.data?.allLaptops?.length ? STATE.data.allLaptops : STATE.data.fallbackLaptops) || [];
  const withValue = src.map(l => ({ ...l, value_rating: (l.score * 100) / l.price }));

  let list = withValue.filter(x => x.price <= price);
  if (platform && platform !== 'All') list = list.filter(x => x.platform === platform);
  if (brand && brand !== 'All') list = list.filter(x => x.brand === brand);

  switch (sort) {
    case 'price_asc':  list.sort((a,b)=>a.price-b.price); break;
    case 'price_desc': list.sort((a,b)=>b.price-a.price); break;
    case 'value_desc': list.sort((a,b)=>(b.score/b.price)-(a.score/a.price)); break;
    default:           list.sort((a,b)=>b.score-a.score);
  }
  return list;
}

/**
 * Render Appendices List with deep cards, spec table, and localStorage actions
 * @param {Array} data - Filtered laptop list
 */
function renderAppendicesList(data) {
  const el = document.getElementById('laptop-list-container');
  if (!el) return;
  if (!data?.length) { el.innerHTML = '<p class="text-center xl:col-span-3">No data.</p>'; return; }

  // Load saved state from localStorage
  const saved = JSON.parse(StorageUtil.safeGet('saves', '[]'));
  const alertsRaw = StorageUtil.safeGet('alerts', '[]');
  let alertsMap = {};
  try {
    if ((alertsRaw||'').trim().startsWith('{')) alertsMap = JSON.parse(alertsRaw);
    else (JSON.parse(alertsRaw)||[]).forEach(a=>{ if(a&&a.model) alertsMap[`${a.brand? (a.brand+" ") : ''}${a.model}`.trim()] = { alertRM:a.target, savedAt: a.created? new Date(a.created).toISOString(): new Date().toISOString() }; });
  } catch { alertsMap = {}; }

  el.innerHTML = data.map(l => {
    const valueRating = Math.round((l.score / l.price) * 10000) / 100;
    const isSaved = saved.includes(l.model);
    const alertId = `${l.brand} ${l.model}`.trim();
const existingAlert = alertsMap[alertId];
const q = (window.Marketplaces && window.Marketplaces.modelString) ? window.Marketplaces.modelString(l) : `${l.brand} ${l.model}`;
const shopeeHref = (window.Marketplaces && l.shopee_url && window.Marketplaces.isValidUrl(l.shopee_url)) ? l.shopee_url : (window.Marketplaces ? window.Marketplaces.shopeeSearch(q) : '#');
const priceHref  = (window.Marketplaces && l.price_source_url && window.Marketplaces.isValidUrl(l.price_source_url)) ? l.price_source_url : (window.Marketplaces ? window.Marketplaces.lazadaSearch(q) : '#');
const tiktokHref = (window.Marketplaces && l.tiktok_url && window.Marketplaces.isValidUrl(l.tiktok_url)) ? l.tiktok_url : (window.Marketplaces ? window.Marketplaces.tiktokSearch(q) : '#');
const buy = [
  `<a class="underline hover:text-[var(--c-accent-cyan)]" target="_blank" href="${priceHref}">ðŸ”— Price Source</a>`,
  `<a class="underline hover:text-[var(--c-accent-cyan)]" target="_blank" href="${shopeeHref}">ðŸ›’ Shopee</a>`,
  `<a class="underline hover:text-[var(--c-accent-cyan)]" target="_blank" href="${tiktokHref}">ðŸ“± TikTok</a>`
].join(' â€¢ ');

    return `
    <div class="p-4 bg-[var(--c-bg)] rounded-lg border border-[var(--c-border)] hover:border-[var(--c-accent-cyan)] transition-colors" style="line-height:1.75;">
      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3">
        <h3 class="text-base sm:text-lg md:text-xl font-bold">${l.brand} ${l.model}</h3>
        <span class="text-lg sm:text-xl md:text-2xl font-bold text-[var(--c-accent-pink)]">RM${(l.price||0).toLocaleString()}</span>
      </div>

      <!-- Badges -->
      <div class="flex flex-wrap gap-2 mb-3 text-xs">
        <span class="px-2 py-1 rounded ${l.platform === 'CUDA' ? 'bg-[var(--c-accent-cyan)]' : l.platform === 'NPU' ? 'bg-[var(--c-accent-pink)]' : 'bg-gray-600'} text-white font-semibold">${l.platform}</span>
        <span class="px-2 py-1 rounded bg-[var(--c-border)] text-[var(--c-text-primary)]">Score: ${l.score}</span>
        <span class="px-2 py-1 rounded bg-[var(--c-border)] text-[var(--c-text-primary)]">Value: ${valueRating}</span>
      </div>

      <!-- Progressive disclosure -->
      <details class="mt-3">
        <summary class="cursor-pointer text-[var(--c-accent-cyan)] font-semibold">ðŸ“‹ Specs, Actions & Links</summary>
        
        <div class="mt-4 space-y-4">
          <!-- Spec Table -->
          <table class="w-full text-sm border-collapse">
            <tr><td class="py-1 pr-2 opacity-70">CPU:</td><td class="py-1 font-medium">${l.cpu}</td></tr>
            <tr><td class="py-1 pr-2 opacity-70">GPU:</td><td class="py-1 font-medium">${l.gpu}</td></tr>
            <tr><td class="py-1 pr-2 opacity-70">RAM:</td><td class="py-1 font-medium">${l.ram}</td></tr>
            <tr><td class="py-1 pr-2 opacity-70">Storage:</td><td class="py-1 font-medium">${l.storage}</td></tr>
            <tr><td class="py-1 pr-2 opacity-70">Display:</td><td class="py-1 font-medium">${l.display}</td></tr>
          </table>

          <!-- Actions -->
          <div class="space-y-2">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" class="compare-checkbox" data-model="${l.model}">
              <span class="text-sm">Compare (add to radar chart)</span>
            </label>
            
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" class="save-checkbox" data-model="${l.model}" ${isSaved ? 'checked' : ''}>
              <span class="text-sm">Save for later</span>
            </label>
            
            <div class="flex flex-col sm:flex-row gap-2 items-start sm:items-center">
              <label class="text-sm whitespace-nowrap">Price alert (RM):</label>
              <input type="number" class="alert-input flex-1 px-2 py-1 text-sm bg-[var(--c-glass)] border border-[var(--c-border)] rounded" 
                     data-model="${l.model}" data-brand="${l.brand}"
                     placeholder="${l.price - 500}" 
                     value="${existingAlert?.alertRM || ''}">
              <button type="button" class="alert-save px-3 py-1 text-xs bg-[var(--c-accent-pink)] rounded" data-model="${l.model}" data-brand="${l.brand}">Save</button>
            </div>
          </div>

          <!-- External Links -->
          <div class="pt-3 border-t border-[var(--c-border)] text-sm">
            ${buy || '<span class="opacity-70">No external links available</span>'}
          </div>
        </div>
      </details>
    </div>`;
  }).join('');

  // Attach event handlers (c4: localStorage integration)
  attachAppendicesHandlers();
}

/**
 * Attach event handlers for Appendices actions (c4)
 */
function attachAppendicesHandlers() {
  const container = document.getElementById('laptop-list-container');
  if (!container) return;

  const alertTimers = {};
// Compare checkboxes â†’ update radar
  container.querySelectorAll('.compare-checkbox').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const model = e.target.dataset.model;
      const sel = STATE.ui.app.radarSelection;
      
      if (e.target.checked) {
        if (sel.length < 3 && !sel.includes(model)) {
          sel.push(model);
          // Update chip in Versus section
          const chip = document.querySelector(`button[data-model="${model}"]`);
          if (chip) chip.classList.add('active');
        } else if (sel.length >= 3) {
          e.target.checked = false;
          alert('Maximum 3 laptops for comparison');
        }
      } else {
        const idx = sel.indexOf(model);
        if (idx >= 0) {
          sel.splice(idx, 1);
          const chip = document.querySelector(`button[data-model="${model}"]`);
          if (chip) chip.classList.remove('active');
        }
      }
      
      UI_MODULE.renderRadarChart();
    });
  });

  // Save for later â†’ localStorage
  container.querySelectorAll('.save-checkbox').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const model = e.target.dataset.model;
      const saved = JSON.parse(StorageUtil.safeGet('saves', '[]'));
      
      if (e.target.checked) {
        if (!saved.includes(model)) {
          saved.push(model);
          StorageUtil.safeSet('saves', JSON.stringify(saved));
        }
      } else {
        const idx = saved.indexOf(model);
        if (idx >= 0) {
          saved.splice(idx, 1);
          StorageUtil.safeSet('saves', JSON.stringify(saved));
        }
      }
    });
  });

  // Price alert â†’ localStorage
  container.querySelectorAll('.alert-save').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const model = e.target.dataset.model;
    const brand = e.target.dataset.brand;
    const id = `${brand} ${model}`.trim();
    const input = container.querySelector(`.alert-input[data-model="${model}"][data-brand="${brand}"]`);
    const target = parseFloat(input.value);
    if (!target || target <= 0) { alert('Enter a valid target price'); return; }
    e.target.textContent = 'Saving...';
    clearTimeout(alertTimers[id]);
    alertTimers[id] = setTimeout(() => {
      let map = {};
      const raw = StorageUtil.safeGet('alerts', '{}');
      try { map = JSON.parse(raw) || {}; } catch { map = {}; }
      map[id] = { alertRM: target, savedAt: new Date().toISOString() };
      StorageUtil.safeSet('alerts', JSON.stringify(map));
      e.target.textContent = 'âœ“ Saved';
      setTimeout(() => { e.target.textContent = 'Save'; }, 1200);
    }, 300);
  });
});
}

// Charts (rankings bar + value scatter)
function renderCharts(data) {
  if (!window.Chart) return;

  // Rankings bar (horizontal)
  const c1 = document.getElementById('rankingsChart');
  if (c1) {
    const top = [...data].slice(0, 10);
    const labels = top.map(x => `${x.brand} ${x.model}` );
    const scores = top.map(x => x.score);
    const opts = {
      indexAxis: 'y',
      maintainAspectRatio: false,
      scales: {
        x: { grid: { color: 'rgba(168,178,204,0.15)' }, ticks: { color: '#A8B2CC' } },
        y: { grid: { color: 'rgba(168,178,204,0.15)' }, ticks: { color: '#E6EDF3', font: { size: 11 } } }
      },
      plugins: { legend: { labels: { color: '#E6EDF3' } } }
    };
    if (STATE.ui.charts.rankings) {
      STATE.ui.charts.rankings.data.labels = labels;
      STATE.ui.charts.rankings.data.datasets[0].data = scores;
      STATE.ui.charts.rankings.update();
    } else {
      STATE.ui.charts.rankings = new Chart(c1, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Score', data: scores, backgroundColor: 'rgba(0,240,255,0.45)' }] },
        options: opts
      });
    }
  }

  // Value scatter (price vs score)
  const c2 = document.getElementById('valueChart');
  if (c2) {
    const pts = data.map(l => ({ x: l.price, y: l.score, _p: l.platform }));
    const colors = pts.map(p => STATE.config.platformColorMap[p._p] || 'rgba(168,178,204,0.7)');
    const opts = {
      maintainAspectRatio: false,
      scales: {
        x: { title: { display: true, text: 'Price (MYR)' }, grid: { color: 'rgba(168,178,204,0.15)' }, ticks: { color: '#A8B2CC' } },
        y: { title: { display: true, text: 'Score' }, grid: { color: 'rgba(168,178,204,0.15)' }, ticks: { color: '#E6EDF3' } }
      },
      plugins: { legend: { labels: { color: '#E6EDF3' } } }
    };
    if (STATE.ui.charts.value) {
      STATE.ui.charts.value.data.datasets[0].data = pts;
      STATE.ui.charts.value.data.datasets[0].pointBackgroundColor = colors;
      STATE.ui.charts.value.update();
    } else {
      STATE.ui.charts.value = new Chart(c2, {
        type: 'scatter',
        data: { datasets: [{ label: 'Laptops', data: pts, parsing: false, pointRadius: 4, borderWidth: 0, pointBackgroundColor: colors }] },
        options: opts
      });
    }
  }
}

// Brand dropdown
UI_MODULE.populateBrandFilter = function () {
  const sel = document.getElementById('brand-filter');
  if (!sel) return;
  const src = (STATE?.data?.allLaptops?.length ? STATE.data.allLaptops : STATE.data.fallbackLaptops) || [];
  const brands = [...new Set(src.map(x => x.brand))].sort();
  sel.innerHTML = '<option value="All" selected>All Brands</option>' +
    brands.map(b => `<option value="${b}">${b}</option>`).join('');
};

// Laptop selector (for Radar)
UI_MODULE.populateLaptopSelector = function () {
  const box = document.getElementById('laptop-selector-container');
  if (!box) return;
  const src = (STATE?.data?.allLaptops?.length ? STATE.data.allLaptops : STATE.data.fallbackLaptops) || [];
  const top = src.slice(0, 30);
  box.innerHTML = top.map((l) =>
    `<button class="px-2 py-1 border border-[var(--c-border)] rounded text-xs"
             data-model="${l.model}">
       ${l.brand} ${l.model}
     </button>`).join('');

  box.addEventListener('click', (e) => {
    const b = e.target.closest('button[data-model]');
    if (!b) return;
    const model = b.getAttribute('data-model');
    const sel = STATE.ui.app.radarSelection;
    const i = sel.indexOf(model);
    if (i >= 0) { sel.splice(i, 1); b.classList.remove('active'); }
    else if (sel.length < 3) { sel.push(model); b.classList.add('active'); }
    UI_MODULE.renderRadarChart();
  });
};

// Radar chart
UI_MODULE.renderRadarChart = function () {
  const canvas = document.getElementById('radarChart');
  if (!canvas || !window.Chart) return;

  const src = (STATE?.data?.allLaptops?.length ? STATE.data.allLaptops : STATE.data.fallbackLaptops) || [];
  const byModel = new Map(src.map(l => [l.model, l]));
  const labels = ['ai','thermals','upgrade','linux','portability','value'];
  const models = STATE.ui.app.radarSelection;

  const palette = [
    { bg:'rgba(0,240,255,0.32)', br:'rgba(0,240,255,0.9)' },
    { bg:'rgba(216,63,135,0.32)', br:'rgba(216,63,135,0.9)' },
    { bg:'rgba(255,215,0,0.35)', br:'rgba(255,215,0,0.9)' }
  ];

  const ds = models.map((m, i) => {
    const l = byModel.get(m);
    if (!l) return null;
    const p = palette[i%palette.length];
    return {
      label: `${l.brand} ${l.model}` ,
      data: labels.map(k => l.scores[k]),
      fill: true, backgroundColor: p.bg, borderColor: p.br, pointBackgroundColor: p.br, borderWidth: 2
    };
  }).filter(Boolean);
  if (!ds.length) return;

  const opts = {
    maintainAspectRatio: false,
    scales: {
      r: {
        suggestedMin: 0, suggestedMax: 10,
        angleLines: { color: 'rgba(168,178,204,0.2)' },
        grid: { color: 'rgba(168,178,204,0.2)' },
        pointLabels: { color: '#E6EDF3', font: { size: 12 } },
        ticks: { display: false }
      }
    },
    plugins: { legend: { position: 'bottom', labels: { color: '#E6EDF3' } } }
  };

  if (STATE.ui.charts.radar) {
    STATE.ui.charts.radar.data.labels = labels;
    STATE.ui.charts.radar.data.datasets = ds;
    STATE.ui.charts.radar.options = opts;
    STATE.ui.charts.radar.update();
  } else {
    STATE.ui.charts.radar = new Chart(canvas, { type: 'radar', data: { labels, datasets: ds }, options: opts });
  }

  if (models.length >= 2) {
    const selected = models.map(m => byModel.get(m)).filter(Boolean);
    const out = document.getElementById('gemini-comparison-output');
    API_MODULE.callAIAgent('compareLaptops', { laptops: selected }, out);
  }
};

// Toolkit console (personalized per tool) â€” commit c3
const TOOLKIT_UI = {
  'deal-assassin': {
    badge: 'Deal Assassin ðŸ”Ž',
    cta: 'Hunt Deal',
    placeholder: 'Example: RTX 4060 laptop under RM5500, 1TB SSD',
    prefill: 'Budget: RM5500\nPriority: Thermals & CUDA\nNotes: 16GB RAM OK, prefer 1TB storage',
    tips: [
      'Check street price vs RRP (retail price)',
      'Prioritize TGP (Total Graphics Power) over boost clocks',
      'Warranty â‰¥ 2y or on-site preferred for MY'
    ]
  },
  'upgrade-strategist': {
    badge: 'Upgrade Strategist âš¡',
    cta: 'Plan Upgrade',
    placeholder: 'Base laptop + goal (e.g., IdeaPad Pro 5 â€” run Llama 3 8B)',
    prefill: 'Current: IdeaPad Pro 5 16AHP9\nGoal: Run Llama 3 8B locally\nBudget for upgrades: RM800',
    tips: [
      'RAM: 32GB DDR5 for LLMs (check max supported)',
      'Cooling: repaste + cooling pad for sustained loads',
      'OS: WSL2 or dual-boot Linux for CUDA stacks'
    ]
  },
  'dream-rig-architect': {
    badge: 'Dream Rig Architect ðŸŽ¯',
    cta: 'Spec Rig',
    placeholder: 'Budget + use (e.g., RM6,500 for AI coding + video)',
    prefill: 'Budget: RM6500\nUse: AI coding (Cursor), light video (1080p60)\nPreference: Portability > raw power',
    tips: [
      'Laptop vs desktop: portability tax ~20-30% in MY',
      'NPU worth it if coding on battery often',
      'Display: 120Hz+ for smooth scrolling in IDE'
    ]
  },
  'elite-procurement': {
    badge: 'Elite Procurement ðŸŽ–ï¸',
    cta: 'Source Item',
    placeholder: 'Rare/limited item in MY (e.g., Zephyrus G14 AniMe)',
    prefill: 'Item: Zephyrus G14 (2024) with AniMe Matrix\nRegion: Klang Valley\nTimeline: 2-4 weeks OK',
    tips: [
      'Check parallel imports (warranty risk vs savings)',
      'Pre-orders: ASUS/Lenovo Malaysia official stores',
      'Gray market: Lowyat, FB groups (verify seller)'
    ]
  },
  'component-recon': {
    badge: 'Component Recon ðŸ”¬',
    cta: 'Analyze',
    placeholder: 'Component (e.g., RTX 4060 8GB laptop vs 7600S)',
    prefill: 'Compare: RTX 4060 8GB (laptop, 140W TGP) vs Radeon 7600S\nWorkload: Stable Diffusion SDXL',
    tips: [
      'Laptop GPUs: check TGP (115Wâ€“140W for 4060)',
      'CUDA vs ROCm: 4060 wins for ML/AI workflows',
      'VRAM: 8GB minimum for SDXL (6GB tight)'
    ]
  },
  'performance-forecaster': {
    badge: 'Performance Forecaster ðŸ“Š',
    cta: 'Forecast',
    placeholder: 'Laptop + workload (e.g., Swift X 16 â€” SDXL)',
    prefill: 'Laptop: Acer Swift X 16 (Ryzen 7 8845HS, RTX 4050 6GB)\nApp: Stable Diffusion SDXL (512x512)\nSettings: FP16, xformers',
    tips: [
      'It/s (iterations/sec): ~1.2â€“1.8 it/s for 4050',
      'Bottleneck: VRAM (6GB tight, use --lowvram)',
      'Driver: CUDA 12.x + PyTorch 2.x stable'
    ]
  },
  'system-integrity': {
    badge: 'System Integrity ðŸ›¡ï¸',
    cta: 'Diagnose',
    placeholder: 'Problem (e.g., Chart.js axes not visible on dark)',
    prefill: 'Issue: Chart.js axes/labels invisible on #010409 background\nBrowser: Chrome 120\nChart version: 4.x from CDN',
    tips: [
      'Chart.defaults.color = "#E6EDF3" (light on dark)',
      'Grid colors: rgba(168,178,204,0.15) for subtle',
      'Test: inspect canvas â†’ check computed styles'
    ]
  },
  'ecosystem-architect': {
    badge: 'Ecosystem Architect ðŸŒ',
    cta: 'Optimize Flow',
    placeholder: 'Devices (e.g., iPhone + Windows laptop + Buds)',
    prefill: 'Current: iPhone 14, Legion Slim 5 (Windows), Galaxy Buds 2 Pro\nPain: No seamless handoff, files via WhatsApp',
    tips: [
      'Phone Link (Windows): clipboard + SMS sync',
      'iCloud for Windows: photos/files (but slow)',
      'Continuity: consider Mac if deep in Apple'
    ]
  },
  'longevity-analyst': {
    badge: 'Longevity Analyst â³',
    cta: 'Forecast Lifespan',
    placeholder: 'Model + horizon (e.g., G5 KF â€” 3â€“4 years?)',
    prefill: 'Laptop: Gigabyte G5 KF (i5-12500H, RTX 4060)\nHorizon: 3â€“4 years\nUse: Gaming + coding',
    tips: [
      'CPU/GPU: 4060 good till 2027 for 1080p gaming',
      'RAM: 16GB â†’ upgrade to 32GB by year 2',
      'Failure risk: hinge, battery (replace ~RM300)'
    ]
  },
  'asset-value': {
    badge: 'Asset Value ðŸ’°',
    cta: 'Estimate Value',
    placeholder: 'Model + condition (e.g., Zenbook 14 OLED â€” Good)',
    prefill: 'Model: ASUS Zenbook 14 OLED (UX3405, i7-1355U)\nCondition: Good (minor scratches)\nAge: 18 months',
    tips: [
      'Depreciation: ~30% year 1, ~20% year 2 in MY',
      'OLED premium holds value (+10% vs IPS)',
      'Maximize: original box, warranty transferable'
    ]
  },
  'field-support': {
    badge: 'Field Support ðŸ†˜',
    cta: 'Get Help',
    placeholder: 'Ask a specific support question',
    prefill: 'Question: How to enable NPU in Windows 11 for local AI?\nLaptop: IdeaPad Pro 5 16AHP9 (Ryzen 7 8845HS)',
    tips: [
      'NPU: check Device Manager â†’ Neural Processors',
      'Drivers: AMD Software Adrenalin latest',
      'Test: Windows Studio Effects (webcam blur)'
    ]
  }
};

/**
 * Render Toolkit Console with personalized UX per tool
 * @param {string} tool - Tool ID (e.g., 'deal-assassin')
 */
UI_MODULE.renderToolkitConsole = function (tool = 'deal-assassin') {
  const cfg = TOOLKIT_UI[tool] || { 
    badge: tool, 
    cta: 'Run', 
    placeholder: 'Type your questionâ€¦', 
    prefill: '', 
    tips: [] 
  };
  const el = document.getElementById('toolkit-console');
  if (!el) return;

  const tipsHtml = cfg.tips.length 
    ? `<ul class="text-xs space-y-1 opacity-80">${cfg.tips.map(t => `<li>â€¢ ${t}</li>`).join('')}</ul>`
    : '';

  el.innerHTML = `
    <div class="console-animating space-y-3">
      <div class="flex items-center justify-between">
        <span class="text-lg font-semibold text-[var(--c-accent-cyan)]">${cfg.badge}</span>
        ${cfg.prefill ? `<button id="toolkit-use-sample" class="text-xs underline opacity-70 hover:opacity-100">Use sample</button>` : ''}
      </div>
      ${tipsHtml}
      <textarea id="toolkit-input" class="w-full h-28 text-sm" placeholder="${cfg.placeholder}"></textarea>
      <button id="toolkit-run" class="action-button self-start">${cfg.cta}</button>
      <div id="toolkit-output" class="gemini-output text-sm mt-3"></div>
    </div>`;

  if (cfg.prefill) {
    el.querySelector('#toolkit-use-sample')?.addEventListener('click', () => {
      el.querySelector('#toolkit-input').value = cfg.prefill;
    });
  }

  el.querySelector('#toolkit-run').addEventListener('click', () => {
    const query = el.querySelector('#toolkit-input').value || cfg.placeholder;
    API_MODULE.callAIAgent(tool, { query }, el.querySelector('#toolkit-output'));
  });
};

// Wire UI events
function registerEventHandlers({ ui, callAIAgent, computeFiltered }) {
  // price
  document.getElementById('price-filter')?.addEventListener('input', (e) => {
    STATE.ui.app.price = +e.target.value;
    const pv = document.getElementById('price-value'); if (pv) pv.textContent = e.target.value;
    ui.renderAll(computeFiltered());
  });

  // platform buttons
  document.querySelectorAll('.platform-filter').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.platform-filter').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      STATE.ui.app.platform = btn.dataset.platform;
      ui.renderAll(computeFiltered());
    });
  });

  // brand + sort selects
  document.getElementById('brand-filter')?.addEventListener('change', (e) => {
    STATE.ui.app.brand = e.target.value; ui.renderAll(computeFiltered());
  });
  document.getElementById('sort-filter')?.addEventListener('change', (e) => {
    STATE.ui.app.sort = e.target.value; ui.renderAll(computeFiltered());
  });

  // matchmaker
  document.getElementById('find-match-btn')?.addEventListener('click', () => {
    const payload = {
      criteria: {
        budget: document.getElementById('match-budget')?.value,
        usecase: document.getElementById('match-usecase')?.value,
        portability: document.getElementById('match-portability')?.value
      },
      laptops: computeFiltered()
    };
    callAIAgent('findMatch', payload, document.getElementById('matchmaker-output'));
  });

  // toolkit menu
  document.querySelectorAll('.tool-selector-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tool-selector-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      UI_MODULE.renderToolkitConsole(btn.dataset.tool);
    });
  });
}

// Intel cards update
UI_MODULE.updateIntelUI = function (items = []) {
  [0,1,2].forEach(i => {
    const d = items[i]; if (!d) return;
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    set(`intel-${i}-title`, d.title || '');
    set(`intel-${i}-summary`, d.summary || '');
    set(`intel-${i}-verdict`, d.verdict || '');
  });
};

UI_MODULE.updateIntelUIWithRawText = function (text = '') {
  const el = document.getElementById('intel-0-summary'); if (el) el.textContent = text;
};
/* ---------- END SAFETY KIT ---------- */


  // --- NETLIFY DETECTION & PWA (c6) -----------------------------------------
  /**
   * Detect if running on Netlify by checking x-nf-request-id header
   * @returns {Promise<boolean>}
   */
  async function detectNetlify() {
    try {
      const res = await fetch(location.pathname, { 
        method: "HEAD", 
        cache: "no-store" 
      });
      return !!res.headers.get("x-nf-request-id");
    } catch {
      return false;
    }
  }

  // --- APP CONTROLLER & INITIALIZATION --------------------------------------
const APP = {
  async initialize() {

    // Initialize Enhanced UI toggle (c5)
    const uiEnhanced = StorageUtil.safeGet('ui_enhanced', '0');
    document.documentElement.dataset.enhancedUi = uiEnhanced;
    
    const btnNormal = document.getElementById('ui-normal');
    const btnLarge = document.getElementById('ui-large');
    
    if (uiEnhanced === '1') {
      btnNormal?.classList.remove('active');
      btnLarge?.classList.add('active');
    }
    
    btnNormal?.addEventListener('click', () => {
      document.documentElement.dataset.enhancedUi = '0';
      StorageUtil.safeSet('ui_enhanced', '0');
      btnNormal.classList.add('active');
      btnLarge.classList.remove('active');
    });
    
    btnLarge?.addEventListener('click', () => {
      document.documentElement.dataset.enhancedUi = '1';
      StorageUtil.safeSet('ui_enhanced', '1');
      btnLarge.classList.add('active');
      btnNormal.classList.remove('active');
    });

    UI_MODULE.configureCharts();
    await API_MODULE.fetchMarketIntel();
    
    // Fallback data warning (MED-003)
    const usingFallback = !STATE.data.allLaptops || !STATE.data.allLaptops.length;
    if (usingFallback) {
      STATE.data.allLaptops = STATE.data.fallbackLaptops;
      // Add subtle badge to header
      const header = document.querySelector('header p');
      if (header) {
        header.innerHTML += ' <span class="text-xs opacity-60">(Data: fallback)</span>';
      }
    }

    STATE.data.allLaptops.forEach(laptop => {
      laptop.value_rating = (laptop.score * 100) / laptop.price;
    });

    STATE.data.sortedByRank = [...STATE.data.allLaptops]
      .sort((a, b) => b.score - a.score)
      .map((item, index) => ({ ...item, rank: index + 1 }));

    UI_MODULE.populateBrandFilter();
    UI_MODULE.populateLaptopSelector();

    const filtered = computeFilteredLaptops();
    UI_MODULE.renderAll(filtered);
    UI_MODULE.renderRadarChart();
    UI_MODULE.renderToolkitConsole('deal-assassin');

    registerEventHandlers({
      ui: UI_MODULE,
      callAIAgent: API_MODULE.callAIAgent,
      computeFiltered: computeFilteredLaptops
    });

    API_MODULE.callAIAgent('getFutureIntel', {}, null, {
      onIntelSuccess: UI_MODULE.updateIntelUI,
      onIntelFallback: UI_MODULE.updateIntelUIWithRawText
    });

    // Register Service Worker only on Netlify + HTTPS (c6: PWA gated)
    if ('serviceWorker' in navigator) {
      const isNetlify = await detectNetlify();
      const isHTTPS = location.protocol === 'https:';
      
      if (isNetlify && isHTTPS) {
        try {
          const reg = await navigator.serviceWorker.register('/service-worker.js');
          console.log('âœ… Service Worker registered:', reg.scope);
          document.documentElement.dataset.netlify = '1';
          
          // Auto-enable Enhanced UI on mobile when on Netlify
          if (window.innerWidth <= 640 && uiEnhanced === '0') {
            document.documentElement.dataset.enhancedUi = '1';
            StorageUtil.safeSet('ui_enhanced', '1');
            btnLarge?.classList.add('active');
            btnNormal?.classList.remove('active');
          }
        } catch (error) {
          console.warn('SW registration failed:', error);
        }
      } else {
        console.log('SW skipped (localhost or non-Netlify)');
      }
    }
  }
};
  
document.addEventListener('DOMContentLoaded', () => APP.initialize());
})();
</script>
</body>
</html>






